<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>The Interactive Nostalgia</title>
  <link href="https://cdn.jsdelivr.net/npm/galmuri@latest/dist/galmuri.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.ckeditor.com/4.22.1/standard/ckeditor.js"></script>

  <style>
    /* === ğŸ©¸ ê¸°ë³¸ ì„¤ì • === */
    body { background-color: #000; color: #ccc; font-family: 'Galmuri9', 'ê¶ì„œ', serif; margin: 0; padding: 0; overflow: hidden; cursor: crosshair; user-select: none; }
    #world-container { position: absolute; top: 0; left: 80px; width: calc(100vw - 80px); height: 100vh; overflow: hidden; }
    .world-view { display: none; width: 100%; height: 100%; position: relative; }
    .world-view.active { display: block; }

    /* === ğŸ’» ì¢Œì¸¡ ë©”ë‰´ë°” === */
    #left-taskbar { position: fixed; top: 0; left: 0; width: 80px; height: 100vh; background: #111; border-right: 2px solid #333; display: flex; flex-direction: column; align-items: center; padding-top: 30px; z-index: 9999; }
    .task-icon { width: 60px; margin-bottom: 25px; text-align: center; cursor: pointer; font-size: 10px; color: #888; transition: 0.2s; }
    .task-icon div { font-size: 24px; margin-bottom: 5px; filter: grayscale(1); transition: 0.2s;}
    .task-icon:hover { color: #fff; } .task-icon:hover div { filter: grayscale(0); transform: scale(1.1); }

    /* =========================================
       [ì°¨ì› 1] ì£¼ì¸ì˜ ì„¤ê³„ë„: í¬ì¸íŠ¸ ì•¤ í´ë¦­ ë£¸
       ========================================= */
    #view-room { 
        /* ë…¸ì„ + ê½ƒë¬´ëŠ¬ ë²½ì§€ì™€ ë…¸ë€ì¥íŒ ë°”ë‹¥ ì™„ë²½ êµ¬í˜„ */
        background: linear-gradient(to bottom, rgba(139, 0, 0, 0.8) 0%, rgba(210, 105, 30, 0.8) 50%, #dcb35a 50%, #b28936 100%),
                    url('https://www.transparenttextures.com/patterns/floral-pattern.png');
        background-size: auto;
        position: relative; transition: filter 0.3s ease;
    }
    /* ì „ë“± êº¼ì§ ìƒíƒœ (ì˜¤ë²„ë ˆì´) */
    #room-darkness { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); pointer-events: none; z-index: 900; transition: 0.3s; opacity: 0; }
    .is-dark #room-darkness { opacity: 1; }

    /* ğŸ’¡ ê¸°ë¯¹ 1: ì „ë“± */
    #scene-light { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); width: 150px; height: 60px; background: rgba(255,255,255,0.8); border-radius: 50%; box-shadow: 0 0 50px #fff; cursor: pointer; z-index: 1000; border: 4px solid #555; display: flex; justify-content: center; align-items: flex-end; padding-bottom: 5px; color: #000; font-size: 12px; font-weight: bold;}
    #scene-light:active { background: #fff; }

    /* ğŸ¦â€â¬› ê¸°ë¯¹ 2: ì „ë´‡ëŒ€ì™€ ê¹Œë§ˆê·€ */
    #scene-pole { position: absolute; top: 20%; left: 10%; width: 20px; height: 300px; background: #222; border-left: 5px solid #111; z-index: 10;}
    #scene-wire { position: absolute; top: 25%; left: -5%; width: 60%; height: 2px; background: #000; z-index: 9; transform: rotate(2deg);}
    .crow { position: absolute; top: -20px; font-size: 24px; cursor: pointer; transition: 1s cubic-bezier(0.25, 1, 0.5, 1); z-index: 15;}
    #crow1 { left: 20%; } #crow2 { left: 30%; } #crow3 { left: 40%; }
    .crow.fly { transform: translate(500px, -500px) scale(2); opacity: 0; pointer-events: none; }

    /* ğŸ‘¤ ê¸°ë¯¹ 3: ìºë¦­í„° ê·¸ë¦¼ì (ëˆ„ë¥´ë©´ ì±„íŒ…) */
    #scene-character { position: absolute; bottom: 30%; left: 45%; width: 100px; height: 250px; background: #222; border-radius: 50px 50px 10px 10px; cursor: pointer; z-index: 50; filter: drop-shadow(10px 10px 0px rgba(0,0,0,0.5)); transition: 0.1s; display: flex; justify-content: center; align-items: center; color: #fff;}
    #scene-character:hover { transform: scale(1.05); background: #111; }
    #scene-character:active { transform: scale(0.95); }

    /* ğŸªŸ ê¸°ë¯¹ 4: ë¬¼ì´ ìŸì•„ì§€ëŠ” ì°½ë¬¸ (ëˆ„ë¥´ë©´ ì´ë™) */
    #scene-window { position: absolute; top: 20%; right: 15%; width: 250px; height: 300px; border: 15px solid #5d4037; background: rgba(255, 200, 200, 0.4); cursor: pointer; z-index: 20; box-shadow: inset 0 0 20px rgba(0,0,0,0.5), 10px 10px 0px rgba(0,0,0,0.3); overflow: visible; display: flex; justify-content: center; align-items: center; font-size: 20px; color: #fff; text-shadow: 2px 2px #000;}
    #scene-window:hover { filter: brightness(1.2); }
    /* ì°½ë¬¸ ì•ˆì˜ í™”ë¡œ */
    #window-pot { position: absolute; bottom: 10px; left: 20px; width: 80px; height: 60px; background: #3e2723; border-radius: 10px; border: 3px solid #000; }
    /* ìŸì•„ì§€ëŠ” ë¬¼ */
    #waterfall { position: absolute; bottom: -200px; right: 20px; width: 150px; height: 200px; background: rgba(100, 150, 255, 0.6); animation: flow 1s infinite linear; pointer-events: none;}
    @keyframes flow { 0% { background-position: 0 0; } 100% { background-position: 0 100px; } }
    /* ë°”ë‹¥ì˜ ë¬¼ì›…ë©ì´ */
    #water-puddle { position: absolute; bottom: -220px; right: -50px; width: 300px; height: 50px; background: rgba(100, 150, 255, 0.6); border-radius: 50%; transform: scaleY(0.5); pointer-events: none;}

    /* ğŸª´ ê¸°ë¯¹ 5: ê¹¨ì§€ëŠ” í™”ë¶„ë“¤ */
    .scene-pot { position: absolute; cursor: pointer; z-index: 30; transition: 0.2s; display: flex; flex-direction: column; align-items: center; text-shadow: 2px 2px 0px rgba(0,0,0,0.5);}
    .scene-pot .plant { font-size: 60px; margin-bottom: -15px; z-index: 31; }
    .scene-pot .base { width: 80px; height: 80px; background: #f5f5dc; border-radius: 10px 10px 40px 40px; border: 3px solid #ccc; z-index: 32; box-shadow: inset -10px -10px 0px rgba(0,0,0,0.1);}
    #pot1 { bottom: 40%; left: 25%; }
    #pot2 { bottom: 30%; right: 40%; }
    .scene-pot.broken .plant { display: none; }
    .scene-pot.broken .base { background: transparent; border: none; box-shadow: none; font-size: 50px; }

    /* ğŸ›ï¸ ê±°ëŒ€ ì´ë¶ˆ (ê²Œì‹œíŒ/ì¼ê¸°ì¥ ì—­í• ) */
    #scene-bed { position: absolute; bottom: 5%; left: 5%; width: 40%; height: 25%; background: #f48fb1; border-radius: 20px; border: 5px solid #d81b60; z-index: 40; box-shadow: 15px 15px 0px rgba(0,0,0,0.2); cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 24px; color: #fff; font-weight: bold; text-shadow: 2px 2px 0px #000; transform: perspective(500px) rotateX(20deg); transition: 0.2s;}
    #scene-bed:hover { transform: perspective(500px) rotateX(20deg) translateY(-10px); background: #ff4081; }
    #scene-pillow { position: absolute; top: 10%; left: -5%; width: 120px; height: 60px; background: #fff; border-radius: 30px; border: 3px solid #ccc; box-shadow: 5px 5px 0px rgba(0,0,0,0.1); }

    /* =========================================
       [ì°¨ì› 2] ê¸°ì°¨ì—­ 
       ========================================= */
    #view-station { background: linear-gradient(to bottom, #1a2a6c, #b21f1f, #fdbb2d); overflow: hidden; }
    .railroad { position:absolute; bottom:0; width:100%; height:150px; background:repeating-linear-gradient(90deg, #111 0, #111 20px, transparent 20px, transparent 60px), #3e2723; border-top:8px solid #2c3e50; transform:perspective(500px) rotateX(45deg); }
    .btn-post { position: absolute; bottom: 12%; right: 12%; font-size: 60px; cursor: pointer; transition: 0.2s; z-index: 100; text-shadow: 5px 5px 0px #000;}
    .btn-post:hover { transform: scale(1.1); }

    /* =========================================
       [ì°¨ì› 3] ì•„ì¿ ì•„ë¦¬ì›€ 
       ========================================= */
    #view-aqua { background: linear-gradient(to bottom, #001f3f, #0074d9); overflow: hidden; }
    .aqua-obj { position: absolute; z-index: 5; animation: floatSwim linear infinite; font-size: 80px; filter: drop-shadow(5px 5px 10px rgba(0,0,0,0.6)); pointer-events: none;}
    @keyframes floatSwim { 0% { transform: translateX(0) rotate(5deg); } 100% { transform: translateX(120vw) rotate(-5deg); } }

    /* =========================================
       íŒì—…ì°½ ê³µí†µ ë””ìì¸ 
       ========================================= */
    .cute-popup { position: absolute; display: none; background: rgba(15,15,15,0.95); border: 4px solid #fff; box-shadow: 15px 15px 0px rgba(0,0,0,0.7); overflow: hidden; width: 450px; color: #ddd; z-index: 2000; }
    .cute-titlebar { background: #fff; color: #000; padding: 10px; font-size: 14px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; cursor: grab; }
    .cute-body { padding: 15px; max-height: 60vh; overflow-y: auto; background: #222;}
    .close-x { cursor: pointer; color: #fff; background: #c0392b; padding: 2px 8px; border: 2px solid #000; font-weight: bold;}
    .close-x:hover { background: #ff0000; }
    
    .btn-action { background: #333; color: #fff; border: 3px solid #000; padding: 8px 15px; font-family: 'Galmuri9'; cursor: pointer; transition: 0.1s; box-shadow: 2px 2px 0 #000;}
    .btn-action:hover { background: #f1c40f; color: #000;}
    .btn-action:active { transform: translate(2px, 2px); box-shadow: none;}
    .cute-input { width: 100%; padding: 8px; margin-bottom: 10px; background: #000; border: 2px solid #555; color: #fff; font-family: 'Galmuri9'; box-sizing: border-box; outline: none;}

    /* ë©”ì‹ ì € ì±„íŒ…ì°½ */
    #chat-log { height: 250px; overflow-y: auto; background: #000; border: 3px solid #555; padding: 10px; font-size: 13px; line-height: 1.5; }
    .msg-row { margin-bottom: 10px; padding: 8px; border-radius: 5px; width: fit-content; max-width: 80%; }
    .msg-me { background: #2980b9; color: #fff; float: right; clear: both; border: 2px solid #1a5276;}
    .msg-ai { background: #c0392b; color: #fff; float: left; clear: both; border: 2px solid #7b241c;}

    /* ê²Œì‹œíŒ */
    .post-item { margin-bottom: 10px; border: 3px solid #000; background: #333; color: #ccc;}
    .post-header { padding: 10px 12px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border-bottom: 3px solid #000;}
    .post-header:hover { background: #444; color: #fff; }
    .post-content-area { padding: 15px; display: none; background: #222; font-size: 12px; line-height: 1.6; border-top: 3px solid #000;}

    /* ê¸°íƒ€ ìœ í‹¸ */
    #item-drop-zone { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; overflow: hidden;}
    .dropped-item { position: absolute; font-size: 40px; filter: drop-shadow(3px 3px 0px #000); animation: itemFall 0.5s forwards; }
    @keyframes itemFall { 0% { transform: translateY(-100px) rotate(-360deg); opacity:0; } 100% { transform: translateY(0) rotate(0deg); opacity:1; } }

  </style>
</head>
<body id="main-body">

  <div id="world-container">
      
      <div id="view-room" class="world-view active">
          <div id="room-darkness"></div> <div id="item-drop-zone"></div>

          <div id="scene-light" onclick="toggleLight()">ë”¸ê¹! (ì „ë“±)</div>

          <div id="scene-pole"></div>
          <div id="scene-wire">
              <div class="crow" id="crow1" onclick="flyCrow(this)">ğŸ¦â€â¬›</div>
              <div class="crow" id="crow2" onclick="flyCrow(this)">ğŸ¦â€â¬›</div>
              <div class="crow" id="crow3" onclick="flyCrow(this)">ğŸ¦â€â¬›</div>
          </div>

          <div id="scene-window" onclick="switchWorld('view-station')">
              <div id="window-pot">â™¨ï¸</div>
              <div id="waterfall"></div>
              <div id="water-puddle"></div>
              <span style="z-index: 25;">ë‹¤ë¥¸ ì°½ìœ¼ë¡œ ì´ë™</span>
          </div>

          <div class="scene-pot" id="pot1" onclick="breakPot(this)">
              <div class="plant">ğŸŒ¿</div><div class="base"></div>
          </div>
          <div class="scene-pot" id="pot2" onclick="breakPot(this)">
              <div class="plant">ğŸŒµ</div><div class="base"></div>
          </div>

          <div id="scene-character" onclick="openPopup('ai-window')">
              ë§ê±¸ê¸°
          </div>

          <div id="scene-bed" onclick="openBoard('diary')">
              <div id="scene-pillow"></div>
              ì¹¨ëŒ€ (ë¹„ë°€ ì¼ê¸°ì¥)
          </div>

          <button class="btn-action" style="position:absolute; bottom:20px; right:20px; z-index: 100;" onclick="openPopup('profile-window')">âš™ï¸ ì„¤ì •</button>
          <button class="btn-action" style="position:absolute; bottom:20px; right:120px; z-index: 100;" onclick="openPopup('shop-window')">ğŸ›’ ì•”ì‹œì¥</button>
      </div>

      <div id="view-station" class="world-view">
          <div class="station-fog"></div>
          <div style="position:absolute; top:20%; width:100%; text-align:center; color:#fff; font-size:32px; font-weight:bold; text-shadow: 4px 4px 0px #000;">ì¶˜ì²œê°€ëŠ” ê¸°ì°¨ëŠ”...</div>
          
          <div class="chimney" style="left: 10%;">
              <div class="smoke" style="animation-delay:0s;"></div>
              <div class="smoke" style="animation-delay:2s;"></div>
          </div>
          
          <div class="railroad"></div>

          <div class="btn-post" onclick="openBoard('guestbook')" style="position:absolute; bottom: 15%; right: 15%; z-index: 100;">
              ğŸ“®<br><span style="font-size:16px; color:#ffeb3b; font-family:'Galmuri9'; font-weight:bold; background:rgba(0,0,0,0.5); padding:5px;">ì¶”ì–µì˜ ìš°ì²´í†µ</span>
          </div>
      </div>

      <div id="view-aqua" class="world-view">
          <div class="aqua-obj" style="top:20%; left:-15%; animation-duration:20s;">ğŸ¦ˆ</div>
          <div class="aqua-obj" style="top:55%; right:-15%; transform:scaleX(-1); animation-direction:reverse; animation-duration:30s;">ğŸ‹</div>
          
          <button class="btn-action" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%) scale(2); z-index:100; background:#001f3f; color:#00bcd4; border-color:#00bcd4;" onclick="openPopup('dolphin-window')">
              ğŸ•¹ï¸ ì‹¬í•´ ì˜¤ë½ê¸°
          </button>
      </div>

  </div> <div id="left-taskbar">
      <div class="task-icon" onclick="switchWorld('view-room')"><div>ğŸ </div>Room</div>
      <div class="task-icon" onclick="switchWorld('view-station')"><div>ğŸš‚</div>Station</div>
      <div class="task-icon" onclick="switchWorld('view-aqua')"><div>ğŸŒŠ</div>Aqua</div>
      <hr style="width:50%; border-color:#333; margin:15px 0;">
      <div class="task-icon" onclick="openPopup('music-window')"><div>ğŸ“»</div>Music</div>
  </div>

  <div id="music-window" class="cute-popup">
      <div class="cute-titlebar"><span>ğŸ“» CASSETTE</span><span class="close-x" onclick="closePopup('music-window')">X</span></div>
      <div class="cute-body" style="text-align:center;">
          <button class="btn-action" onclick="prevTrack()">â®</button>
          <button class="btn-action" onclick="togglePlay()">â–¶/â¸</button>
          <button class="btn-action" onclick="nextTrack()">â­</button>
          <marquee id="now-playing-text" style="margin-top:10px; color:#2ecc71; border:3px solid #000; padding:5px; background:#000;">Tape Waiting...</marquee>
      </div>
  </div>

  <div id="board-window" class="cute-popup" style="width: 600px;">
      <div class="cute-titlebar">
          <span id="board-title">ğŸ€ Board</span>
          <div>
              <button class="btn-action" style="padding: 2px 10px; margin-right:10px;" onclick="openWrite()">âœï¸ ì“°ê¸°</button>
              <span class="close-x" onclick="closePopup('board-window')">X</span>
          </div>
      </div>
      <div class="cute-body" id="page-content">ë¡œë”© ì¤‘...</div>
  </div>

  <div id="write-window" class="cute-popup">
      <div class="cute-titlebar"><span>ğŸ“ WRITE</span><span class="close-x" onclick="closePopup('write-window')">X</span></div>
      <div class="cute-body">
          <select id="post-category" class="cute-input">
              <option value="diary">ë¹„ë°€ ì¼ê¸°</option>
              <option value="character">ìºë¦­í„° ë±</option>
              <option value="review">ëª©ê²©ë‹´</option>
              <option value="guestbook">ë°©ëª…ë¡</option>
          </select>
          <input type="text" id="post-title" class="cute-input" placeholder="ì œëª©...">
          <textarea id="post-content"></textarea>
          <div style="text-align:right; margin-top:15px;"><button class="btn-action" onclick="savePost()">ì €ì¥</button></div>
      </div>
  </div>

  <div id="ai-window" class="cute-popup">
      <div class="cute-titlebar"><span>ğŸ’¬ MESSENGER</span><span class="close-x" onclick="closePopup('ai-window')">X</span></div>
      <div class="cute-body">
          <div id="chat-log">
              <div class="msg-row msg-ai">ë‚˜ë£¨: ë¶ˆ ì¢€ ì¼œì¤˜... í™”ë¶„ ê¹¨ì§€ ë§ˆ...</div>
          </div>
          <div style="display:flex; gap:5px; margin-top:10px;">
              <input type="text" id="ai-input" class="cute-input" style="margin:0;" onkeypress="if(event.key==='Enter')sendMsg()">
              <button class="btn-action" onclick="sendMsg()">ì „ì†¡</button>
          </div>
      </div>
  </div>

  <div id="shop-window" class="cute-popup">
      <div class="cute-titlebar"><span>ğŸ›’ BLACK MARKET</span><span class="close-x" onclick="closePopup('shop-window')">X</span></div>
      <div class="cute-body" style="text-align:center;">
          <h3 id="my-money" style="color:#f1c40f;">0 P</h3>
          <div style="display:flex; gap:10px; justify-content:center;">
              <button class="btn-action" onclick="buyItem('ì†Œì£¼', 'ğŸ¾', 100)">ì†Œì£¼(100P)</button>
              <button class="btn-action" onclick="buyItem('ë‹´ë°°', 'ğŸš¬', 200)">ë‹´ë°°(200P)</button>
              <button class="btn-action" onclick="buyItem('ì¹¼', 'ğŸ”ª', 300)">ì¹¼(300P)</button>
          </div>
          <div style="text-align:right; margin-top:15px;"><button class="btn-action" style="background:#c0392b;" onclick="clearRoomItems()">ë°© ì²­ì†Œ</button></div>
      </div>
  </div>

  <div id="dolphin-window" class="cute-popup">
      <div class="cute-titlebar"><span>ğŸ¬ ARCADE</span><span class="close-x" onclick="closePopup('dolphin-window')">X</span></div>
      <div class="cute-body">
          <div id="dolphin-game-area">
              <div id="dolphin-overlay">
                  <div id="dolphin-msg" style="font-weight:bold; font-size:18px;">INSERT COIN</div>
                  <button id="dolphin-start-btn" class="btn-action" style="margin-top:15px; background:#00bcd4; color:#000;" onclick="startDolphinGame()">START</button>
              </div>
              <div class="post" style="left:60px;"></div><div class="post" style="right:60px;"></div>
              <div class="ring" id="ring0" style="border-color:#ff0000;"></div><div class="ring" id="ring1" style="border-color:#00ff00;"></div><div class="ring" id="ring2" style="border-color:#0000ff;"></div><div class="ring" id="ring3" style="border-color:#ffff00;"></div><div class="ring" id="ring4" style="border-color:#ff00ff;"></div>
          </div>
          <div style="display:flex; justify-content:space-between; margin-top:10px;">
              <button class="btn-action" onclick="pushRings('left')">â—€ L</button>
              <button class="btn-action" onclick="pushRings('right')">R â–¶</button>
          </div>
          <div id="d-score" style="text-align:center; font-weight:bold; margin-top:10px; color:#f1c40f;">ğŸ† 0ê°œ</div>
      </div>
  </div>

  <div id="profile-window" class="cute-popup">
      <div class="cute-titlebar"><span>âš™ï¸ SETUP</span><span class="close-x" onclick="closePopup('profile-window')">X</span></div>
      <div class="cute-body">
          <p style="font-size:11px; color:#ccc;">â€» BGM ìœ íŠœë¸Œ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
          <div style="margin-bottom:10px;">ğŸµ BGM ID: <input type="text" id="edit-bgm" class="cute-input" placeholder="VDMiHYgQKLE"></div>
          <div style="text-align:right;"><button class="btn-action" onclick="saveProfile()">ì ìš©</button></div>
      </div>
  </div>

  <div id="yt-player-container" style="display:none;"></div>

  <script>
    let highestZ = 3000;
    const SB_URL = "https://kzgbqpodvpuoqovfsyrm.supabase.co";
    const SB_KEY = "sb_publishable_pdqE1Sc-4PSv3LQM9IsBcA_xJWeZwW-";
    const OPENROUTER_KEY = "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";
    let sbClient = null; 
    if (window.supabase) sbClient = window.supabase.createClient(SB_URL, SB_KEY);
    CKEDITOR.replace('post-content', { height: 200, language: 'ko', removeButtons: 'About', versionCheck: false });

    // ğŸ”Š ì‚¬ìš´ë“œ ì‹œìŠ¤í…œ
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playClickSound() { if(audioCtx.state === 'suspended') audioCtx.resume(); const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = 'square'; osc.frequency.setValueAtTime(600, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.1); gain.gain.setValueAtTime(0.05, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.1); }
    function playPopupSound() { if(audioCtx.state === 'suspended') audioCtx.resume(); const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = 'sine'; osc.frequency.setValueAtTime(300, audioCtx.currentTime); osc.frequency.linearRampToValueAtTime(600, audioCtx.currentTime + 0.1); gain.gain.setValueAtTime(0.001, audioCtx.currentTime); gain.gain.linearRampToValueAtTime(0.1, audioCtx.currentTime + 0.05); gain.gain.linearRampToValueAtTime(0.001, audioCtx.currentTime + 0.1); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.1); }
    document.addEventListener('click', (e) => { if(e.target.closest('button') || e.target.closest('.task-icon') || e.target.closest('.light-switch') || e.target.closest('.scene-pot')) playClickSound(); });

    // ğŸ–±ï¸ ìƒí˜¸ì‘ìš© ê¸°ë¯¹ë“¤
    function switchWorld(vid) { document.querySelectorAll('.world-view').forEach(e => e.classList.remove('active')); document.getElementById(vid).classList.add('active'); playPopupSound(); }
    function toggleLight() { document.getElementById('view-room').classList.toggle('is-dark'); }
    function flyCrow(el) { el.classList.add('fly'); setTimeout(() => el.classList.remove('fly'), 5000); }
    function breakPot(el) { 
        if(!el.classList.contains('broken')) {
            el.classList.add('broken');
            el.querySelector('.base').innerText = 'ğŸ’¥';
            setTimeout(() => { el.classList.remove('broken'); el.querySelector('.base').innerText = '';}, 3000);
        }
    }

    // ğŸªŸ íŒì—… ì œì–´
    function openPopup(id) { playPopupSound(); const el = document.getElementById(id); el.style.display = 'block'; el.style.zIndex = ++highestZ; }
    function closePopup(id) { document.getElementById(id).style.display = 'none'; }
    function makeDraggable(winId) { 
        const win = document.getElementById(winId); const dragArea = win.querySelector('.cute-titlebar'); if(!dragArea) return;
        let p1=0, p2=0, p3=0, p4=0; win.onmousedown = () => win.style.zIndex = ++highestZ; 
        dragArea.onmousedown = (e) => { e.preventDefault(); p3=e.clientX; p4=e.clientY; document.onmouseup = () => { document.onmouseup=null; document.onmousemove=null; }; document.onmousemove = (e) => { e.preventDefault(); p1=p3-e.clientX; p2=p4-e.clientY; p3=e.clientX; p4=e.clientY; win.style.top=(win.offsetTop-p2)+"px"; win.style.left=(win.offsetLeft-p1)+"px"; }; }; 
    }
    ['write-window','board-window','ai-window','profile-window','shop-window','music-window','dolphin-window'].forEach(makeDraggable);

    // ğŸ“ ê²Œì‹œíŒ ê¸°ëŠ¥
    async function openBoard(type) { 
        let title = 'ğŸ€ Board';
        if(type==='diary') title = 'ğŸ““ ë¹„ë°€ ì¼ê¸°'; else if(type==='character') title = 'âœ¨ ìºë¦­í„° ë±'; else if(type==='review') title = 'ğŸ¬ ëª©ê²©ë‹´'; else if(type==='guestbook') title = 'ğŸ“® ë°©ëª…ë¡';
        document.getElementById('board-title').innerText = title; 
        document.getElementById('post-category').value = type; // ê¸€ì“°ê¸° ê¸°ë³¸ ì¹´í…Œê³ ë¦¬ ì„¤ì •
        document.getElementById('page-content').innerHTML = 'ë¡œë”© ì¤‘...'; openPopup('board-window'); 
        if (!sbClient) { document.getElementById('page-content').innerHTML = 'DB ì—ëŸ¬...'; return; }
        const {data, error} = await sbClient.from('posts').select('*').eq('category', type).order('created_at',{ascending:false});
        if(error || !data || data.length === 0) { document.getElementById('page-content').innerHTML = 'í…… ë¹„ì–´ìˆë‹¤...'; return; }
        let htmlStr = ''; 
        data.forEach(p => { 
            const dateStr = new Date(p.created_at).toLocaleDateString();
            htmlStr += `<div class="post-item"><div class="post-header" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='block'?'none':'block'"><span>ğŸ“‘ ${p.title} <small style="color:#888;">${dateStr}</small></span></div><div class="post-content-area">${p.content}</div></div>`; 
        });
        document.getElementById('page-content').innerHTML = htmlStr;
    }
    function openWrite() { document.getElementById('post-title').value = ''; CKEDITOR.instances['post-content'].setData(''); openPopup('write-window'); }
    async function savePost() { 
        if(!sbClient) return;
        const category = document.getElementById('post-category').value; const title = document.getElementById('post-title').value; const content = CKEDITOR.instances['post-content'].getData();
        if(!title.trim()) return alert("ì œëª©ì„ ì ì–´ë¼...");
        await sbClient.from('posts').insert([{title: title, content: content, category: category}]); 
        earnPoints(100); closePopup('write-window'); openBoard(category); 
    }

    // ğŸ’¬ ë©”ì‹ ì € (ì˜¤ë¥˜ ì›ì²œ ì°¨ë‹¨ëœ ë¹„ìƒ í†µì‹ ë§)
    async function sendMsg() { 
        const i = document.getElementById('ai-input'), l = document.getElementById('chat-log'), t = i.value.trim(); 
        if(!t) return; 
        l.innerHTML += `<div class="msg-row msg-me">${t}</div>`; i.value = ''; l.scrollTop = l.scrollHeight; 
        
        // ë¡œë”© ë©”ì‹œì§€
        const loadId = 'load-' + Date.now();
        l.innerHTML += `<div id="${loadId}" class="msg-row msg-ai">ë‚˜ë£¨: ...</div>`; l.scrollTop = l.scrollHeight;
        
        try {
            const res = await fetch("https://openrouter.ai/api/v1/chat/completions", { 
                method:"POST", headers:{"Authorization":`Bearer ${OPENROUTER_KEY}`,"Content-Type":"application/json"}, 
                body:JSON.stringify({ "model":"mistralai/mistral-7b-instruct:free", "messages":[{"role":"system","content":"í”¼íí•œ ë…¸ë€ì¥íŒ ë£¸ì˜ í‘ë§‰ì´ë‹¤. ì§§ê³  ê¸°ê´´í•˜ê²Œ ë°˜ë§ë¡œ ëŒ€ë‹µí•´ë¼."},{"role":"user","content":t}] }) 
            }); 
            const d = await res.json(); 
            document.getElementById(loadId).remove();
            if(d.choices && d.choices.length > 0) {
                l.innerHTML += `<div class="msg-row msg-ai">ë‚˜ë£¨: ${d.choices[0].message.content}</div>`; 
            } else {
                throw new Error("Empty response");
            }
        } catch(e) { 
            // ğŸ”´ ì„œë²„ê°€ ì£½ì—ˆì„ ë•Œ ì ˆëŒ€ í„°ì§€ì§€ ì•ŠëŠ” 'ë¹„ìƒ ëŒ€ì‚¬' ì¶œë ¥
            document.getElementById(loadId).remove();
            const fallbacks = ["í”¼ê³¤í•´...", "ì°½ë¬¸ ë°–ì„ ë´...", "ê¹Œë§ˆê·€ê°€ ìš¸ì–´...", "ì¥íŒì´ ì°¨ê°€ì›Œ...", "í™”ë¶„ì´ë‚˜ ê¹¨..."];
            const reply = fallbacks[Math.floor(Math.random() * fallbacks.length)];
            l.innerHTML += `<div class="msg-row msg-ai">ë‚˜ë£¨: ${reply}</div>`; 
        }
        l.scrollTop = l.scrollHeight; 
    }

    // ğŸ›’ ì•”ì‹œì¥ ë° í¬ì¸íŠ¸
    let cash = parseInt(localStorage.getItem('pts')||'1000'); let roomItems = JSON.parse(localStorage.getItem('roomItems')||'[]');
    function uCash() { document.getElementById('my-money').innerText = cash+' P'; localStorage.setItem('pts', cash); }
    function earnPoints(a) { cash+=a; uCash(); } uCash();
    function buyItem(n, icon, p) { if(cash<p) return alert("ìê¸ˆ ë¶€ì¡±..."); cash-=p; uCash(); const x = Math.floor(Math.random()*80)+10; const y = Math.floor(Math.random()*30)+50; roomItems.push({ icon: icon, x: x, y: y }); localStorage.setItem('roomItems', JSON.stringify(roomItems)); renderRoomItems(); }
    function renderRoomItems() { const layer = document.getElementById('item-drop-zone'); layer.innerHTML=''; roomItems.forEach(item => { const el = document.createElement('div'); el.className='dropped-item'; el.style.left=item.x+'%'; el.style.top=item.y+'%'; el.innerText=item.icon; layer.appendChild(el); }); }
    function clearRoomItems() { roomItems=[]; localStorage.setItem('roomItems','[]'); renderRoomItems(); } renderRoomItems();

    // ğŸ¬ ëŒê³ ë˜ ì•„ì¼€ì´ë“œ
    const rings = [document.getElementById('ring0'),document.getElementById('ring1'),document.getElementById('ring2'),document.getElementById('ring3'),document.getElementById('ring4')];
    let rState = [], dTime=30, dScore=0, dState='ready', dTimer=null, gameLoop=null;
    function resetRings() { rState = rings.map((r,i) => ({ x: 40+(i*50), y: 300, vy:0, vx:0, stuck:false, scored:false })); rings.forEach((r,i) => { r.style.top='300px'; r.style.left=rState[i].x+'px'; }); }
    function startDolphinGame() { dState='playing'; dTime=30; dScore=0; document.getElementById('d-score').innerText='ğŸ† 0ê°œ'; document.getElementById('dolphin-overlay').style.display='none'; resetRings(); if(dTimer) clearInterval(dTimer); dTimer=setInterval(()=>{ dTime--; if(dTime<=0) endGame(false); }, 1000); if(!gameLoop) loop(); }
    function loop() { if(dState!=='playing') return; rState.forEach((s,i) => { if(s.stuck) return; s.vy+=0.35; s.y+=s.vy; s.x+=s.vx; s.vx*=0.96; if(s.y>300){ s.y=300; s.vy*=-0.5; } if(s.x<10||s.x>270) s.vx*=-0.8; if(s.y>170 && s.y<240 && s.vy>0){ if(Math.abs(s.x-60)<15 || Math.abs(s.x-240)<15){ s.stuck=true; s.y=250-(dScore*10); s.x=Math.abs(s.x-60)<15?60:240; if(!s.scored){ s.scored=true; dScore++; document.getElementById('d-score').innerText=`ğŸ† ${dScore}ê°œ`; } } } rings[i].style.top=s.y+'px'; rings[i].style.left=s.x+'px'; }); if(dScore>=5) { endGame(true); return; } gameLoop=requestAnimationFrame(loop); }
    function pushRings(dir) { if(dState==='playing') { rState.forEach(s => { if(!s.stuck){ s.vy = -Math.random()*8-3; s.vx += (dir==='left'?1:-1)*(Math.random()*4+2); } }); } }
    function endGame(win) { dState='over'; clearInterval(dTimer); cancelAnimationFrame(gameLoop); gameLoop=null; document.getElementById('dolphin-overlay').style.display='flex'; document.getElementById('dolphin-msg').innerText = win ? 'âœ¨ SUCCESS âœ¨\n+100P' : 'FAILED\nGAME OVER'; document.getElementById('dolphin-start-btn').innerText = 'â–¶ RETRY'; if(win) earnPoints(100); }

    // ğŸµ ì„¤ì • ë° BGM
    let currentPlaylist=[];
    function loadProfile() { const s = JSON.parse(localStorage.getItem('interactiveRoomV1')) || {}; currentPlaylist = (s.bgm||'VDMiHYgQKLE').split(',').map(x=>x.trim()).filter(x=>x); document.getElementById('edit-bgm').value = s.bgm || ''; }
    function saveProfile() { localStorage.setItem('interactiveRoomV1', JSON.stringify({ bgm:document.getElementById('edit-bgm').value })); loadProfile(); closePopup('profile-window'); if(player && player.loadVideoById) loadMusicPlayer(); }
    
    let player = null; let trackIndex = 0; let isPlayerReady = false; let tag = document.createElement('script'); tag.src = "https://www.youtube.com/iframe_api"; document.head.appendChild(tag);
    window.onYouTubeIframeAPIReady = function() { if(currentPlaylist.length === 0) return; player = new YT.Player('yt-player-container', { height: '0', width: '0', videoId: currentPlaylist[trackIndex], events: { 'onReady': () => { isPlayerReady = true; document.getElementById('now-playing-text').innerText = "Tape Ready"; }, 'onStateChange': onPlayerStateChange, 'onError': nextTrack } }); }
    function loadMusicPlayer() { if(!isPlayerReady || currentPlaylist.length === 0) return; player.loadVideoById(currentPlaylist[trackIndex]); }
    function onPlayerStateChange(event) { if(event.data === YT.PlayerState.ENDED) nextTrack(); if(event.data === YT.PlayerState.PLAYING) { document.getElementById('now-playing-text').innerText = "â–¶ " + (player.getVideoData().title || "Playing..."); } }
    function togglePlay() { if(!isPlayerReady) return; if(player.getPlayerState() === YT.PlayerState.PLAYING) player.pauseVideo(); else player.playVideo(); } 
    function nextTrack() { if(!isPlayerReady) return; trackIndex = (trackIndex + 1) % currentPlaylist.length; player.loadVideoById(currentPlaylist[trackIndex]); } 
    function prevTrack() { if(!isPlayerReady) return; trackIndex = (trackIndex - 1 + currentPlaylist.length) % currentPlaylist.length; player.loadVideoById(currentPlaylist[trackIndex]); }

    loadProfile();
  </script>
</body>
</html>
