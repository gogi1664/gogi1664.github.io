<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>My Dark Interactive Room</title>
  <link href="https://cdn.jsdelivr.net/npm/galmuri@latest/dist/galmuri.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.ckeditor.com/4.22.1/standard/ckeditor.js"></script>

  <style>
    /* === ğŸ©¸ 1. ë…¸ë€ì¥íŒê³¼ ë‹¤í¬ì›¹ì˜ ìŒìŠµí•œ ë°°ê²½ ğŸ©¸ === */
    body { 
        background-color: #dcb35a;
        background-image: 
            linear-gradient(to bottom, rgba(20,0,0,0.9) 0%, rgba(50,0,0,0.8) 60%, #2e1a1a 60%, #3e2723 100%),
            url('https://www.transparenttextures.com/patterns/worn-dots.png'); /* ë‚¡ì€ ì§ˆê° ì¶”ê°€ */
        background-size: auto; background-attachment: fixed; color: #ccc;
        font-family: 'ê¶ì„œ', 'Galmuri9', serif; margin: 0; padding: 0; overflow-x: hidden; cursor: crosshair; /* ì»¤ì„œ ë³€ê²½ */
    }
    .messy-canvas { position: relative; width: 100vw; height: 100vh; overflow: hidden; }

    /* === ğŸ¬ íŒì—… ë“±ì¥ ì• ë‹ˆë©”ì´ì…˜ (ì–´ë‘  ì†ì—ì„œ íŠ€ì–´ë‚˜ì˜´) === */
    @keyframes popDark {
        0% { transform: scale(0.7) translateY(20px); opacity: 0; filter: blur(5px); }
        100% { transform: scale(1) translateY(0); opacity: 1; filter: blur(0); }
    }
    .pop-anim { animation: popDark 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }

    /* === ğŸ‘» ë°°ê²½ì— ë– ë‹¤ë‹ˆëŠ” ë¶€ìœ ë¬¼ (ìƒí˜¸ì‘ìš© ìš”ì†Œ ì¶”ê°€) === */
    .floating-obj { position: absolute; opacity: 0.4; pointer-events: none; z-index: 1; animation: floatAround linear infinite; }
    .float-1 { top: 20%; left: 10%; font-size: 30px; animation-duration: 25s; } /* ğŸ‘ï¸ */
    .float-2 { top: 70%; left: 80%; font-size: 40px; animation-duration: 35s; animation-delay: -5s; color: #8b0000;} /* ğŸ©¸ */
    .float-3 { top: 50%; left: 50%; font-size: 25px; animation-duration: 30s; animation-delay: -15s; filter: invert(1);} /* âœï¸ */
    @keyframes floatAround {
        0% { transform: translate(0, 0) rotate(0deg); }
        25% { transform: translate(50px, -30px) rotate(90deg); }
        50% { transform: translate(0, -60px) rotate(180deg); }
        75% { transform: translate(-50px, -30px) rotate(270deg); }
        100% { transform: translate(0, 0) rotate(360deg); }
    }

    /* === ğŸ©¸ ê´‘ê¸°ì˜ ìƒë‹¨ ë§ˆí€´ === */
    .top-marquee {
        position: fixed; top: 0; left: 0; width: 100%; background: #000; color: #ff0000;
        font-family: 'ê¶ì„œ', serif; font-size: 14px; padding: 3px 0; z-index: 100;
        border-bottom: 2px solid #8b0000; text-shadow: 2px 2px 4px #000; letter-spacing: 2px;
    }

    /* === ğŸ”® í—ˆê³µì˜ í…ìŠ¤íŠ¸ ë©”ë‰´ === */
    .fd-menu {
        position: absolute; top: 35px; left: 40%; width: 55%; display: flex; justify-content: space-around;
        font-family: 'Impact', 'ê¶ì„œ', sans-serif; font-size: 26px; z-index: 10; user-select: none; color: #555;
    }
    .fd-menu span { cursor: pointer; transition: 0.3s; text-shadow: 1px 1px 2px #000; }
    .fd-menu span:hover { transform: scale(1.2) skewX(-10deg); color: #ff0000; text-shadow: 3px 3px 0px #000; }
    .m-info { color: #8b0000; } .m-story { color: #ccc; } .m-cast { color: #fff; background: #000; padding: 0 5px; }

    /* === ğŸ–¼ï¸ ì¢Œì¸¡ ê±°ëŒ€ ì•¡ì ìº”ë²„ìŠ¤ === */
    .main-pic-container {
        position: absolute; top: 12%; left: 2%; width: 42%; height: 75%; 
        background: #000; border: 4px solid #333; outline: 4px dashed #8b0000; box-shadow: 15px 15px 30px rgba(0,0,0,0.9);
        transform: rotate(-1deg); z-index: 10; display: flex; flex-direction: column;
    }
    .main-pic-img { width: 100%; height: 100%; object-fit: cover; filter: contrast(1.3) sepia(0.2) grayscale(0.3); opacity: 0.9; }
    .pic-label { text-align: center; font-size: 16px; font-weight: bold; color: #ff0000; margin-top: 10px; font-family: 'ê¶ì„œ'; letter-spacing: 3px; background: #111; border-top: 2px solid #8b0000;}

    /* === ğŸ‘¥ ì¤‘ì–¼ê±°ë¦¬ëŠ” ë°©ê´€ì (ê¸€ë¦¬ì¹˜ íš¨ê³¼ ì¶”ê°€) === */
    #mutter-char { position: absolute; top: 20%; right: 5%; z-index: 8; display: flex; flex-direction: column; align-items: center; animation: glitchChar 4s infinite alternate-reverse;}
    @keyframes glitchChar { 0% { transform: translate(0); opacity: 0.9; } 98% { transform: translate(0); opacity: 0.9; } 99% { transform: translate(-5px, 2px); opacity: 0.7; filter: invert(0.2); } 100% { transform: translate(5px, -2px); opacity: 1; } }
    #mutter-bubble {
        background: #000; color: #ff0000; border: 1px solid #ff0000; padding: 10px; font-family: 'ê¶ì„œ';
        font-size: 12px; max-width: 150px; text-align: center; margin-bottom: 10px; border-radius: 0px;
        opacity: 0; transition: opacity 0.5s; box-shadow: 4px 4px 0px #8b0000;
    }
    #mutter-img { width: 120px; filter: grayscale(100%) contrast(2); opacity: 0.8; }

    /* === ğŸ€ ë‹¤ì±„ë¡œìš´ ëª¨ì–‘ì˜ ë‹¤í¬ ë²„íŠ¼ë“¤ (ë ˆí¼ëŸ°ìŠ¤ ë°˜ì˜) === */
    .scattered-btn {
        position: absolute; background: #000; border: 1px solid #555;
        padding: 10px 15px; font-weight: bold; color: #ccc; font-size: 13px; font-family: 'Galmuri9';
        cursor: pointer; box-shadow: 4px 4px 0px rgba(0,0,0,0.8); z-index: 20; transition: 0.1s; user-select: none; white-space: nowrap;
    }
    .scattered-btn:hover { background: #ff0000; color: #000; border-color: #ff0000; transform: scale(1.1) !important;}
    .scattered-btn:active { transform: translate(3px, 3px) !important; box-shadow: none; }
    
    /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ ë³€ì£¼ */
    .btn-tattered { border-style: dashed; background: #2e1a1a; color: #ffeb3b; transform: rotate(-5deg); } /* ì°¢ê²¨ì§„ ëŠë‚Œ */
    .btn-bloody { border-color: #8b0000; color: #ff0000; background: #111; text-shadow: 1px 1px #8b0000; transform: rotate(3deg); } /* í”¼ ë¬»ì€ ëŠë‚Œ */
    .btn-glitch { border: 2px dotted #00bcd4; color: #00bcd4; background: #000; font-family: 'Impact'; transform: rotate(-2deg); } /* ê¸°ê³„ ì˜¤ë¥˜ ëŠë‚Œ */
    
    .btn-home  { top: 15%; left: 48%; } .btn-diary { top: 30%; left: 75%; } .btn-char  { top: 45%; left: 55%; }
    .btn-review { top: 25%; left: 65%; } .btn-guest { top: 55%; left: 85%; }
    .btn-shop  { top: 65%; left: 60%; font-size: 15px;}
    .btn-write { top: 80%; left: 50%; font-size: 16px; padding: 12px 20px; }
    .btn-dolphin { top: 75%; left: 85%; font-size: 18px; }

    /* === ğŸš§ ê¸°ê´´í•œ ë°°ë„ˆ ì˜¤ë¸Œì œ === */
    .weird-banner { position: absolute; z-index: 5; opacity: 0.6; pointer-events: none; mix-blend-mode: overlay;}
    .wb-1 { top: 38%; left: 45%; width: 130px; transform: rotate(15deg); filter: invert(1) contrast(2); }
    .wb-2 { top: 70%; right: 30%; width: 180px; transform: rotate(-5deg); filter: sepia(1) hue-rotate(280deg); }

    /* === ğŸ“° ì¢Œì¸¡ í•˜ë‹¨ News (ìŠ¤í¬ë¡¤ ê¸°ëŠ¥ íƒ‘ì¬) === */
    .news-popup {
        position: absolute; bottom: 5%; left: 2%; width: 220px; background: #111; border: 2px solid #8b0000;
        box-shadow: 5px 5px 0px #000; z-index: 15; color: #ccc; max-height: 150px; display: flex; flex-direction: column;
    }
    .news-header { background: #8b0000; color: #000; font-weight: bold; padding: 5px; font-size: 16px; font-family: 'Impact'; letter-spacing: 1px; text-align: center;}
    .news-content { padding: 10px; font-size: 11px; line-height: 1.5; font-family: 'ë‹ì›€'; overflow-y: auto; flex: 1;} /* ìŠ¤í¬ë¡¤ë°” ì ìš© */
    .news-content p { margin: 0 0 8px 0; border-bottom: 1px dashed #333; padding-bottom: 5px; }
    .news-content::-webkit-scrollbar { width: 5px; background: #000; }
    .news-content::-webkit-scrollbar-thumb { background: #8b0000; }

    /* === ğŸ“œ ìš°ì¸¡ í•˜ë‹¨ ì‹œë†‰ì‹œìŠ¤ === */
    .bottom-synopsis {
        position: absolute; bottom: 2%; right: 2%; width: 50%; font-family: 'ê¶ì„œ', serif; font-size: 11px; color: #ccc; text-align: justify; line-height: 1.4;
        background: rgba(0,0,0,0.7); padding: 10px; border: 1px solid #555; z-index: 5; box-shadow: inset 0 0 20px #000;
    }

    /* === ğŸ’» ë‹¤í¬ì›¹ íŒì—…ì°½ === */
    .cute-popup {
        position: absolute; display: none; background: rgba(10,10,10,0.95); border: 2px solid #555;
        box-shadow: 10px 10px 30px rgba(0,0,0,0.9); overflow: hidden; width: 450px; color: #ccc;
    }
    .cute-titlebar {
        background: #1a1a1a; color: #ff0000; padding: 8px 12px; font-weight: bold; font-size: 12px; font-family: 'Galmuri9';
        display: flex; justify-content: space-between; align-items: center; user-select: none; cursor: grab; border-bottom: 1px solid #8b0000;
    }
    .cute-titlebar:active { cursor: grabbing; }
    .cute-title-btns span { display: inline-block; width: 12px; height: 12px; background: #333; cursor: pointer; border: 1px solid #ff0000; }
    .cute-title-btns span:hover { background: #ff0000; }
    .cute-body { padding: 15px; max-height: 65vh; overflow-y: auto; }
    .cute-body::-webkit-scrollbar { width: 8px; background: #000; }
    .cute-body::-webkit-scrollbar-thumb { background: #555; border: 1px solid #000; }

    #write-window { width: 800px; top: 15%; left: 25%; }
    #board-window { width: 650px; top: 20%; left: 35%; }
    #ai-window { width: 320px; top: 40%; left: 70%; }
    #shop-window { width: 350px; top: 30%; left: 60%; }
    #music-window { width: 300px; top: 8%; left: 75%; display: block; }
    #profile-window { width: 450px; top: 10%; left: 40%;}
    #dolphin-window { width: 350px; top: 20%; left: 55%; border-color: #00bcd4; }

    /* === ğŸ¾ ì‹œë©”ì§€ (ìƒì¡´ì) === */
    #shimeji-room { position: absolute; top: 75%; left: 75%; z-index: 30; text-align: center; cursor: grab; transition: top 1.5s linear, left 1.5s linear; }
    #shimeji-room:active { cursor: grabbing; transition: none; }
    #pet-bubble { background: #000; border: 1px solid #ff0000; padding: 5px; font-size: 11px; color: #ff0000; margin-bottom: 5px; opacity:0; transition: opacity 0.3s; font-family: 'Galmuri9'; box-shadow: 2px 2px 0px #8b0000;}
    #pet-image { width: 90px; height: 90px; object-fit: contain; filter: drop-shadow(5px 5px 10px rgba(0,0,0,0.8)); transform: scaleX(var(--flip, 1)); }
    .is-walking { animation: bounce 0.3s infinite; }
    @keyframes bounce { 0%, 100% { transform: translateY(0) scaleX(var(--flip, 1)); } 50% { transform: translateY(-15px) scaleX(var(--flip, 1)); } }

    /* UI ê³µí†µ ìš”ì†Œ */
    .player-controls { display: flex; gap: 8px; justify-content: center; margin-bottom: 10px;}
    .ctrl-btn { background: #222; border: 1px solid #555; width: 35px; height: 35px; cursor: pointer; font-size: 12px; color: #ccc; display:flex; justify-content:center; align-items:center; transition:0.1s;}
    .ctrl-btn:active { background: #ff0000; color:#000; transform: translate(2px,2px);}
    .music-info { font-size: 11px; color: #ff0000; font-family: 'ê¶ì„œ'; overflow: hidden; white-space: nowrap; text-align:center; background:#000; padding:5px; border: 1px solid #8b0000;}
    .input-row { display: flex; flex-direction: column; margin-bottom: 15px; }
    .input-row label { font-size: 12px; color: #8b0000; margin-bottom: 5px; font-family: 'ê¶ì„œ'; font-weight: bold;}
    .cute-input { padding: 8px; border: 1px solid #555; background: #000; color: #00ff00; font-family: 'Galmuri9'; outline: none;}
    .btn-action { font-family: 'ê¶ì„œ'; font-size: 12px; padding: 8px 15px; cursor: pointer; border: 1px solid #8b0000; background: #000; color: #ff0000; font-weight: bold; box-shadow: 3px 3px 0px rgba(0,0,0,0.5); transition:0.1s;}
    .btn-action:hover { background: #8b0000; color: #000; }
    .btn-action:active { transform: translate(2px,2px); box-shadow:none;}
    .chat-body { height: 250px; background: #000; border: 1px solid #555; overflow-y: auto; padding: 10px; font-size: 12px; font-family: 'Galmuri9'; color: #ccc;}
    .msg-row { margin-bottom: 8px; line-height: 1.4; padding: 5px; border-bottom: 1px dashed #333; width: fit-content; max-width: 85%;}
    .msg-ai { color: #ff0000; float: left; clear: both; } .msg-me { color: #00ff00; text-align: right; float: right; clear: both; } .msg-sys { text-align: center; color: #555; font-size: 10px; clear: both; width:100%; max-width:none;}

    /* === ğŸ“ ì•„ì½”ë””ì–¸ ê²Œì‹œíŒ (ë‹¤í¬ ë²„ì „) === */
    .post-item { margin-bottom: 10px; border: 1px solid #555; background: #111; }
    .post-header { background: #222; padding: 8px 12px; font-weight: bold; color: #ccc; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: 0.2s; border-bottom: 1px solid #000;}
    .post-header:hover { background: #333; color: #ff0000; }
    .post-content-area { padding: 15px; display: none; border-top: 1px dashed #333; font-size: 12px; line-height: 1.6; color: #aaa; background: #0a0a0a;}

    /* === ğŸ¤– ë¡œë´‡ ê²€ì¦ ë§ˆì˜ ê´€ë¬¸ === */
    #captcha-modal { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.95); z-index: 9999999; display: flex; justify-content: center; align-items: center; flex-direction: column; font-family: 'Galmuri9'; }
    .captcha-box { background: #222; border: 2px solid #ff0000; padding: 20px; width: 300px; color: #ff0000; box-shadow: 0 0 20px #ff0000; }
    .captcha-header { background: #ff0000; color: #000; padding: 10px; font-weight: bold; margin: -20px -20px 20px -20px; display: flex; align-items: center; gap: 10px; font-family: 'Impact'; letter-spacing: 1px;}
    .captcha-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-bottom: 15px; }
    .captcha-grid img { width: 100%; height: 80px; object-fit: cover; cursor: pointer; border: 2px solid #000; filter: grayscale(100%) contrast(1.5); transition:0.2s;}
    .captcha-grid img:active { border-color: #ff0000; filter: grayscale(0%) contrast(1.2) sepia(0.5); transform: scale(0.9);}
    .captcha-btn { width: 100%; padding: 10px; background: #ff0000; color: #000; border: none; font-weight: bold; cursor: pointer; font-family: 'ê¶ì„œ'; font-size: 18px;}
    .captcha-btn:hover { background: #fff; color: #ff0000; }

    /* === ğŸ¬ ëŒê³ ë˜ ì•„ì¼€ì´ë“œ (ë…ë¦½ & ìŠ¹ë¦¬ ë¡œì§ í¬í•¨) === */
    #dolphin-game-area { width: 300px; height: 350px; background: linear-gradient(to bottom, #000, #003333, #006064); border: 4px solid #000; margin: 0 auto; position: relative; overflow: hidden; box-shadow: inset 0 0 30px #000;}
    .dolphin-deco { position: absolute; font-size: 40px; opacity: 0.3; filter: grayscale(100%) invert(1); user-select: none;}
    .ring { width: 25px; height: 25px; border: 4px solid #ff0000; border-radius: 50%; position: absolute; box-shadow: 0 0 10px rgba(255,0,0,0.5); transition: top 0.2s ease-out, left 0.2s ease-out; }
    .post { width: 10px; height: 120px; background: #333; position: absolute; bottom: 0; border-radius: 5px 5px 0 0; border:1px solid #555;}
    .pump-btn { width: 60px; height: 60px; background: #111; border: 3px solid #00bcd4; border-radius: 50%; cursor: pointer; font-size: 20px; color: #00bcd4; display: flex; justify-content: center; align-items: center; user-select: none; box-shadow: 0 0 10px #00bcd4; transition: 0.1s;}
    .pump-btn:active { background: #00bcd4; color:#000; transform: scale(0.9); box-shadow: none; }
    #dolphin-ui-top { display: flex; justify-content: space-between; padding: 5px 10px; background: #000; color: #00bcd4; font-family: 'Galmuri9'; font-size: 14px; border-bottom: 2px solid #00bcd4;}
    #dolphin-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10; color: #ff0000; font-size: 16px; font-family: 'ê¶ì„œ'; text-align: center; }
    .start-btn { background: #000; border: 2px solid #ff0000; color: #ff0000; padding: 10px 20px; font-family: 'ê¶ì„œ'; cursor: pointer; margin-top: 15px; font-size: 18px; box-shadow: 3px 3px 0px #8b0000; transition:0.1s;}
    .start-btn:active { transform: translate(3px,3px); box-shadow: none;}

    /* ìíŒê¸° ì•„ì´í…œ ì¤‘ë ¥ ë‚™í•˜ ë ˆì´ì–´ */
    #item-drop-zone { position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 10000; overflow: hidden;}
    .dropped-item { position: absolute; font-size: 30px; filter: drop-shadow(2px 2px 5px rgba(0,0,0,1)); animation: itemFall 1s ease-out forwards; }
    @keyframes itemFall { 0% { transform: translateY(-100px) rotate(0deg); opacity:0; } 100% { transform: translateY(0) rotate(360deg); opacity:1; } }

    /* ë§ˆìš°ìŠ¤ íˆ´íŒ (í”¼íˆ¬ì„±ì´) */
    #custom-tooltip { position: absolute; display: none; z-index: 9999999; background: #000; border: 1px solid #ff0000; padding: 5px 10px; font-size: 11px; font-family: 'ê¶ì„œ'; color: #ff0000; pointer-events: none; white-space: nowrap; box-shadow: 2px 2px 0px #8b0000;}
  </style>
</head>
<body id="main-body">

  <audio id="click-sound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_c8c8a7346b.mp3?filename=click-button-140881.mp3" preload="auto"></audio>
  <audio id="popup-sound" src="https://cdn.pixabay.com/download/audio/2022/03/10/audio_c63c33407f.mp3?filename=interface-124464.mp3" preload="auto"></audio>

  <div id="captcha-modal">
      <div class="captcha-box">
          <div class="captcha-header">ğŸ’€ S Y S T E M _ E R R O R</div>
          <p style="font-size:12px; margin-top:0; color:#ccc;">'ê³ í†µ'ì„ ëŠë¼ëŠ” í”¼ì‚¬ì²´ë¥¼ ëª¨ë‘ ì„ íƒí•˜ë¼.</p>
          <div class="captcha-grid">
              <img src="https://cdn.pixabay.com/photo/2017/06/14/04/08/old-man-2401183_1280.jpg">
              <img src="https://cdn.pixabay.com/photo/2016/11/21/16/08/barbed-wire-1846148_1280.jpg">
              <img src="https://cdn.pixabay.com/photo/2015/12/01/20/28/road-1072821_1280.jpg">
              <img src="https://cdn.pixabay.com/photo/2014/09/13/21/16/hands-444440_1280.jpg">
              <img src="https://cdn.pixabay.com/photo/2017/08/01/01/33/beanie-2562646_1280.jpg">
              <img src="https://cdn.pixabay.com/photo/2018/05/23/17/36/doll-3424627_1280.jpg">
          </div>
          <button class="captcha-btn" onclick="document.getElementById('captcha-modal').style.display='none'; playSound('popup-sound');">[ ì ‘ì† ìŠ¹ì¸ ]</button>
      </div>
  </div>

  <marquee class="top-marquee">â€ ...ì´ê³³ì€ ë²„ë ¤ì§„ ìë“¤ì˜ ì„±ì†Œ... ë…¸ë€ ì¥íŒ ë°‘ì— ìˆ¨ê²¨ë‘” ì¹¼ë‚ ê³¼ ë§¹ëª©ì ì¸ ë¯¿ìŒë§Œì´ ìš°ë¦¬ë¥¼ êµ¬ì›í•˜ë¦¬ë¼...â€  SYSTEM BREACH DETECTED...</marquee>
  <div id="custom-tooltip">ë§í’ì„ </div>

  <div class="messy-canvas" id="desktop-area">
    <div id="item-drop-zone"></div>
    
    <div class="floating-obj float-1">ğŸ‘ï¸</div>
    <div class="floating-obj float-2">ğŸ©¸</div>
    <div class="floating-obj float-3">âœï¸</div>

    <div class="fd-menu">
        <span class="m-info" data-tooltip="íŒŒë©¸ì˜ ê¸°ë¡">Information</span>
        <span class="m-story" data-tooltip="ìš°ë¦¬ì˜ ì„œì‚¬">Story</span>
        <span class="m-cast" data-tooltip="ë°©ê´€ìë“¤">Staff/Cast</span>
    </div>

    <div class="main-pic-container">
        <img id="main-visual-img" src="https://cdn.pixabay.com/photo/2020/04/18/16/24/pixel-art-5059880_1280.png" class="main-pic-img">
        <div class="pic-label">âœï¸ ë§¹ë ¬í•œ ìˆœì• (ç´”æ„›) âœï¸</div>
    </div>
    
    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/14/Keep_out_sign.svg/1200px-Keep_out_sign.svg.png" class="weird-banner wb-1">
    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/cd/Warning_sign_of_biohazard.svg/1024px-Warning_sign_of_biohazard.svg.png" class="weird-banner wb-2">

    <div id="mutter-char">
        <div id="mutter-bubble">ë‹¤ ì£½ì—¬ë²„ë¦´ê¹Œ...</div>
        <img id="mutter-img" src="https://cdn.pixabay.com/photo/2014/04/02/10/26/face-303860_1280.png">
    </div>

    <button class="scattered-btn btn-tattered btn-home" onclick="openPopup('profile-window')" data-tooltip="í˜„ì¥ ì¡°ì‘">ğŸ› ï¸ ì¸í…Œë¦¬ì–´</button>
    <button class="scattered-btn btn-bloody btn-diary" onclick="openBoard('diary')" data-tooltip="í”¼ë¡œ ì“´ ê¸°ë¡">ğŸ““ ë°ìŠ¤ ë…¸íŠ¸</button>
    <button class="scattered-btn btn-tattered btn-char" onclick="openBoard('character')" data-tooltip="ë§ê°€ì§„ ìì•„">âœ¨ í˜ë¥´ì†Œë‚˜</button>
    <button class="scattered-btn btn-bloody btn-review" onclick="openBoard('review')" data-tooltip="ì”í˜¹ ê¸°ë¡">ğŸ¬ ëª©ê²©ë‹´</button>
    <button class="scattered-btn btn-tattered btn-guest" onclick="openBoard('guestbook')" data-tooltip="ìƒì¡´ ì‹ ê³ ">ğŸ“ ìœ ì–¸ì¥</button>
    <button class="scattered-btn btn-bloody btn-shop" onclick="openPopup('shop-window')" data-tooltip="ë‹¤í¬ì›¹ ê±°ë˜">ğŸ›’ ì•”ì‹œì¥</button>
    <button class="scattered-btn btn-tattered btn-write" onclick="openWrite()" data-tooltip="ê¸°ë¡í•˜ë¼">âœï¸ íˆ¬ê³ í•˜ê¸°</button>
    <button class="scattered-btn btn-glitch btn-dolphin" onclick="openPopup('dolphin-window')" data-tooltip="ì •ì‹  ì°©ë€">ğŸ¬ ì˜¤ë½ì‹¤</button>

    <div class="news-popup">
        <div class="news-header">â€  N E W S â€ </div>
        <div class="news-content">
            <p>SYSTEM: ëª¨ë“  ê¸°ëŠ¥ ì •ìƒ ì‘ë™ í™•ì¸.</p>
            <p>12ì›” 12ì¼<br>ëª¨í…”ê°€ ë’·ê³¨ëª©ì—ì„œ ë°œê²¬ëœ ìˆœì• ì˜ í”ì ... ì‹ ì› ë¯¸ìƒ.</p>
            <p>11ì›” 29ì¼<br>ì‚¬ì´ë¹„ ì§‘íšŒ ì¤‘ ë§¹ë ¬í•œ ì‚¬ë‘ì„ ì™¸ì¹˜ë©° ì „ì› ìí­...</p>
            <p>ê²½ê³ : ëŒê³ ë˜ ê²Œì„ ìŠ¹ë¦¬ ì‹œ ê³¼ë„í•œ ë„íŒŒë¯¼ ì£¼ì˜.</p>
            <p>ê²°ë§ì€ í™”ë ¤í•˜ê²Œ ë¹›ë‚˜ë¦¬ë¼.</p>
        </div>
    </div>

    <div class="bottom-synopsis">
        êµ¬ì§€ë ˆí•˜ê³  ê¶ìƒë§ìœ¼ë©´ì„œë„ ì‚¬ë‘í•˜ê¸°ì— ë²…ì°¨ì„œ ë‚˜ë‚ ì´ ë°”ìœ ì‚¬ëŒë“¤ì˜ ì´ì•¼ê¸°... ê·¸ ì©ì–´ë¬¸ë“œëŸ¬ì§„ ë…¸ë€ì¥íŒ ìœ„ì—ì„œë„ ê¿‹ê¿‹í•˜ê²Œ ì˜ì§€ë¥¼ ë‹¤ì¡ëŠ” ê°•ë ¬í•œ ì²­ì¶˜ì˜ íŒŒí¸ë“¤. ì†ì ˆì—†ì´ ë¬´ë„ˆì§€ëŠ” ìë“¤ì´ íƒœë°˜ì¸ ì´ ì§€ì˜¥ì—ì„œ, ì–´ë–¤ ìƒí™©ì´ ì°¾ì•„ì™€ë„ ì„œë¡œë¥¼ ëŒì–´ì•ˆê³  íƒ€ì£½ì„ì§€ì–¸ì • ê²°ë§ë§Œí¼ì€ í™”ë ¤í•˜ê²Œ ë¹›ë‚´ë¦¬ë¼...
    </div>

    <div id="shimeji-room" data-tooltip="ìƒì¡´ì">
        <div id="pet-bubble">ë°°ê³ íŒŒ...</div>
        <img id="pet-image" src="https://raw.githubusercontent.com/shimeji-ee/shimeji-ee.github.io/master/img/shime1.png" onclick="toggleChat()" ondblclick="toggleRoaming()">
    </div>

    <div id="dolphin-window" class="cute-popup">
        <div class="cute-titlebar" id="dolphin-drag">ğŸ¬ ì‹¬ì—°ì˜ ì˜¤ë½ì‹¤ <div class="cute-title-btns"><span class="btn-close" onclick="closePopup('dolphin-window')"></span></div></div>
        <div class="cute-body" style="background:#111; text-align:center; padding: 10px;">
            <div id="dolphin-ui-top"><span id="d-time">â³ 30ì´ˆ</span><span id="d-score">ğŸ† 0ì </span></div>
            <div id="dolphin-game-area">
                <div id="dolphin-overlay">
                    <div id="d-msg">ë§ ë˜ì§€ê¸°</div>
                    <button class="start-btn" onclick="startDolphinGame()">ì½”ì¸ ë„£ê¸°</button>
                </div>
                <div class="dolphin-deco" style="top:20px; left:20px;">ğŸ¬</div>
                <div class="dolphin-deco" style="bottom:50px; right:20px; transform:scaleX(-1);">ğŸ¬</div>
                <div class="post" style="left: 70px;"></div>
                <div class="post" style="right: 200px;"></div>
                <div class="ring" id="ring0"></div><div class="ring" id="ring1"></div><div class="ring" id="ring2"></div><div class="ring" id="ring3"></div><div class="ring" id="ring4"></div>
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 15px; align-items:center;">
                <button class="pump-btn" onclick="pushRings('left')">L</button>
                <div style="font-size:11px; color:#00bcd4;">ì—°íƒ€...</div>
                <button class="pump-btn" onclick="pushRings('right')">R</button>
            </div>
        </div>
    </div>

    <div id="music-window" class="cute-popup">
        <div class="cute-titlebar" id="music-drag">ğŸ“» ë„ì²­ ì¥ì¹˜ <div class="cute-title-btns"><span class="btn-close" onclick="closePopup('music-window')"></span></div></div>
        <div class="cute-body">
            <div class="player-controls">
                <button class="ctrl-btn" onclick="prevTrack()">â®</button>
                <button class="ctrl-btn" id="play-btn" onclick="togglePlay()">â–¶</button>
                <button class="ctrl-btn" onclick="nextTrack()">â­</button>
            </div>
            <marquee class="music-info" scrollamount="4" id="now-playing-text">ì‹ í˜¸ ëŒ€ê¸° ì¤‘...</marquee>
        </div>
    </div>

    <div id="board-window" class="cute-popup">
        <div class="cute-titlebar" id="board-drag"><span id="board-title">ğŸ€ Board</span> <div class="cute-title-btns"><span class="btn-close" onclick="closePopup('board-window')"></span></div></div>
        <div class="cute-body" id="page-content" style="background:#0a0a0a;">ë¡œë”© ì¤‘...</div>
    </div>

    <div id="write-window" class="cute-popup">
        <div class="cute-titlebar" id="write-drag">ğŸ“ ê¸°ë¡ ì¥ì¹˜ <div class="cute-title-btns"><span class="btn-close" onclick="closePopup('write-window')"></span></div></div>
        <div class="cute-body">
            <div class="input-row" style="flex-direction:row; align-items:center; justify-content:space-between;">
                <div style="display:flex; gap:10px; align-items:center;">
                    <label style="margin:0;">ë¶„ë¥˜</label>
                    <select id="post-category" class="cute-input" style="width: 120px;">
                        <option value="diary">ë°ìŠ¤ ë…¸íŠ¸</option>
                        <option value="character">í˜ë¥´ì†Œë‚˜</option>
                        <option value="review">ëª©ê²©ë‹´(ë¦¬ë·°)</option>
                        <option value="guestbook">ìœ ì–¸ì¥(ë°©ëª…ë¡)</option>
                    </select>
                </div>
                <div>
                    <label for="local-img-upload" class="btn-action" style="cursor:pointer;">ğŸ–¼ï¸ ì¦ê±° ì²¨ë¶€</label>
                    <input type="file" id="local-img-upload" accept="image/*" style="display:none;" onchange="insertLocalImageToEditor(this)">
                </div>
            </div>
            <div class="input-row"><input type="text" id="post-title" class="cute-input" placeholder="ì œëª©..."></div>
            <textarea id="post-content"></textarea>
            <div style="text-align: right; margin-top: 15px;"><button class="btn-action" onclick="savePost()">ë´‰ì¸</button></div>
        </div>
    </div>

    <div id="ai-window" class="cute-popup">
        <div class="cute-titlebar" id="ai-drag">ğŸ’¬ êµì‹  <div class="cute-title-btns"><span class="btn-close" onclick="closePopup('ai-window')"></span></div></div>
        <div class="cute-body">
          <div class="chat-body" id="chat-log"><div class="msg-row msg-ai">ë‚˜ë£¨: ...ì‘ë‹µí•˜ë¼.</div></div>
          <div style="display:flex; gap:5px; margin-top:10px;">
              <input type="text" id="ai-input" class="cute-input" style="flex:1;" onkeypress="if(event.key==='Enter') sendMsg()">
              <button class="btn-action" onclick="sendMsg()">ì „ì†¡</button>
          </div>
        </div>
    </div>

    <div id="profile-window" class="cute-popup">
        <div class="cute-titlebar" id="profile-drag">ğŸ› ï¸ í˜„ì¥ ì¡°ì‘ <div class="cute-title-btns"><span class="btn-close" onclick="closePopup('profile-window')"></span></div></div>
        <div class="cute-body">
            <div class="input-row"><label>ê±°ëŒ€ ì•¡ì ê·¸ë¦¼</label><input type="file" id="edit-main-file" class="cute-input"></div>
            <div class="input-row"><label>ìƒì¡´ì(í«) ì´ë¯¸ì§€</label><input type="file" id="edit-pet-file" class="cute-input"></div>
            <div class="input-row"><label>BGM ë¦¬ìŠ¤íŠ¸ (ID ì‰¼í‘œ êµ¬ë¶„)</label><textarea id="edit-bgm" class="cute-input" rows="2" placeholder="VDMiHYgQKLE, jfKfPfyJRdk"></textarea></div>
            <div style="text-align: right;"><button class="btn-action" onclick="saveProfile()">ì ìš©</button></div>
        </div>
    </div>

    <div id="shop-window" class="cute-popup">
        <div class="cute-titlebar" id="shop-drag">ğŸ›’ ì•”ì‹œì¥ <div class="cute-title-btns"><span class="btn-close" onclick="closePopup('shop-window')"></span></div></div>
        <div class="cute-body" style="text-align:center;">
            <h3 style="color:#ff0000; margin:0 0 10px 0;">ì”ê³ : <span id="my-money">0</span> P</h3>
            <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-bottom:15px;">
                <button class="btn-action" style="padding:15px 10px;" onclick="buyItem('ì¹¼', 'ğŸ”ª', 100)">ğŸ”ª<br>100P</button>
                <button class="btn-action" style="padding:15px 10px;" onclick="buyItem('ì•Œì•½', 'ğŸ’Š', 200)">ğŸ’Š<br>200P</button>
                <button class="btn-action" style="padding:15px 10px;" onclick="buyItem('ë¶€ì ', 'ğŸ´', 300)">ğŸ´<br>300P</button>
                <button class="btn-action" style="padding:15px 10px; color:#00bcd4; border-color:#00bcd4;" onclick="buyItem('ì¹©', 'ğŸ’¾', 500)">ğŸ’¾<br>500P</button>
            </div>
            <div style="text-align:right;"><button class="btn-action" style="font-size:11px;" onclick="clearRoomItems()">í˜„ì¥ ì²­ì†Œ</button></div>
        </div>
    </div>

  </div>
  <div id="yt-player-container" style="display:none;"></div>

  <script>
    /* ğŸ”´ í´ë¦­/íŒì—… ì‚¬ìš´ë“œ ì¬ìƒ í•¨ìˆ˜ */
    function playSound(id) { const audio = document.getElementById(id); if(audio) { audio.currentTime = 0; audio.play().catch(() => {}); }}
    document.addEventListener('click', (e) => {
        if(e.target.tagName === 'BUTTON' || e.target.classList.contains('scattered-btn') || e.target.classList.contains('btn-close') || e.target.tagName === 'SPAN') {
            playSound('click-sound');
        }
    });

    /* Supabase ì„¤ì • */
    const SB_URL = "https://kzgbqpodvpuoqovfsyrm.supabase.co";
    const SB_KEY = "sb_publishable_pdqE1Sc-4PSv3LQM9IsBcA_xJWeZwW-"; 
    const OPENROUTER_KEY = "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"; 
    let sbClient = null; if (window.supabase) sbClient = window.supabase.createClient(SB_URL, SB_KEY);
    
    CKEDITOR.replace('post-content', { height: 250, language: 'ko', removeButtons: 'About', versionCheck: false });
    let currentEditId = null; let globalPostsData = []; 

    function insertLocalImageToEditor(input) { const file = input.files[0]; if(!file) return; if(file.size > 2 * 1024 * 1024) return alert("ìš©ëŸ‰ ì´ˆê³¼..."); const reader = new FileReader(); reader.onload = function(e) { CKEDITOR.instances['post-content'].insertHtml(`<img src="${e.target.result}" style="max-width:100%; border-radius:5px; filter:grayscale(50%) contrast(1.2);">`); input.value = ''; }; reader.readAsDataURL(file); }

    /* ë§ˆìš°ìŠ¤ íˆ´íŒ */
    const tooltip = document.getElementById('custom-tooltip');
    document.addEventListener('mousemove', (e) => { const target = e.target.closest('[data-tooltip]'); if (target) { tooltip.style.display = 'block'; tooltip.style.left = (e.pageX + 15) + 'px'; tooltip.style.top = (e.pageY + 15) + 'px'; tooltip.innerText = target.getAttribute('data-tooltip'); } else { tooltip.style.display = 'none'; } });

    /* ğŸ”´ íŒì—…ì°½ ë“œë˜ê·¸ ë° ì• ë‹ˆë©”ì´ì…˜ */
    let highestZ = 100;
    function makeDraggable(winId, dragId) { const win = document.getElementById(winId); const dragArea = document.getElementById(dragId); let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0; win.onmousedown = () => { win.style.zIndex = ++highestZ; }; dragArea.onmousedown = (e) => { e.preventDefault(); pos3 = e.clientX; pos4 = e.clientY; document.onmouseup = closeDrag; document.onmousemove = elementDrag; }; function elementDrag(e) { e.preventDefault(); pos1 = pos3 - e.clientX; pos2 = pos4 - e.clientY; pos3 = e.clientX; pos4 = e.clientY; win.style.top = (win.offsetTop - pos2) + "px"; win.style.left = (win.offsetLeft - pos1) + "px"; } function closeDrag() { document.onmouseup = null; document.onmousemove = null; } }
    ['write-window','board-window','ai-window','profile-window','shop-window','music-window','shimeji-room','dolphin-window'].forEach(id => { makeDraggable(id, id === 'shimeji-room' ? id : id.replace('window', 'drag')); });
    
    function openPopup(id) { 
        playSound('popup-sound'); // íŒì—… ì‚¬ìš´ë“œ
        const el = document.getElementById(id); el.style.display = 'block'; el.style.zIndex = ++highestZ; 
        el.classList.remove('pop-anim'); void el.offsetWidth; el.classList.add('pop-anim'); // ì• ë‹ˆë©”ì´ì…˜ ë¦¬í”Œë ˆì´
    }
    function closePopup(id) { document.getElementById(id).style.display = 'none'; }

    /* ğŸ—£ï¸ ë°©ê´€ì ì¤‘ì–¼ê±°ë¦¼ */
    const mutterTexts = ["ë‹¤ ì£½ì—¬ë²„ë¦´ê¹Œ...", "ê·¸ë˜ë„ ì‚¬ë‘í•´...", "ë…¸ë€ ì¥íŒì˜ ëƒ„ìƒˆ...", "ëë‚´ ì‚´ì•„ë‚¨ì•„...", "ì§€ì¼œë³´ê³  ìˆë‹¤..."];
    const mutterBubble = document.getElementById('mutter-bubble');
    setInterval(() => {
        mutterBubble.style.opacity = '1'; mutterBubble.innerText = mutterTexts[Math.floor(Math.random() * mutterTexts.length)];
        setTimeout(() => { mutterBubble.style.opacity = '0'; }, 3000);
    }, 7000);

    /* ğŸ”´ ëŒê³ ë˜ ì•„ì¼€ì´ë“œ (ìŠ¹ë¦¬ ë²„ê·¸ ìˆ˜ì • ì™„ë£Œ) */
    const rings = [document.getElementById('ring0'), document.getElementById('ring1'), document.getElementById('ring2'), document.getElementById('ring3'), document.getElementById('ring4')];
    let ringStates = []; let dTime = 30; let dScore = 0; let dState = 'ready'; let dTimer = null; let gameLoop = null;

    function resetRings() {
        ringStates = rings.map((r, i) => ({ x: 30 + (i*45), y: 300, vy: 0, vx: 0, stuck: false, scored: false }));
        rings.forEach((r, i) => { r.style.top = '300px'; r.style.left = ringStates[i].x + 'px'; });
    }
    resetRings();

    function startDolphinGame() {
        dState = 'playing'; dTime = 30; dScore = 0;
        document.getElementById('d-score').innerText = 'ğŸ† 0ì '; document.getElementById('d-time').innerText = 'â³ 30ì´ˆ';
        document.getElementById('dolphin-overlay').style.display = 'none'; resetRings();
        if(dTimer) clearInterval(dTimer);
        dTimer = setInterval(() => { dTime--; document.getElementById('d-time').innerText = `â³ ${dTime}ì´ˆ`; if(dTime <= 0) endGame(false); }, 1000);
        if(!gameLoop) updateGame();
    }

    function endGame(isWin) {
        dState = 'over'; clearInterval(dTimer); cancelAnimationFrame(gameLoop); gameLoop = null;
        const msgEl = document.getElementById('d-msg');
        if(isWin) { msgEl.innerText = `â€  ìŠ¹ ë¦¬ â€ \n+100P ì§€ê¸‰`; earnPoints(100); } 
        else { msgEl.innerText = `G A M E O V E R\nìµœì¢…: ${dScore}ì `; }
        document.getElementById('dolphin-overlay').style.display = 'flex'; document.querySelector('.start-btn').innerText = 'ë‹¤ì‹œ í•˜ê¸°';
    }

    const gravity = 0.5;
    function updateGame() {
        if(dState !== 'playing') return;
        rings.forEach((ring, i) => {
            let s = ringStates[i]; if (s.stuck) return;
            s.vy += gravity; s.y += s.vy; s.x += s.vx; s.vx *= 0.92;
            if (s.y > 300) { s.y = 300; s.vy = -s.vy * 0.4; } 
            if (s.x < 0) { s.x = 0; s.vx = -s.vx; } if (s.x > 250) { s.x = 250; s.vx = -s.vx; }
            if ((Math.abs(s.x - 65) < 15 || Math.abs(s.x - 195) < 15) && s.y > 180 && s.y < 250 && s.vy > 0) {
                s.stuck = true; s.y = 240 - (dScore*10); s.x = Math.abs(s.x - 65) < 15 ? 65 : 195;
                if(!s.scored) { s.scored = true; dScore++; document.getElementById('d-score').innerText = `ğŸ† ${dScore}ì `; }
            }
            ring.style.top = s.y + 'px'; ring.style.left = s.x + 'px';
        });
        if(dScore >= 5) { endGame(true); return; } 
        gameLoop = requestAnimationFrame(updateGame);
    }
    function pushRings(side) {
        if(dState !== 'playing') return;
        rings.forEach((ring, i) => {
            let s = ringStates[i]; if (s.stuck) return;
            s.vy = -Math.random() * 10 - 6; s.vx = (side === 'left' ? 1 : -1) * (Math.random() * 5 + 2);
        });
    }

    /* ğŸ”´ ìíŒê¸° ì•„ì´í…œ ì¤‘ë ¥ ë‚™í•˜ (ë²„ê·¸ ìˆ˜ì •) */
    let myMoney = parseInt(localStorage.getItem('myPoints') || '1000'); let roomItems = JSON.parse(localStorage.getItem('myRoomItems') || '[]');
    function updateMoneyDisplay() { document.getElementById('my-money').innerText = myMoney; localStorage.setItem('myPoints', myMoney); }
    function earnPoints(amount) { myMoney += amount; updateMoneyDisplay(); } updateMoneyDisplay();
    
    function buyItem(name, icon, price) { 
        if (myMoney < price) return alert("ìê¸ˆ ë¶€ì¡±..."); myMoney -= price; updateMoneyDisplay(); 
        const randX = Math.floor(Math.random() * (window.innerWidth - 50));
        const randY = Math.floor(Math.random() * (window.innerHeight - 100));
        const newItem = { icon: icon, x: randX, y: randY }; 
        roomItems.push(newItem); localStorage.setItem('myRoomItems', JSON.stringify(roomItems)); renderRoomItems(); 
    }
    function renderRoomItems() { 
        const layer = document.getElementById('item-drop-zone'); layer.innerHTML = ''; 
        roomItems.forEach(item => { 
            const el = document.createElement('div'); el.className = 'dropped-item'; 
            el.style.left = item.x + 'px'; el.style.top = item.y + 'px'; el.innerText = item.icon; 
            layer.appendChild(el); 
        }); 
    }
    function clearRoomItems() { roomItems = []; localStorage.setItem('myRoomItems', '[]'); renderRoomItems(); } renderRoomItems();

    /* ì„¤ì • */
    let tempMainBase64 = null, tempPetBase64 = null; let currentPlaylist = [];
    function handleFile(id, callback) { document.getElementById(id).addEventListener('change', function(e) { const file = e.target.files[0]; if(!file) return; if(file.size > 3 * 1024 * 1024) return alert("ìš©ëŸ‰ ì´ˆê³¼..."); const r = new FileReader(); r.onload = evt => callback(evt.target.result); r.readAsDataURL(file); }); }
    handleFile('edit-main-file', res => tempMainBase64 = res); handleFile('edit-pet-file', res => tempPetBase64 = res);
    function loadProfile() { const saved = JSON.parse(localStorage.getItem('darkRoomSettingsV3')) || {}; if(saved.main) document.getElementById('main-visual-img').src = saved.main; document.getElementById('pet-image').src = saved.pet || 'https://raw.githubusercontent.com/shimeji-ee/shimeji-ee.github.io/master/img/shime1.png'; currentPlaylist = (saved.bgm || 'VDMiHYgQKLE').split(',').map(s => s.trim()).filter(s => s); tempMainBase64 = saved.main || ''; tempPetBase64 = saved.pet || ''; }
    function saveProfile() { try { localStorage.setItem('darkRoomSettingsV3', JSON.stringify({ main: tempMainBase64, pet: tempPetBase64, bgm: document.getElementById('edit-bgm').value || 'VDMiHYgQKLE' })); } catch(e) { alert("ì €ì¥ ì‹¤íŒ¨..."); return; } loadProfile(); closePopup('profile-window'); if(player && player.loadVideoById) loadMusicPlayer(); }

    /* ìœ íŠœë¸Œ */
    let player = null; let trackIndex = 0; let isPlayerReady = false; let tag = document.createElement('script'); tag.src = "https://www.youtube.com/iframe_api"; document.head.appendChild(tag);
    window.onYouTubeIframeAPIReady = function() { if(currentPlaylist.length === 0) return; trackIndex = Math.floor(Math.random() * currentPlaylist.length); player = new YT.Player('yt-player-container', { height: '0', width: '0', videoId: currentPlaylist[trackIndex], events: { 'onReady': () => { isPlayerReady = true; document.getElementById('now-playing-text').innerText = "ì‹ í˜¸ ëŒ€ê¸° ì¤‘..."; }, 'onStateChange': onPlayerStateChange, 'onError': nextTrack } }); }
    function loadMusicPlayer() { if(!isPlayerReady || currentPlaylist.length === 0) return; trackIndex = Math.floor(Math.random() * currentPlaylist.length); player.loadVideoById(currentPlaylist[trackIndex]); }
    function onPlayerStateChange(event) { if(event.data === YT.PlayerState.ENDED) nextTrack(); if(event.data === YT.PlayerState.PLAYING) { document.getElementById('play-btn').innerText = 'â¸'; let videoTitle = player.getVideoData().title; document.getElementById('now-playing-text').innerText = "â–¶ " + (videoTitle || currentPlaylist[trackIndex]); } if(event.data === YT.PlayerState.PAUSED) { document.getElementById('play-btn').innerText = 'â–¶'; } }
    function togglePlay() { if(!isPlayerReady) return; if(player.getPlayerState() === YT.PlayerState.PLAYING) player.pauseVideo(); else player.playVideo(); } function nextTrack() { if(!isPlayerReady) return; trackIndex = (trackIndex + 1) % currentPlaylist.length; player.loadVideoById(currentPlaylist[trackIndex]); } function prevTrack() { if(!isPlayerReady) return; trackIndex = (trackIndex - 1 + currentPlaylist.length) % currentPlaylist.length; player.loadVideoById(currentPlaylist[trackIndex]); }

    /* ì‹œë©”ì§€ */
    let isRoaming = false; let roamInterval; function showBubble(text) { const bubble = document.getElementById('pet-bubble'); bubble.innerText = text; bubble.style.opacity = '1'; setTimeout(() => { bubble.style.opacity = '0'; }, 3000); }
    setInterval(() => { if(Math.random() > 0.5) showBubble(["ë°°ê³ íŒŒ...", "ì‹¬ì‹¬í•´...", "ì¶”ì›Œ..."][Math.floor(Math.random() * 3)]); }, 9000);
    function toggleRoaming() { isRoaming = !isRoaming; const petRoom = document.getElementById('shimeji-room'); const petImg = document.getElementById('pet-image'); let currentX = petRoom.offsetLeft; if(isRoaming) { roamInterval = setInterval(() => { const randX = Math.floor(Math.random() * (window.innerWidth - 150)); const randY = Math.floor(Math.random() * (window.innerHeight - 150)); if(randX < currentX) petImg.style.setProperty('--flip', -1); else petImg.style.setProperty('--flip', 1); currentX = randX; petImg.classList.add('is-walking'); petRoom.style.left = randX + 'px'; petRoom.style.top = randY + 'px'; setTimeout(() => { petImg.classList.remove('is-walking'); }, 1500); }, 3000); } else { clearInterval(roamInterval); petImg.classList.remove('is-walking'); } }

    /* AI */
    async function callAI(text) { try { const res = await fetch("https://openrouter.ai/api/v1/chat/completions", { method: "POST", headers: { "Authorization": `Bearer ${OPENROUTER_KEY}`, "Content-Type": "application/json" }, body: JSON.stringify({ "model": "mistralai/mistral-7b-instruct:free", "messages": [{"role": "system", "content": "ë„ˆëŠ” í”¼íí•œ ë‹¤ë§ˆê³ ì¹˜ í«ì´ì•¼. ì–´ë‘¡ê³  ì§§ê²Œ ë°˜ë§ë¡œ ëŒ€ë‹µí•´."}, {"role": "user", "content": text}] }) }); const data = await res.json(); if(data.choices) return data.choices[0].message.content; } catch(e) { return null; } return null; }
    function toggleChat() { openPopup('ai-window'); } async function sendMsg() { const input = document.getElementById('ai-input'); const log = document.getElementById('chat-log'); const text = input.value.trim(); if(!text) return; log.innerHTML += `<div class="msg-row msg-me">${text}</div>`; input.value = ''; log.scrollTop = log.scrollHeight; const loadingId = "load-" + Date.now(); log.innerHTML += `<div id="${loadingId}" class="msg-row msg-ai">ë‚˜ë£¨: (ì¹¨ë¬µ...)</div>`; log.scrollTop = log.scrollHeight; const reply = await callAI(text); document.getElementById(loadingId).remove(); if(reply) { log.innerHTML += `<div class="msg-row msg-ai">ë‚˜ë£¨: ${reply}</div>`; showBubble(reply); } else { log.innerHTML += `<div class="msg-sys">â€» í†µì‹  ë‹¨ì ˆ...</div>`; } log.scrollTop = log.scrollHeight; }

    /* ğŸ”´ ê²Œì‹œíŒ (ì•„ì½”ë””ì–¸) */
    function openBoard(type) { 
        let title = "ğŸ€ Board";
        if(type === 'diary') title = "ğŸ““ ë°ìŠ¤ ë…¸íŠ¸"; else if(type === 'character') title = "âœ¨ í˜ë¥´ì†Œë‚˜"; else if(type === 'review') title = "ğŸ¬ ëª©ê²©ë‹´(ë¦¬ë·°)"; else if(type === 'guestbook') title = "ğŸ“ ìœ ì–¸ì¥(ë°©ëª…ë¡)";
        document.getElementById('board-title').innerText = title; document.getElementById('page-content').innerHTML = `ë¡œë”© ì¤‘...`; 
        openPopup('board-window'); loadPosts(type); 
    } 
    function openWrite() { currentEditId = null; document.getElementById('post-title').value = ''; CKEDITOR.instances['post-content'].setData(''); openPopup('write-window'); } 
    async function savePost() { if (!sbClient) return; const category = document.getElementById('post-category').value; const title = document.getElementById('post-title').value; const content = CKEDITOR.instances['post-content'].getData(); if(!title || !content.trim()) return alert("ê¸°ë¡í•´ë¼...!"); let err; if (currentEditId) err = (await sbClient.from('posts').update({ title, content, category }).eq('id', currentEditId)).error; else { err = (await sbClient.from('posts').insert([{ title, content, category }])).error; if(!err) earnPoints(100); } if(err) alert("ì‹¤íŒ¨...!"); else { closePopup('write-window'); loadPosts(category); } } 
    async function deletePost(id, category) { if(!confirm("íŒŒê¸°í• ê¹Œ...?")) return; await sbClient.from('posts').delete().eq('id', id); loadPosts(category); } 
    function editPost(id) { const post = globalPostsData.find(p => p.id === id); if(!post) return; currentEditId = id; document.getElementById('post-category').value = post.category; document.getElementById('post-title').value = post.title; CKEDITOR.instances['post-content'].setData(post.content); openPopup('write-window'); } 
    
    function togglePostView(id) { 
        playSound('click-sound');
        const contentArea = document.getElementById('content-' + id);
        contentArea.style.display = contentArea.style.display === 'block' ? 'none' : 'block';
    }

    async function loadPosts(categoryType) { 
        if (!sbClient) return; 
        const { data, error } = await sbClient.from('posts').select('*').eq('category', categoryType).order('created_at', { ascending: false }); 
        const list = document.getElementById('page-content'); 
        if(error || data.length === 0) { list.innerHTML = "<div style='color:#ff0000; text-align:center; padding:20px;'>í…… ë¹„ì—ˆë‹¤...</div>"; return; } 
        
        globalPostsData = data; let html = ''; 
        data.forEach(p => { 
            const dateStr = new Date(p.created_at).toLocaleDateString(); 
            html += `
            <div class="post-item">
                <div class="post-header" onclick="togglePostView('${p.id}')">
                    <span>ğŸ“‘ ${p.title} <small style="color:#555; font-weight:normal; margin-left:10px;">${dateStr}</small></span>
                    <div>
                        <button class="btn-action" style="padding:4px 8px; font-size:11px;" onclick="event.stopPropagation(); editPost('${p.id}')">ìˆ˜ì •</button>
                        <button class="btn-action" style="padding:4px 8px; font-size:11px;" onclick="event.stopPropagation(); deletePost('${p.id}', '${p.category}')">íŒŒê¸°</button>
                    </div>
                </div>
                <div class="post-content-area" id="content-${p.id}">
                    ${p.content}
                </div>
            </div>`; 
        }); 
        list.innerHTML = html; 
    }

    loadProfile();
  </script>
</body>
</html>
