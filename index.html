<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>The Messy Nostalgia</title>
  <link href="https://cdn.jsdelivr.net/npm/galmuri@latest/dist/galmuri.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.ckeditor.com/4.22.1/standard/ckeditor.js"></script>

  <style>
    /* === ğŸ©¸ ê¸°ë³¸ ì„¤ì • === */
    body { background-color: #000; color: #ccc; font-family: 'Galmuri9', 'ê¶ì„œ', serif; margin: 0; padding: 0; overflow: hidden; cursor: crosshair; }
    
    /* === ğŸ’» ì¢Œì¸¡ ì‹œìŠ¤í…œ ë©”ë‰´ë°” === */
    #left-taskbar { position: fixed; top: 0; left: 0; width: 80px; height: 100vh; background: #2c3e50; border-right: 3px solid #1a252f; display: flex; flex-direction: column; align-items: center; padding-top: 30px; z-index: 1000; box-shadow: inset -2px -2px 0px rgba(0,0,0,0.5); }
    .task-icon { width: 60px; height: 70px; margin-bottom: 25px; text-align: center; cursor: pointer; font-size: 11px; color: #bdc3c7; font-weight: bold; transition: 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .task-icon div { font-size: 28px; margin-bottom: 5px; transition: 0.2s; }
    .task-icon:hover { color: #f1c40f; } .task-icon:hover div { transform: scale(1.1); }

    /* === ğŸŒŒ ì°¨ì› ì»¨í…Œì´ë„ˆ === */
    #world-container { position: absolute; top: 0; left: 80px; width: calc(100vw - 80px); height: 100vh; overflow: hidden; }
    .world-view { display: none; width: 100%; height: 100%; position: relative; }
    .world-view.active { display: block; }

    /* === [ì°¨ì› 1] ë¡œë¹„: ë…¸ë€ì¥íŒ ì§€ì˜¥ (ë°€ë„ ê°•í™”) === */
    #view-room { background: linear-gradient(to bottom, #eee 0%, #ddd 55%, #dcb35a 55%, #b28936 100%); }
    .diy-obj { position: absolute; z-index: 5; pointer-events: none; filter: drop-shadow(5px 5px 10px rgba(0,0,0,0.4)); object-fit: contain; }
    .obj-window { top: 10%; left: 35%; width: 220px; opacity: 0.8; }
    .obj-closet { bottom: 40%; right: 10%; width: 160px; }
    .obj-bedding { bottom: 10%; left: 10%; width: 380px; z-index: 10; }
    .obj-mold { position: absolute; bottom: 45%; left: 5%; width: 300px; height: 300px; background: radial-gradient(circle, rgba(0,0,0,0.4) 0%, rgba(0,0,0,0) 70%); z-index: 1; pointer-events: none; mix-blend-mode: multiply; }
    
    /* ì¥íŒ ìœ„ ì“°ë ˆê¸° ë„íŠ¸ë“¤ (ë°€ë„ìš©) */
    .trash-dot { position: absolute; z-index: 2; pointer-events: none; opacity: 0.8; image-rendering: pixelated; }

    /* í˜•ê´‘ë“± ìŠ¤ìœ„ì¹˜ */
    .light-switch { position: absolute; top: 35%; left: 3%; width: 40px; height: 60px; background: #eceff1; border: 3px solid #cfd8dc; cursor: pointer; z-index: 100; box-shadow: 3px 3px 5px rgba(0,0,0,0.3); display: flex; justify-content: center; align-items: center; }
    .switch-knob { width: 15px; height: 30px; background: #fff; border: 1px solid #b0bec5; transition: 0.1s; }
    .light-switch:active .switch-knob { transform: translateY(5px); }
    @keyframes flickerAnim { 0%, 100% { filter: brightness(1); } 10%, 30% { filter: brightness(0.2); } 20% { filter: brightness(1.2); } }
    .room-flicker { animation: flickerAnim 0.5s linear; }

    /* === [ì°¨ì› 2] ì¶˜ì²œí–‰ ê¸°ì°¨ì—­ (ì•„ë ¨í•œ ì¶”ì–µ) === */
    #view-station { 
        background: linear-gradient(to bottom, #2c3e50, #4a00e0, #ff0099, #feb47b); 
        overflow: hidden;
    }
    .station-fog { position: absolute; width: 200%; height: 100%; background: url('https://www.transparenttextures.com/patterns/fog.png'); opacity: 0.3; animation: fogMove 60s linear infinite; pointer-events: none; }
    @keyframes fogMove { from { transform: translateX(0); } to { transform: translateX(-50%); } }

    /* êµ´ëšê³¼ ì—°ê¸° */
    .chimney-container { position: absolute; bottom: 30%; right: 15%; width: 60px; height: 200px; z-index: 5; }
    .chimney { width: 100%; height: 100%; background: #333; border: 4px solid #111; position: relative; }
    .chimney-smoke { position: absolute; top: -20px; left: 50%; width: 10px; height: 10px; background: rgba(200,200,200,0.6); border-radius: 50%; filter: blur(5px); animation: smokeUp 3s infinite; }
    @keyframes smokeUp { 0% { transform: translate(-50%, 0) scale(1); opacity: 0.8; } 100% { transform: translate(50px, -150px) scale(4); opacity: 0; } }

    /* ê¸°ì°¨ ì• ë‹ˆë©”ì´ì…˜ */
    .train-sprite { position: absolute; bottom: 15%; left: -500px; width: 400px; font-size: 40px; color: #000; z-index: 10; filter: drop-shadow(0 0 10px rgba(0,0,0,0.5)); animation: trainPass 20s linear infinite; animation-delay: 5s;}
    @keyframes trainPass { 0% { left: -500px; } 100% { left: 120%; } }

    /* ì² ê¸¸ ê±·ëŠ” ì‚¬ëŒ */
    .walking-man { position: absolute; bottom: 12%; left: 30%; font-size: 30px; animation: walkPause 15s infinite; z-index: 9; opacity: 0.7;}
    @keyframes walkPause { 0%, 100% { transform: translateX(0); } 50% { transform: translateX(50px); } }

    /* === [ì°¨ì› 3] ì•„ì¿ ì•„ë¦¬ì›€ === */
    #view-aqua { background: linear-gradient(to bottom, #001f3f, #0074d9); overflow: hidden; }
    .aqua-obj { position: absolute; pointer-events: none; z-index: 5; animation: floatSwim linear infinite; font-size: 80px; }
    @keyframes floatSwim { 0% { transform: translateX(0) rotate(5deg); } 100% { transform: translateX(120vw) rotate(-5deg); } }

    /* === ğŸ€ í”½ì…€-ì˜¤ë¸Œì œ ë²„íŠ¼ (ë°°ê²½ ì‚­ì œ & ê³ í•´ìƒë„ í…ìŠ¤íŠ¸) === */
    .scattered-btn {
        position: absolute; background: transparent; border: none; 
        color: #fff; font-size: 13px; font-family: 'Galmuri9'; font-weight: bold;
        text-shadow: 2px 2px 0px #000, -1px -1px 0px #000, 1px -1px 0px #000, -1px 1px 0px #000, 1px 1px 0px #000;
        display: flex; flex-direction: column; align-items: center; gap: 5px;
        z-index: 999 !important; pointer-events: auto !important; cursor: pointer !important;
        transition: 0.2s; outline: none;
    }
    .scattered-btn div { font-size: 40px; filter: drop-shadow(3px 3px 0px #000); transition: 0.15s; }
    .scattered-btn:hover div { transform: scale(1.2) rotate(5deg); filter: brightness(1.2); }
    .scattered-btn:active div { transform: scale(0.9); }

    /* ë²„íŠ¼ ë°°ì¹˜ (ë¡œë¹„: ì“°ë ˆê¸°ë”ë¯¸ ì‚¬ì´) */
    .btn-diary  { top: 55%; left: 45%; } 
    .btn-char   { top: 75%; left: 35%; }
    .btn-review { top: 60%; left: 65%; } 
    .btn-write  { top: 82%; left: 50%; }
    .btn-shop   { top: 75%; left: 80%; }
    .btn-verify { top: 20%; right: 15%; } 
    .btn-setting{ top: 85%; right: 10%; } 

    /* ê¸°ì°¨ì—­ ì „ìš©: ìš°ì²´í†µ ë°©ëª…ë¡ */
    .btn-mailbox { bottom: 10%; right: 10%; }

    /* === ğŸ’» ê³µí†µ íŒì—…ì°½ === */
    .cute-popup { position: absolute; display: none; background: rgba(20,20,20,0.98); border: 2px solid #555; box-shadow: 20px 20px 0px rgba(0,0,0,0.6); overflow: hidden; width: 450px; color: #ecf0f1; z-index: 1100;}
    .cute-titlebar { background: #34495e; color: #fff; padding: 8px 12px; font-weight: bold; font-size: 12px; display: flex; justify-content: space-between; align-items: center; user-select: none; cursor: grab; border-bottom: 2px solid #1a252f; font-family: 'Galmuri9';}
    .cute-title-btns span { display: inline-block; width: 14px; height: 14px; background: #e74c3c; border: 2px outset #c0392b; cursor: pointer; border-radius: 50%;}
    .cute-body { padding: 15px; max-height: 65vh; overflow-y: auto; background: #2c3e50;}

    /* íŒì—… ì´ˆê¸° ìœ„ì¹˜ */
    #write-window { width: 700px; top: 10%; left: 15%; }
    #board-window { width: 600px; top: 15%; left: 20%; }
    #ai-window { width: 320px; top: 40%; right: 5%; } 

    /* === ğŸ¾ ì‹œë©”ì§€ === */
    #shimeji-room { position: absolute; bottom: 25%; right: 5%; z-index: 998; text-align: center; cursor: grab; transition: top 1.5s linear, left 1.5s linear; }
    #pet-bubble { background: #fff; border: 2px solid #000; padding: 5px; font-size: 11px; color: #000; margin-bottom: 5px; opacity:0; transition: opacity 0.3s; font-weight: bold;}
    .css-pet { width: 70px; height: 70px; background: #fff; border: 3px solid #000; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 18px; font-weight: bold; color: #000; box-shadow: 5px 5px 0px rgba(0,0,0,0.5); transform: scaleX(var(--flip, 1)); background-size: cover; background-position: center; cursor: pointer;}
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
    .is-walking { animation: bounce 0.3s infinite; }

    /* ê²Œì‹œíŒ ë¦¬ìŠ¤íŠ¸ */
    .post-item { margin-bottom: 10px; border: 2px solid #7f8c8d; background: #2c3e50; color: #fff;}
    .post-header { padding: 10px 12px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border-bottom: 1px solid #1a252f;}
    .post-content-area { padding: 15px; display: none; background: #34495e;}

    /* === ğŸ¬ ëŒê³ ë˜ ì•„ì¼€ì´ë“œ === */
    #dolphin-game-area { width: 300px; height: 350px; background: linear-gradient(to bottom, #0288d1, #00838f); border: 5px inset #006064; margin: 0 auto; position: relative; overflow: hidden; }
    .ring { width: 28px; height: 28px; border: 6px solid; border-radius: 50%; position: absolute; transition: top 0.1s ease-out, left 0.1s ease-out; background: rgba(255,255,255,0.2);}
    .post { width: 12px; height: 130px; background: linear-gradient(to right, #ff7043, #bf360c); position: absolute; bottom: 0; border-radius: 6px 6px 0 0; border: 2px solid #000;}
    .pump-btn { width: 60px; height: 60px; background: #26c6da; border: 4px outset #80deea; border-radius: 50%; cursor: pointer; font-size: 20px; font-weight: bold;}
    #dolphin-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 20; color: #fff; text-align: center; }

    /* ì•”ì‹œì¥ ë‚™í•˜ë¬¼ */
    #item-drop-zone { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; overflow: hidden;}
    .dropped-item { position: absolute; font-size: 35px; filter: drop-shadow(3px 3px 5px rgba(0,0,0,0.7)); animation: itemFall 0.8s forwards; }
    @keyframes itemFall { 0% { transform: translateY(-100px) rotate(-360deg); opacity:0; } 100% { transform: translateY(0) rotate(0deg); opacity:1; } }
    #custom-tooltip { position: absolute; display: none; z-index: 2000; background: #fff; border: 2px solid #000; padding: 5px 10px; font-size: 11px; font-family: 'Galmuri9'; color: #000; pointer-events: none; white-space: nowrap; box-shadow: 4px 4px 0px rgba(0,0,0,0.5); font-weight: bold;}
  </style>
</head>
<body id="main-body">

  <div id="world-container">
      
      <div id="view-room" class="world-view active">
          <div id="item-drop-zone"></div>
          
          <img id="diy-window" class="diy-obj obj-window" src="https://cdn.pixabay.com/photo/2013/07/12/17/58/window-152746_1280.png">
          <img id="diy-closet" class="diy-obj obj-closet" src="https://cdn.pixabay.com/photo/2014/12/21/23/58/wardrobe-576405_1280.png">
          <img id="diy-bedding" class="diy-obj obj-bedding" src="https://cdn.pixabay.com/photo/2017/01/14/10/57/bed-1979261_1280.png">
          <div class="obj-mold"></div>
          
          <div class="light-switch" onclick="flickerRoom()" data-tooltip="ë”¸ê¹!">
              <div class="switch-knob"></div>
          </div>

          <div class="main-pic-container" style="position:absolute; top:10%; left:5%; width:25%; height:40%; background:#000; border:4px solid #333; z-index:10; transform:rotate(-3deg);"><img id="main-visual-img" src="https://cdn.pixabay.com/photo/2020/04/18/16/24/pixel-art-5059880_1280.png" style="width:100%; height:100%; object-fit:cover;"></div>

          <button class="scattered-btn btn-diary" onclick="openBoard('diary')"><div>ğŸ““</div><span>ë°ìŠ¤ ë…¸íŠ¸</span></button>
          <button class="scattered-btn btn-char" onclick="openBoard('character')"><div>âœ¨</div><span>í˜ë¥´ì†Œë‚˜</span></button>
          <button class="scattered-btn btn-review" onclick="openBoard('review')"><div>ğŸ¬</div><span>ëª©ê²©ë‹´</span></button>
          <button class="scattered-btn btn-write" onclick="openWrite()"><div>âœï¸</div><span>ê¸°ë¡í•˜ë¼</span></button>
          <button class="scattered-btn btn-verify" onclick="openPopup('captcha-window')"><div>ğŸ’Š</div><span>ë³´ì•ˆ ì¸ì¦</span></button>
          <button class="scattered-btn btn-setting" onclick="openPopup('profile-window')"><div>âš™ï¸</div><span>í˜„ì¥ ì¡°ì‘</span></button>
          <button class="scattered-btn btn-shop" onclick="openPopup('shop-window')"><div>ğŸ›’</div><span>ì•”ì‹œì¥</span></button>
      </div>

      <div id="view-station" class="world-view">
          <div class="station-fog"></div>
          <div class="station-text">ì¶˜ì²œê°€ëŠ” ê¸°ì°¨ëŠ”... <br><small style="font-size:14px; opacity:0.6;">ë‚˜ë¥¼ ì–´ë””ë¡œ ë°ë ¤ê°€ëŠ”ê°€</small></div>
          <div class="train-track" style="position:absolute; bottom:0; width:100%; height:200px; background:repeating-linear-gradient(90deg, #222 0px, #222 20px, transparent 20px, transparent 60px), #111; border-top:10px solid #444; transform:perspective(500px) rotateX(45deg);"></div>
          
          <div class="chimney-container">
              <div class="chimney"></div>
              <div class="chimney-smoke" style="animation-delay: 0s;"></div>
              <div class="chimney-smoke" style="animation-delay: 1s;"></div>
              <div class="chimney-smoke" style="animation-delay: 2s;"></div>
          </div>

          <div class="train-sprite">ğŸš‚ğŸšƒğŸšƒğŸšƒ...</div>
          <div class="walking-man">ğŸš¶...</div>

          <button class="scattered-btn btn-mailbox" onclick="openBoard('guestbook')">
              <div style="font-size:60px;">ğŸ“®</div>
              <span style="color:#ffeb3b;">ì¶”ì–µì˜ ìš°ì²´í†µ</span>
          </button>
      </div>

      <div id="view-aqua" class="world-view">
          <div class="aqua-obj" style="top:20%; left:-20%; animation-duration:25s;">ğŸ </div>
          <div class="aqua-obj" style="top:60%; right:-20%; animation-duration:35s; transform:scaleX(-1); animation-direction:reverse;">ğŸ¦ˆ</div>
          <button class="scattered-btn" style="top:50%; left:50%; transform:translate(-50%,-50%);" onclick="openPopup('dolphin-window')">
              <div style="font-size:80px;">ğŸ¬</div>
              <span style="font-size:18px; color:#00bcd4;">ì‹¬í•´ ì˜¤ë½ê¸°</span>
          </button>
      </div>

      <div id="shimeji-room" data-tooltip="ë”ë¸”í´ë¦­ ì´ë™">
          <div id="pet-bubble">ë°¥ ì¤˜...</div>
          <div id="pet-image" class="css-pet" onclick="openPopup('ai-window')" ondblclick="toggleRoaming()">( Âº â–² Âº )</div>
      </div>

  </div>

  <div id="left-taskbar">
      <div class="task-icon" onclick="switchWorld('view-room')" data-tooltip="ë‚´ ë°©"><div>ğŸšª</div>Room</div>
      <div class="task-icon" onclick="switchWorld('view-station')" data-tooltip="ê¸°ì°¨ì—­"><div>ğŸš‚</div>Station</div>
      <div class="task-icon" onclick="switchWorld('view-aqua')" data-tooltip="ì•„ì¿ ì•„ë¦¬ì›€"><div>ğŸŒŠ</div>Aqua</div>
      <hr style="width: 60%; border-color: #1a252f; margin: 15px 0;">
      <div class="task-icon" onclick="openPopup('music-window')" data-tooltip="ì¹´ì„¸íŠ¸"><div>ğŸ“»</div>Music</div>
      <div class="task-icon" onclick="openPopup('ai-window')" data-tooltip="ë©”ì‹ ì €"><div>ğŸ’¬</div>Chat</div>
  </div>

  <div id="custom-tooltip">ë§í’ì„ </div>

  <div id="captcha-window" class="cute-popup"><div class="cute-titlebar" id="captcha-drag"><span>âš ï¸ ë³´ì•ˆ ì‹œìŠ¤í…œ</span><div class="cute-title-btns"><span onclick="closePopup('captcha-window')"></span></div></div><div class="cute-body" style="text-align:center;"><p>'ë”°ëœ»í•¨'ì„ ê³ ë¥´ì‹œì˜¤.</p><div style="display:grid; grid-template-columns:repeat(3,1fr); gap:5px; margin-bottom:15px;"><div style="height:70px; background:url('https://cdn.pixabay.com/photo/2014/11/30/14/11/cat-551554_1280.jpg') center/cover;"></div><div style="height:70px; background:url('https://cdn.pixabay.com/photo/2017/08/06/09/52/blanket-2591473_1280.png') center/cover;"></div><div style="height:70px; background:url('https://cdn.pixabay.com/photo/2015/12/01/20/28/road-1072821_1280.jpg') center/cover;"></div></div><button class="btn-action" onclick="closePopup('captcha-window')">[ ì¸ì¦ ]</button></div></div>
  <div id="dolphin-window" class="cute-popup"><div class="cute-titlebar" id="dolphin-drag"><span>ğŸ¬ ë§ ë˜ì§€ê¸°.exe</span><div class="cute-title-btns"><span onclick="closePopup('dolphin-window')"></span></div></div><div class="cute-body"><div id="dolphin-ui-top"><span id="d-time">â³ 30ì´ˆ</span><span id="d-score">ğŸ† 0ê°œ</span></div><div id="dolphin-game-area"><div id="dolphin-overlay"><div id="dolphin-msg">COIN INSERT</div><button id="dolphin-start-btn" class="btn-action" style="margin-top:20px; background:#00bcd4; color:#000;" onclick="startDolphinGame()">â–¶ START</button></div><div class="post" style="left:65px;"></div><div class="post" style="right:65px;"></div><div class="ring" id="ring0" style="border-color:#e91e63;"></div><div class="ring" id="ring1" style="border-color:#9c27b0;"></div><div class="ring" id="ring2" style="border-color:#ffeb3b;"></div><div class="ring" id="ring3" style="border-color:#4caf50;"></div><div class="ring" id="ring4" style="border-color:#ff9800;"></div></div><div style="display:flex; justify-content:space-between; margin-top:15px;"><button class="pump-btn" onclick="pushRings('left')">L</button><button class="pump-btn" onclick="pushRings('right')">R</button></div></div></div>
  <div id="music-window" class="cute-popup"><div class="cute-titlebar" id="music-drag"><span>ğŸ“» Cassette</span><div class="cute-title-btns"><span onclick="closePopup('music-window')"></span></div></div><div class="cute-body"><div class="player-controls"><button class="ctrl-btn" onclick="prevTrack()">â®</button><button class="ctrl-btn" id="play-btn" onclick="togglePlay()">â–¶</button><button class="ctrl-btn" onclick="nextTrack()">â­</button></div><marquee class="music-info" id="now-playing-text">Tape Waiting...</marquee></div></div>
  <div id="board-window" class="cute-popup"><div class="cute-titlebar" id="board-drag"><span id="board-title">ğŸ€ Board</span><div class="cute-title-btns"><span onclick="closePopup('board-window')"></span></div></div><div class="cute-body" id="page-content">Loading...</div></div>
  <div id="write-window" class="cute-popup"><div class="cute-titlebar" id="write-drag"><span>ğŸ“ Notepad</span><div class="cute-title-btns"><span onclick="closePopup('write-window')"></span></div></div><div class="cute-body"><div class="input-row" style="flex-direction:row; justify-content:space-between;"><select id="post-category" class="cute-input"><option value="diary">ğŸ““ ë¹„ë°€ ì¼ê¸°</option><option value="character">âœ¨ ìºë¦­í„° ë±</option><option value="review">ğŸ¬ ë¦¬ë·° ë…¸íŠ¸</option><option value="guestbook">ğŸ“ ë°©ëª…ë¡</option></select><label for="local-img-upload" class="btn-action" style="cursor:pointer;">ğŸ–¼ï¸ ì‚¬ì§„ ì²¨ë¶€</label><input type="file" id="local-img-upload" style="display:none;" onchange="insertLocalImageToEditor(this)"></div><input type="text" id="post-title" class="cute-input" placeholder="ì œëª©..."><textarea id="post-content"></textarea><div style="text-align:right; margin-top:15px;"><button class="btn-action" onclick="savePost()">ì €ì¥</button></div></div></div>
  <div id="ai-window" class="cute-popup"><div class="cute-titlebar" id="ai-drag"><span>ğŸ’¬ Messenger</span><div class="cute-title-btns"><span onclick="closePopup('ai-window')"></span></div></div><div class="cute-body"><div class="chat-body" id="chat-log"><div class="msg-row msg-ai">ë‚˜ë£¨: (...)</div></div><div style="display:flex; gap:5px; margin-top:10px;"><input type="text" id="ai-input" class="cute-input" style="flex:1;" onkeypress="if(event.key==='Enter') sendMsg()"><button class="btn-action" onclick="sendMsg()">ì „ì†¡</button></div></div></div>
  <div id="profile-window" class="cute-popup"><div class="cute-titlebar" id="profile-drag"><span>âš™ï¸ Control Panel</span><div class="cute-title-btns"><span onclick="closePopup('profile-window')"></span></div></div><div class="cute-body"><p style="font-size:11px; color:#f1c40f;">ìš©ëŸ‰ 1MB ì´í•˜ì˜ PNG ê¶Œì¥!</p><div class="input-row"><label>ğŸªŸ ì°½ë¬¸</label><input type="file" id="edit-window-file" class="cute-input"></div><div class="input-row"><label>ğŸšª ì˜·ì¥</label><input type="file" id="edit-closet-file" class="cute-input"></div><div class="input-row"><label>ğŸ›ï¸ ì´ë¶ˆ</label><input type="file" id="edit-bedding-file" class="cute-input"></div><div class="input-row"><label>ğŸ¾ í«</label><input type="file" id="edit-pet-file" class="cute-input"></div><div class="input-row"><label>ğŸµ BGM</label><textarea id="edit-bgm" class="cute-input" rows="2"></textarea></div><div style="text-align:right;"><button class="btn-action" onclick="saveProfile()">ì ìš©</button></div></div></div>
  <div id="shop-window" class="cute-popup"><div class="cute-titlebar" id="shop-drag"><span>ğŸ›’ Black Market</span><div class="cute-title-btns"><span onclick="closePopup('shop-window')"></span></div></div><div class="cute-body" style="text-align:center;"><h3 id="my-money">0 P</h3><div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap;"><button class="btn-action" onclick="buyItem('ì†Œì£¼', 'ğŸ¾', 100)">ğŸ¾(100P)</button><button class="btn-action" onclick="buyItem('ë‹´ë°°', 'ğŸš¬', 200)">ğŸš¬(200P)</button><button class="btn-action" onclick="buyItem('ì¹¼', 'ğŸ”ª', 300)">ğŸ”ª(300P)</button></div><div style="text-align:right; margin-top:10px;"><button class="btn-action" style="background:#c0392b;" onclick="clearRoomItems()">ì²­ì†Œ</button></div></div></div>

  <div id="yt-player-container" style="display:none;"></div>

  <script>
    /* ğŸ”´ ì‚¬ìš´ë“œ ë° ì°¨ì› ì œì–´ */
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playClickSound() { if(audioCtx.state === 'suspended') audioCtx.resume(); const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = 'square'; osc.frequency.setValueAtTime(600, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.1); gain.gain.setValueAtTime(0.05, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0, audioCtx.currentTime + 0.1); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.1); }
    function playPopupSound() { if(audioCtx.state === 'suspended') audioCtx.resume(); const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = 'sine'; osc.frequency.setValueAtTime(300, audioCtx.currentTime); osc.frequency.linearRampToValueAtTime(600, audioCtx.currentTime + 0.1); gain.gain.setValueAtTime(0, audioCtx.currentTime); gain.gain.linearRampToValueAtTime(0.1, audioCtx.currentTime + 0.05); gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.1); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.1); }
    document.addEventListener('click', (e) => { if(e.target.closest('button') || e.target.closest('.task-icon') || e.target.closest('.light-switch')) playClickSound(); });

    function switchWorld(viewId) { document.querySelectorAll('.world-view').forEach(el => el.classList.remove('active')); document.getElementById(viewId).classList.add('active'); playPopupSound(); }
    function flickerRoom() { const room = document.getElementById('view-room'); room.classList.remove('room-flicker'); void room.offsetWidth; room.classList.add('room-flicker'); }

    /* ğŸ”´ ë°€ë„ìš© ì“°ë ˆê¸° ë„íŠ¸ ìƒì„± (ë¡œë¹„ í•œì •) */
    const trashIcons = ['ğŸš¬', 'ğŸ¥«', 'ğŸ¾', 'ğŸ¥¡', 'ğŸ§¦', 'ğŸª³', 'ğŸ’¨'];
    function populateTrash() {
        const room = document.getElementById('view-room');
        for(let i=0; i<40; i++) {
            const el = document.createElement('div'); el.className = 'trash-dot';
            el.innerText = trashIcons[Math.floor(Math.random() * trashIcons.length)];
            el.style.left = Math.random() * 95 + '%'; el.style.top = (55 + Math.random() * 40) + '%';
            el.style.fontSize = (Math.random() * 15 + 10) + 'px';
            el.style.transform = `rotate(${Math.random() * 360}deg)`;
            room.appendChild(el);
        }
    }
    populateTrash();

    /* Supabase ì„¤ì • */
    const SB_URL = "https://kzgbqpodvpuoqovfsyrm.supabase.co";
    const SB_KEY = "sb_publishable_pdqE1Sc-4PSv3LQM9IsBcA_xJWeZwW-"; 
    const OPENROUTER_KEY = "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"; 
    let sbClient = null; if (window.supabase) sbClient = window.supabase.createClient(SB_URL, SB_KEY);
    CKEDITOR.replace('post-content', { height: 200, language: 'ko', removeButtons: 'About', versionCheck: false });

    /* íŒì—… ì œì–´ */
    let highestZ = 2000;
    function makeDraggable(winId, dragId) { const win = document.getElementById(winId); const dragArea = document.getElementById(dragId); let p1=0, p2=0, p3=0, p4=0; win.onmousedown = () => win.style.zIndex = ++highestZ; dragArea.onmousedown = (e) => { e.preventDefault(); p3=e.clientX; p4=e.clientY; document.onmouseup = () => { document.onmouseup=null; document.onmousemove=null; }; document.onmousemove = (e) => { e.preventDefault(); p1=p3-e.clientX; p2=p4-e.clientY; p3=e.clientX; p4=e.clientY; win.style.top=(win.offsetTop-p2)+"px"; win.style.left=(win.offsetLeft-p1)+"px"; }; }; }
    ['write-window','board-window','ai-window','profile-window','shop-window','music-window','shimeji-room','dolphin-window', 'captcha-window'].forEach(id => { makeDraggable(id, id === 'shimeji-room' ? id : id.replace('window', 'drag')); });
    function openPopup(id) { playPopupSound(); const el = document.getElementById(id); el.style.display = 'block'; el.style.zIndex = ++highestZ; }
    function closePopup(id) { document.getElementById(id).style.display = 'none'; }

    /* ëŒê³ ë˜ ê²Œì„ */
    const rings = [document.getElementById('ring0'), document.getElementById('ring1'), document.getElementById('ring2'), document.getElementById('ring3'), document.getElementById('ring4')];
    let ringStates = [], dTime=30, dScore=0, dState='ready', dTimer=null, gameLoop=null;
    function resetRings() { ringStates = rings.map((r,i) => ({ x: 40+(i*50), y: 300, vy:0, vx:0, stuck:false, scored:false })); rings.forEach((r,i) => { r.style.top='300px'; r.style.left=ringStates[i].x+'px'; }); }
    resetRings();
    function startDolphinGame() { dState='playing'; dTime=30; dScore=0; document.getElementById('d-score').innerText='ğŸ† 0ê°œ'; document.getElementById('dolphin-overlay').style.display='none'; resetRings(); if(dTimer) clearInterval(dTimer); dTimer=setInterval(()=>{ dTime--; document.getElementById('d-time').innerText=`â³ ${dTime}ì´ˆ`; if(dTime<=0) endGame(false); },1000); if(!gameLoop) updateGame(); }
    function endGame(isWin) { dState='over'; clearInterval(dTimer); cancelAnimationFrame(gameLoop); gameLoop=null; const msg=document.getElementById('dolphin-msg'); if(isWin) { msg.innerText='âœ¨ SUCCESS! âœ¨\n+100P'; earnPoints(100); } else msg.innerText='GAME OVER'; document.getElementById('dolphin-overlay').style.display='flex'; document.getElementById('dolphin-start-btn').innerText='â–¶ RETRY'; }
    function updateGame() { if(dState!=='playing') return; rings.forEach((ring,i) => { let s=ringStates[i]; if(s.stuck) return; s.vy+=0.4; s.y+=s.vy; s.x+=s.vx; s.vx*=0.95; if(s.y>300){ s.y=300; s.vy*=-0.5; } if(s.x<10 || s.x>260) s.vx*=-0.8; if(s.y>170 && s.y<250 && s.vy>0){ if(Math.abs(s.x-65)<12 || Math.abs(s.x-225)<12){ s.stuck=true; s.y=260-(dScore*12); s.x=Math.abs(s.x-65)<12?65:225; if(!s.scored){ s.scored=true; dScore++; document.getElementById('d-score').innerText=`ğŸ† ${dScore}ê°œ`; } } } ring.style.top=s.y+'px'; ring.style.left=s.x+'px'; }); if(dScore>=5) { endGame(true); return; } gameLoop=requestAnimationFrame(updateGame); }
    function pushRings(side) { if(dState!=='playing') return; rings.forEach(s => { if(!s.stuck) { ringStates[rings.indexOf(s)].vy=-Math.random()*8-4; ringStates[rings.indexOf(s)].vx+=(side==='left'?1:-1)*(Math.random()*4+2); } }); }

    /* ì•”ì‹œì¥ ë° í¬ì¸íŠ¸ */
    let myMoney = parseInt(localStorage.getItem('myPoints') || '1000'); let roomItems = JSON.parse(localStorage.getItem('myRoomItems') || '[]');
    function updateMoneyDisplay() { document.getElementById('my-money').innerText = myMoney + ' P'; localStorage.setItem('myPoints', myMoney); }
    function earnPoints(a) { myMoney += a; updateMoneyDisplay(); } updateMoneyDisplay();
    function buyItem(n, i, p) { if(myMoney<p) return alert("ìê¸ˆ ë¶€ì¡±..."); myMoney-=p; updateMoneyDisplay(); roomItems.push({ icon:i, x:Math.floor(Math.random()*80)+10, y:Math.floor(Math.random()*40)+55 }); localStorage.setItem('myRoomItems', JSON.stringify(roomItems)); renderRoomItems(); }
    function renderRoomItems() { const layer=document.getElementById('item-drop-zone'); layer.innerHTML=''; roomItems.forEach(item => { const el=document.createElement('div'); el.className='dropped-item'; el.style.left=item.x+'%'; el.style.top=item.y+'%'; el.innerText=item.icon; layer.appendChild(el); }); }
    function clearRoomItems() { roomItems=[]; localStorage.setItem('myRoomItems','[]'); renderRoomItems(); } renderRoomItems();

    /* DIY ì´ë¯¸ì§€ ì‹œìŠ¤í…œ */
    let tPet='', tWin='', tCloset='', tBedding=''; let currentPlaylist=[];
    function handleFile(id, cb) { document.getElementById(id).addEventListener('change', e => { const file=e.target.files[0]; if(!file) return; if(file.size>1.5*1024*1024) return alert("1.5MB ì œí•œ!"); const r=new FileReader(); r.onload=evt=>cb(evt.target.result); r.readAsDataURL(file); }); }
    handleFile('edit-pet-file', r=>tPet=r); handleFile('edit-window-file', r=>tWin=r); handleFile('edit-closet-file', r=>tCloset=r); handleFile('edit-bedding-file', r=>tBedding=r);
    function loadProfile() { const s=JSON.parse(localStorage.getItem('diyRoomV4'))||{}; if(s.win) document.getElementById('diy-window').src=s.win; if(s.closet) document.getElementById('diy-closet').src=s.closet; if(s.bedding) document.getElementById('diy-bedding').src=s.bedding; const p=document.getElementById('pet-image'); if(s.pet){ p.style.backgroundImage=`url(${s.pet})`; p.innerText=''; } else p.innerText='( Âº â–² Âº )'; currentPlaylist=(s.bgm||'VDMiHYgQKLE').split(',').map(x=>x.trim()).filter(x=>x); tPet=s.pet||''; tWin=s.win||''; tCloset=s.closet||''; tBedding=s.bedding||''; }
    function saveProfile() { try { localStorage.setItem('diyRoomV4', JSON.stringify({ pet:tPet, win:tWin, closet:tCloset, bedding:tBedding, bgm:document.getElementById('edit-bgm').value })); } catch(e) { alert("ìš©ëŸ‰ ì´ˆê³¼!"); return; } loadProfile(); closePopup('profile-window'); }

    /* ê²Œì‹œíŒ & AI */
    async function loadPosts(type) { if(!sbClient) return; document.getElementById('board-title').innerText=type==='diary'?'ğŸ““ ë°ìŠ¤ ë…¸íŠ¸':type==='character'?'âœ¨ í˜ë¥´ì†Œë‚˜':type==='review'?'ğŸ¬ ëª©ê²©ë‹´':'ğŸ“ ìœ ì–¸ì¥'; const {data, error}=await sbClient.from('posts').select('*').eq('category', type).order('created_at', {ascending:false}); const list=document.getElementById('page-content'); if(error||data.length===0){ list.innerHTML="í…… ë¹„ì—ˆë‹¤..."; return; } globalPostsData=data; let h=''; data.forEach(p => { const d=new Date(p.created_at).toLocaleDateString(); h+=`<div class="post-item"><div class="post-header" onclick="this.nextSibling.style.display=this.nextSibling.style.display==='block'?'none':'block'"><span>ğŸ“‘ ${p.title} <small>${d}</small></span></div><div class="post-content-area">${p.content}</div></div>`; }); list.innerHTML=h; }
    async function sendMsg() { const i=document.getElementById('ai-input'), l=document.getElementById('chat-log'), t=i.value.trim(); if(!t) return; l.innerHTML+=`<div class="msg-row msg-me">${t}</div>`; i.value=''; l.scrollTop=l.scrollHeight; const res=await fetch("https://openrouter.ai/api/v1/chat/completions", { method:"POST", headers:{"Authorization":`Bearer ${OPENROUTER_KEY}`,"Content-Type":"application/json"}, body:JSON.stringify({"model":"mistralai/mistral-7b-instruct:free","messages":[{"role":"system","content":"í”¼íí•œ í«ì´ì•¼. ì§§ê²Œ ëŒ€ë‹µí•´."},{"role":"user","content":t}]}) }); const d=await res.json(); if(d.choices) l.innerHTML+=`<div class="msg-row msg-ai">ë‚˜ë£¨: ${d.choices[0].message.content}</div>`; l.scrollTop=l.scrollHeight; }

    loadProfile();
  </script>
</body>
</html>
