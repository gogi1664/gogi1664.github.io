<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"><!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>My Messy Collage Room</title>
  <link href="https://cdn.jsdelivr.net/npm/galmuri@latest/dist/galmuri.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.ckeditor.com/4.22.1/standard/ckeditor.js"></script>

  <style>
    /* === ğŸŒ¸ ì•„ë‚ ë¡œê·¸ ë‹¤ì´ì–´ë¦¬ ë°”íƒ•í™”ë©´ ğŸŒ¸ === */
    body { 
        background-color: #fdf5e6; 
        background-image: url('https://www.transparenttextures.com/patterns/cream-pixels.png');
        font-family: 'Galmuri9', sans-serif; 
        margin: 0; padding: 0; color: #4a4a4a; overflow-x: hidden;
    }
    .messy-canvas { position: relative; width: 100vw; height: 100vh; overflow: hidden; }

    /* === ğŸ–¼ï¸ ì¢Œì¸¡ì„ ì¥ì•…í•˜ëŠ” ê±°ëŒ€í•œ ë©”ì¸ ë£¸ === */
    .iso-room-container {
        position: absolute; top: 40px; left: 20px;
        width: 750px; height: 750px; /* í™”ë©´ ì ˆë°˜ ì´ìƒì„ ë®ëŠ” ê±°ëŒ€ ì‚¬ì´ì¦ˆ */
        z-index: 10; display: flex; justify-content: center; align-items: center; user-select: none;
        pointer-events: none; /* ë°°ê²½ì²˜ëŸ¼ ì·¨ê¸‰ */
    }
    .iso-room-container img { pointer-events: auto; } /* ì´ë¯¸ì§€ë§Œ í´ë¦­ ê°€ëŠ¥í•˜ê²Œ */
    .iso-room-img { 
        width: 100%; height: 100%; object-fit: contain; 
        filter: drop-shadow(10px 10px 15px rgba(0,0,0,0.15)); 
    }
    
    /* ìíŒê¸° ì•„ì´í…œì´ ë–¨ì–´ì§€ëŠ” ë ˆì´ì–´ */
    #room-items-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
    .room-item { position: absolute; font-size: 40px; filter: drop-shadow(3px 3px 0px rgba(0,0,0,0.2)); animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    @keyframes pop { 0% {transform: scale(0);} 100% {transform: scale(1);} }

    /* === ğŸ€ í©ì–´ì§„ ìŠ¤í‹°ì»¤ ë²„íŠ¼ë“¤ (ì£¼ì¸ë‹˜ ì‚¬ì§„ ì™„ë²½ ê³ ì¦) === */
    .scattered-btn {
        position: absolute; 
        background: #ffb6c1; /* ë”¸ê¸°ìš°ìœ ìƒ‰ */
        border: 3px dashed #fff; /* ê·€ì—¬ìš´ ì ì„  í…Œë‘ë¦¬ */
        border-radius: 30px; /* ì•Œì•½ ëª¨ì–‘ */
        padding: 10px 20px; font-weight: bold; color: #fff; font-size: 16px;
        text-shadow: 1px 1px 0px #d81b60;
        cursor: pointer; box-shadow: 4px 4px 0px rgba(216, 27, 96, 0.2); 
        z-index: 20; transition: 0.1s; user-select: none; white-space: nowrap;
    }
    .scattered-btn:hover { background: #ff99cc; transform: scale(1.05) rotate(0deg) !important; }
    .scattered-btn:active { transform: translate(3px, 3px) !important; box-shadow: none; }
    
    /* ë°© ìš°ì¸¡/í•˜ë‹¨ìœ¼ë¡œ íŒŒë¦¬ë–¼ì²˜ëŸ¼ ë‚œì¡í•˜ê²Œ ë°°ì¹˜ */
    .btn-home  { top: 80px; left: 780px; transform: rotate(12deg); }
    .btn-diary { top: 200px; left: 850px; transform: rotate(-8deg); background: #dda0dd; }
    .btn-char  { top: 350px; left: 800px; transform: rotate(5deg); background: #87cefa; }
    .btn-shop  { top: 520px; left: 750px; transform: rotate(-15deg); background: #ffeb3b; color:#d81b60; text-shadow:none; border-color:#d81b60;}
    .btn-write { top: 680px; left: 600px; transform: rotate(8deg); background: #ff7f50; font-size: 18px; padding: 12px 25px;}
    .btn-dolphin { top: 750px; left: 850px; transform: rotate(-5deg); background: #40e0d0; font-size: 20px; }

    /* === ğŸ’¬ ë§ˆìš°ìŠ¤ ë§í’ì„  === */
    #custom-tooltip {
        position: absolute; display: none; z-index: 9999999; background: #fff; border: 2px solid #ff69b4; border-radius: 15px;
        padding: 8px 15px; font-size: 12px; font-weight: bold; color: #ff69b4; box-shadow: 3px 3px 0px rgba(255, 105, 180, 0.3); pointer-events: none; white-space: nowrap;
    }

    /* === ğŸ’» íˆ¬ëª…í•˜ê³  ê·€ì—¬ìš´ íŒì—…ì°½ (Mac ìŠ¤íƒ€ì¼ ë³€í˜•) === */
    .cute-popup {
        position: absolute; display: none; background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(5px);
        border: 2px solid #ffb6c1; border-radius: 15px; box-shadow: 8px 8px 0px rgba(255, 182, 193, 0.5); overflow: hidden; width: 450px;
    }
    .cute-titlebar {
        background: #ffe4e1; color: #d81b60; padding: 10px 15px; font-weight: bold; font-size: 14px;
        display: flex; justify-content: space-between; align-items: center; user-select: none; cursor: grab; border-bottom: 2px dashed #ffb6c1;
    }
    .cute-titlebar:active { cursor: grabbing; }
    .cute-title-btns { display: flex; gap: 5px; }
    .cute-title-btns span { display: inline-block; width: 14px; height: 14px; border-radius: 50%; border: 1px solid #ffb6c1; cursor: pointer; }
    .btn-close { background: #ff69b4; } .btn-min { background: #ffeb3b; } .btn-max { background: #87cefa; }
    .cute-body { padding: 20px; max-height: 65vh; overflow-y: auto; }

    /* íŒì—… ì´ˆê¸° ë‚œì¡ ìœ„ì¹˜ */
    #write-window { width: 800px; top: 100px; left: 150px; }
    #board-window { width: 650px; top: 150px; left: 350px; }
    #ai-window { width: 320px; top: 300px; left: 800px; }
    #shop-window { width: 400px; top: 250px; left: 500px; }
    #music-window { width: 300px; top: 50px; left: 900px; display: block; }
    #profile-window { width: 450px; top: 100px; left: 400px;}
    #dolphin-window { width: 320px; top: 200px; left: 600px; border-color: #00acc1; }

    /* === ğŸ¾ ì‹œë©”ì§€ í« === */
    #shimeji-room {
        position: absolute; top: 600px; left: 250px; z-index: 30; text-align: center; cursor: grab; 
        transition: top 1.5s ease-in-out, left 1.5s ease-in-out;
    }
    #shimeji-room:active { cursor: grabbing; transition: none; }
    #pet-bubble { background: #fff; border: 2px solid #8a2be2; border-radius: 10px; padding: 6px; font-size: 12px; color: #8a2be2; font-weight: bold; margin-bottom: 5px; opacity:0; transition: opacity 0.3s;}
    #pet-image { width: 110px; height: 110px; object-fit: contain; filter: drop-shadow(2px 2px 0px rgba(0,0,0,0.2)); transform: scaleX(var(--flip, 1)); }
    @keyframes bounce { 0%, 100% { transform: translateY(0) scaleX(var(--flip, 1)); } 50% { transform: translateY(-20px) scaleX(var(--flip, 1)); } }
    .is-walking { animation: bounce 0.3s infinite; }

    /* === ğŸ“» ì¹´ì„¸íŠ¸ í”Œë ˆì´ì–´ === */
    .player-controls { display: flex; gap: 10px; justify-content: center; margin-bottom: 10px;}
    .ctrl-btn { background: #fff; border: 2px solid #ffb6c1; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 16px; color: #d81b60; box-shadow: 2px 2px 0px #ffb6c1; display:flex; justify-content:center; align-items:center;}
    .ctrl-btn:active { transform: translate(2px,2px); box-shadow:none;}
    .music-info { font-size: 12px; color: #d81b60; font-weight: bold; overflow: hidden; white-space: nowrap; text-align:center; background:#ffe4e1; padding:8px; border-radius:10px; border: 1px dashed #ffb6c1;}

    /* ê¸°íƒ€ UI ìš”ì†Œ */
    .input-row { display: flex; flex-direction: column; margin-bottom: 15px; }
    .input-row label { font-size: 12px; color: #d81b60; font-weight: bold; margin-bottom: 5px; }
    .cute-input { padding: 10px; border: 2px solid #ffb6c1; border-radius: 10px; font-family: 'Galmuri9'; outline: none; background: rgba(255,255,255,0.8);}
    .btn-action { font-family: 'Galmuri9'; font-size: 12px; padding: 8px 15px; cursor: pointer; border: 2px solid #ffb6c1; border-radius: 10px; background: #fff; color: #d81b60; font-weight: bold; box-shadow: 2px 2px 0px #ffb6c1;}
    .btn-action:active { transform:translate(2px,2px); box-shadow:none; }

    /* ì±—ë´‡ ë””ìì¸ */
    .chat-body { height: 250px; background: rgba(255,255,255,0.7); border: 2px dashed #ffb6c1; overflow-y: auto; padding: 15px; font-size: 13px; border-radius: 15px;}
    .msg-row { margin-bottom: 10px; line-height: 1.5; padding: 8px 12px; border-radius: 15px; max-width: 80%; width: fit-content; }
    .msg-ai { background: #ffe4e1; color: #d81b60; border-bottom-left-radius: 0; float: left; clear: both;}
    .msg-me { background: #e6e6fa; color: #4a148c; border-bottom-right-radius: 0; float: right; clear: both;}
    .msg-sys { text-align: center; color: #ff69b4; font-size: 11px; clear: both; width: 100%; max-width: none; background: transparent;}

    /* === ğŸ¬ ëŒê³ ë˜ ë§ë¼ìš°ê¸° ê²Œì„ === */
    #dolphin-game-area {
        width: 280px; height: 350px; background: linear-gradient(to bottom, #4fc3f7, #0288d1);
        border: 4px solid #00acc1; border-radius: 20px; margin: 0 auto; position: relative; overflow: hidden;
        box-shadow: inset 0 0 20px rgba(0,0,0,0.3);
    }
    .dolphin-deco { position: absolute; font-size: 40px; opacity: 0.8; user-select: none;}
    .ring { 
        width: 25px; height: 25px; border: 5px solid #ffeb3b; border-radius: 50%; position: absolute; 
        box-shadow: 2px 2px 5px rgba(0,0,0,0.3); transition: top 0.3s ease-out, left 0.3s ease-out;
    }
    .post {
        width: 10px; height: 120px; background: #ff5722; position: absolute; bottom: 0; border-radius: 5px 5px 0 0;
        box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
    }
    .pump-btn {
        width: 70px; height: 70px; background: #00bcd4; border: 4px solid #00838f; border-radius: 50%; cursor: pointer;
        font-size: 24px; color: #fff; box-shadow: 4px 4px 0px #006064; display: flex; justify-content: center; align-items: center;
        user-select: none;
    }
    .pump-btn:active { transform: scale(0.9); box-shadow: none; }
  </style>
</head>
<body id="main-body">

  <div id="custom-tooltip">ë§í’ì„ </div>

  <div class="messy-canvas" id="desktop-area">
    
    <div class="iso-room-container" data-tooltip="ê°€êµ¬ë¥¼ ì‚¬ë©´ ë°°ì¹˜ë©ë‹ˆë‹¤!">
        <img id="main-visual-img" src="https://cdn.pixabay.com/photo/2020/04/18/16/24/pixel-art-5059880_1280.png" class="iso-room-img">
        <div id="room-items-layer"></div>
    </div>

    <button class="scattered-btn btn-home" onclick="openPopup('profile-window')" data-tooltip="ë°°ê²½, ì‚¬ì§„, BGM ì„¤ì •">ğŸ› ï¸ ë°© ê¾¸ë¯¸ê¸°</button>
    <button class="scattered-btn btn-diary" onclick="openBoard('diary')" data-tooltip="ì•„ë¬´ë„ ëª¨ë¥´ëŠ” ì€ë°€í•œ ê³µê°„">ğŸ““ ë¹„ë°€ ì¼ê¸°</button>
    <button class="scattered-btn btn-char" onclick="openBoard('character')" data-tooltip="ë‚´ ì•ˆì˜ ë˜ ë‹¤ë¥¸ ìì•„ë“¤">âœ¨ ìºë¦­í„° ë±</button>
    <button class="scattered-btn btn-shop" onclick="openPopup('shop-window')" data-tooltip="ëˆì„ ë‚­ë¹„í•´ ë°©ì„ ê¾¸ë©°ë¼!">ğŸ›’ ìˆ˜ìƒí•œ ìíŒê¸°</button>
    <button class="scattered-btn btn-write" onclick="openWrite()" data-tooltip="ë‚´ PC ì‚¬ì§„ë„ ë°”ë¡œ ë„£ì„ ìˆ˜ ìˆìŒ!">âœï¸ ê¸€ì“°ê¸°</button>
    
    <button class="scattered-btn btn-dolphin" onclick="openPopup('dolphin-window')" data-tooltip="ì¶”ì–µì˜ ë§ ë˜ì§€ê¸° ê²Œì„ê¸°!">ğŸ¬ğŸ®</button>

    <div id="shimeji-room" data-tooltip="ë”ë¸” í´ë¦­í•˜ë©´ ë½ˆë½ˆë½ˆ ëŒì•„ë‹¤ë‹™ë‹ˆë‹¤!">
        <div id="pet-bubble">ì‹¬ì‹¬í•´!</div>
        <img id="pet-image" src="https://raw.githubusercontent.com/shimeji-ee/shimeji-ee.github.io/master/img/shime1.png" onclick="toggleChat()" ondblclick="toggleRoaming()">
        <div style="font-size: 10px; color:#d81b60; font-weight:bold; margin-top:5px; text-shadow:1px 1px #fff;" id="roam-status">ìƒíƒœ: [ëŒ€ê¸° ì¤‘]</div>
    </div>

    <div id="dolphin-window" class="cute-popup">
        <div class="cute-titlebar" id="dolphin-drag" style="background:#00acc1; color:#fff;">ğŸ¬ Water Game <div class="cute-title-btns"><span class="btn-close" onclick="closePopup('dolphin-window')"></span></div></div>
        <div class="cute-body" style="background:#e0f7fa; text-align:center;">
            <div id="dolphin-game-area">
                <div class="dolphin-deco" style="top:20px; left:20px;">ğŸ¬</div>
                <div class="dolphin-deco" style="bottom:50px; right:20px; transform:scaleX(-1);">ğŸ¬</div>
                <div class="post" style="left: 70px;"></div>
                <div class="post" style="right: 70px;"></div>
                <div class="ring" id="ring1" style="top:300px; left:50px; border-color:#ffeb3b;"></div>
                <div class="ring" id="ring2" style="top:300px; left:100px; border-color:#ff5722;"></div>
                <div class="ring" id="ring3" style="top:300px; left:150px; border-color:#4caf50;"></div>
                <div class="ring" id="ring4" style="top:300px; left:200px; border-color:#e91e63;"></div>
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 15px; align-items:center;">
                <button class="pump-btn" onclick="pushRings('left')" data-tooltip="ì™¼ìª½ ë¬¼ì‚´!">ğŸ‘ˆ</button>
                <div style="font-size:11px; color:#00838f; font-weight:bold;">ë²„íŠ¼ì„ ì—°íƒ€í•´<br>ê³ ë¦¬ì— ê±¸ì–´ë¼!</div>
                <button class="pump-btn" onclick="pushRings('right')" data-tooltip="ì˜¤ë¥¸ìª½ ë¬¼ì‚´!">ğŸ‘‰</button>
            </div>
        </div>
    </div>

    <div id="music-window" class="cute-popup">
        <div class="cute-titlebar" id="music-drag">ğŸ“» Cassette.exe <div class="cute-title-btns"><span class="btn-close" onclick="closePopup('music-window')"></span></div></div>
        <div class="cute-body" style="text-align:center;">
            <div class="player-controls">
                <button class="ctrl-btn" onclick="prevTrack()" data-tooltip="ì´ì „ ê³¡">â®</button>
                <button class="ctrl-btn" id="play-btn" onclick="togglePlay()" data-tooltip="ì¬ìƒ/ì •ì§€">â–¶</button>
                <button class="ctrl-btn" onclick="nextTrack()" data-tooltip="ë‹¤ìŒ ê³¡">â­</button>
            </div>
            <marquee class="music-info" scrollamount="4" id="now-playing-text">BGM ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</marquee>
        </div>
    </div>

    <div id="board-window" class="cute-popup">
        <div class="cute-titlebar" id="board-drag"><span id="board-title">ğŸ€ Board</span> <div class="cute-title-btns"><span class="btn-close" onclick="closePopup('board-window')"></span></div></div>
        <div class="cute-body" id="page-content">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>

    <div id="write-window" class="cute-popup">
        <div class="cute-titlebar" id="write-drag">ğŸ“ Editor.exe <div class="cute-title-btns"><span class="btn-close" onclick="closePopup('write-window')"></span></div></div>
        <div class="cute-body">
            <div class="input-row" style="flex-direction:row; align-items:center; justify-content:space-between;">
                <div style="display:flex; gap:10px; align-items:center;">
                    <label style="margin:0;">ì¹´í…Œê³ ë¦¬</label>
                    <select id="post-category" class="cute-input" style="width: 120px;"><option value="diary">ë¹„ë°€ ì¼ê¸°ì¥</option><option value="character">ìºë¦­í„° ë±</option></select>
                </div>
                <div>
                    <label for="local-img-upload" class="btn-action" style="cursor:pointer; background:#e6e6fa;">ğŸ–¼ï¸ ë‚´ ì‚¬ì§„ ì²¨ë¶€</label>
                    <input type="file" id="local-img-upload" accept="image/*" style="display:none;" onchange="insertLocalImageToEditor(this)">
                </div>
            </div>
            <div class="input-row"><input type="text" id="post-title" class="cute-input" placeholder="ì œëª©ì„ ì…ë ¥í•´..."></div>
            <textarea id="post-content"></textarea>
            <div style="text-align: right; margin-top: 15px;"><button class="btn-action" onclick="savePost()">ë””ìŠ¤ì¼“ì— ì €ì¥</button></div>
        </div>
    </div>

    <div id="ai-window" class="cute-popup">
        <div class="cute-titlebar" id="ai-drag">ğŸ’¬ ë©”ì‹ ì € <div class="cute-title-btns"><span class="btn-close" onclick="closePopup('ai-window')"></span></div></div>
        <div class="cute-body">
          <div class="chat-body" id="chat-log"><div class="msg-row msg-ai">ë‚˜ë£¨: ëƒ¥! </div></div>
          <div style="display:flex; gap:5px; margin-top:10px;">
              <input type="text" id="ai-input" class="cute-input" style="flex:1;" onkeypress="if(event.key==='Enter') sendMsg()">
              <button class="btn-action" onclick="sendMsg()">ì „ì†¡</button>
          </div>
        </div>
    </div>

    <div id="profile-window" class="cute-popup">
        <div class="cute-titlebar" id="profile-drag">ğŸ› ï¸ Setting <div class="cute-title-btns"><span class="btn-close" onclick="closePopup('profile-window')"></span></div></div>
        <div class="cute-body">
            <div class="input-row"><label>ë°”íƒ•í™”ë©´ ì‚¬ì§„</label><input type="file" id="edit-bg-file" class="cute-input"></div>
            <div class="input-row"><label>ë°”íƒ•í™”ë©´ í™•ëŒ€/ì¶•ì†Œ: <span id="bg-size-val">100</span>%</label><input type="range" id="edit-bg-size" min="10" max="300" value="100" oninput="document.getElementById('bg-size-val').innerText=this.value"></div>
            <hr style="border:1px dashed #ffb6c1;">
            <div class="input-row"><label>ê±°ëŒ€í•œ ë‚´ ë°© ì´ë¯¸ì§€ (íˆ¬ëª… PNG ì¶”ì²œ)</label><input type="file" id="edit-main-file" class="cute-input"></div>
            <div class="input-row"><label>í« ì´ë¯¸ì§€</label><input type="file" id="edit-pet-file" class="cute-input"></div>
            <div class="input-row"><label>BGM ì…”í”Œ ë¦¬ìŠ¤íŠ¸ (ìœ íŠœë¸Œ ID ì‰¼í‘œ êµ¬ë¶„)</label><textarea id="edit-bgm" class="cute-input" rows="2" placeholder="VDMiHYgQKLE, jfKfPfyJRdk"></textarea></div>
            <div style="text-align: right;"><button class="btn-action" onclick="saveProfile()">ì €ì¥ ë° ì ìš©</button></div>
        </div>
    </div>

    <div id="shop-window" class="cute-popup">
        <div class="cute-titlebar" id="shop-drag">ğŸ›’ ìˆ˜ìƒí•œ ìíŒê¸° <div class="cute-title-btns"><span class="btn-close" onclick="closePopup('shop-window')"></span></div></div>
        <div class="cute-body" style="text-align:center;">
            <h3 style="color:#d81b60; margin:0 0 10px 0; text-shadow: 1px 1px #ffb6c1;">ë³´ìœ  í¬ì¸íŠ¸: <span id="my-money">0</span> P</h3>
            <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-bottom:15px;">
                <button class="btn-action" style="padding:15px 10px; background:#fff0f5;" onclick="buyItem('ì˜¤ë¦¬', 'ğŸ¦†', 100)">ğŸ¦†ì˜¤ë¦¬<br>100P</button>
                <button class="btn-action" style="padding:15px 10px; background:#e6e6fa;" onclick="buyItem('í™”ë¶„', 'ğŸŒµ', 200)">ğŸŒµí™”ë¶„<br>200P</button>
                <button class="btn-action" style="padding:15px 10px; background:#f0f8ff;" onclick="buyItem('ê³°ì¸í˜•', 'ğŸ§¸', 300)">ğŸ§¸ì¸í˜•<br>300P</button>
                <button class="btn-action" style="padding:15px 10px; background:#fffacd;" onclick="buyItem('ê²Œì„ê¸°', 'ğŸ®', 500)">ğŸ®ê²Œì„ê¸°<br>500P</button>
            </div>
            <div style="text-align:right;"><button class="btn-action" style="font-size:11px; padding:4px 8px;" onclick="clearRoomItems()">ğŸ§¹ ë°© ì²­ì†Œ (ê°€êµ¬ ì‹¹ ë²„ë¦¬ê¸°)</button></div>
        </div>
    </div>

  </div>

  <div id="yt-player-container" style="display:none;"></div>

  <script>
    /* ğŸ”´ Supabase ë° ì™¸ë¶€ í‚¤ ì„¤ì • */
    const SB_URL = "https://kzgbqpodvpuoqovfsyrm.supabase.co";
    const SB_KEY = "sb_publishable_pdqE1Sc-4PSv3LQM9IsBcA_xJWeZwW-"; 
    const OPENROUTER_KEY = "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"; 
    let sbClient = null; if (window.supabase) sbClient = window.supabase.createClient(SB_URL, SB_KEY);
    
    CKEDITOR.replace('post-content', { height: 250, language: 'ko', removeButtons: 'About', versionCheck: false });
    let currentEditId = null; let globalPostsData = []; 

    function insertLocalImageToEditor(input) { const file = input.files[0]; if(!file) return; if(file.size > 2 * 1024 * 1024) return alert("í¬ìœ½... ì‚¬ì§„ ìš©ëŸ‰ì´ 2MBê°€ ë„˜ëŠ”ë‹¤!"); const reader = new FileReader(); reader.onload = function(e) { CKEDITOR.instances['post-content'].insertHtml(`<img src="${e.target.result}" style="max-width:100%; border-radius:10px;">`); input.value = ''; }; reader.readAsDataURL(file); }

    /* ë§ˆìš°ìŠ¤ íˆ´íŒ */
    const tooltip = document.getElementById('custom-tooltip');
    document.addEventListener('mousemove', (e) => { const target = e.target.closest('[data-tooltip]'); if (target) { tooltip.style.display = 'block'; tooltip.style.left = (e.pageX + 15) + 'px'; tooltip.style.top = (e.pageY + 15) + 'px'; tooltip.innerText = target.getAttribute('data-tooltip'); } else { tooltip.style.display = 'none'; } });

    /* ë“œë˜ê·¸ íŒì—… */
    let highestZ = 100;
    function makeDraggable(winId, dragId) { const win = document.getElementById(winId); const dragArea = document.getElementById(dragId); let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0; win.onmousedown = () => { win.style.zIndex = ++highestZ; }; dragArea.onmousedown = (e) => { e.preventDefault(); pos3 = e.clientX; pos4 = e.clientY; document.onmouseup = closeDrag; document.onmousemove = elementDrag; }; function elementDrag(e) { e.preventDefault(); pos1 = pos3 - e.clientX; pos2 = pos4 - e.clientY; pos3 = e.clientX; pos4 = e.clientY; win.style.top = (win.offsetTop - pos2) + "px"; win.style.left = (win.offsetLeft - pos1) + "px"; } function closeDrag() { document.onmouseup = null; document.onmousemove = null; } }
    ['write-window','board-window','ai-window','profile-window','shop-window','music-window','shimeji-room','dolphin-window'].forEach(id => { makeDraggable(id, id === 'shimeji-room' ? id : id.replace('window', 'drag')); });
    function openPopup(id) { document.getElementById(id).style.display = 'block'; document.getElementById(id).style.zIndex = ++highestZ; }
    function closePopup(id) { document.getElementById(id).style.display = 'none'; }

    /* ğŸ¬ ëŒê³ ë˜ ë§ë¼ìš°ê¸° ê²Œì„ ë¡œì§ */
    const rings = [document.getElementById('ring1'), document.getElementById('ring2'), document.getElementById('ring3'), document.getElementById('ring4')];
    let ringStates = rings.map((r, i) => ({ x: 50 + (i*50), y: 300, vy: 0, vx: 0, stuck: false }));
    const gravity = 0.6;

    function updateGame() {
        rings.forEach((ring, i) => {
            let s = ringStates[i];
            if (s.stuck) return;

            s.vy += gravity; s.y += s.vy; s.x += s.vx; s.vx *= 0.92;
            if (s.y > 300) { s.y = 300; s.vy = -s.vy * 0.4; } 
            if (s.x < 0) { s.x = 0; s.vx = -s.vx; } if (s.x > 240) { s.x = 240; s.vx = -s.vx; }

            // ê³ ë¦¬ì— ê±¸ë¦¼ íŒì • (ì™¼ìª½ 70, ì˜¤ë¥¸ìª½ 205)
            if ((Math.abs(s.x - 65) < 15 || Math.abs(s.x - 200) < 15) && s.y > 180 && s.y < 250 && s.vy > 0) {
                s.stuck = true; s.y = 230 + (i*5); s.x = Math.abs(s.x - 65) < 15 ? 65 : 200;
                earnPoints(50); showBubble("ë§ ê±¸ê¸° ì„±ê³µ! +50P"); // ì„±ê³µ ë³´ìƒ!
            }
            ring.style.top = s.y + 'px'; ring.style.left = s.x + 'px';
        });
        requestAnimationFrame(updateGame);
    }
    updateGame();

    function pushRings(side) {
        rings.forEach((ring, i) => {
            let s = ringStates[i]; if (s.stuck) return;
            s.vy = -Math.random() * 12 - 6; s.vx = (side === 'left' ? 1 : -1) * (Math.random() * 6 + 2);
        });
    }

    /* ìíŒê¸° ë° ë°© ì¥ì‹ */
    let myMoney = parseInt(localStorage.getItem('myPoints') || '1000'); let roomItems = JSON.parse(localStorage.getItem('myRoomItems') || '[]');
    function updateMoneyDisplay() { document.getElementById('my-money').innerText = myMoney; localStorage.setItem('myPoints', myMoney); }
    function earnPoints(amount) { myMoney += amount; updateMoneyDisplay(); } updateMoneyDisplay();
    function buyItem(name, icon, price) { if (myMoney < price) return alert("ëˆì´ ëª¨ìë¼..."); myMoney -= price; updateMoneyDisplay(); const newItem = { icon: icon, x: Math.floor(Math.random() * 80) + 10, y: Math.floor(Math.random() * 80) + 10 }; roomItems.push(newItem); localStorage.setItem('myRoomItems', JSON.stringify(roomItems)); renderRoomItems(); }
    function renderRoomItems() { const layer = document.getElementById('room-items-layer'); layer.innerHTML = ''; roomItems.forEach(item => { const el = document.createElement('div'); el.className = 'room-item'; el.style.left = item.x + '%'; el.style.top = item.y + '%'; el.innerText = item.icon; layer.appendChild(el); }); }
    function clearRoomItems() { roomItems = []; localStorage.setItem('myRoomItems', '[]'); renderRoomItems(); } renderRoomItems();

    /* ì„¤ì • ë¡œë“œ */
    let tempBgBase64 = null, tempMainBase64 = null, tempPetBase64 = null; let currentPlaylist = [];
    function handleFile(id, callback) { document.getElementById(id).addEventListener('change', function(e) { const file = e.target.files[0]; if(!file) return; if(file.size > 3 * 1024 * 1024) return alert("ì‚¬ì§„ì´ ë„ˆë¬´ í½ë‹ˆë‹¤!"); const r = new FileReader(); r.onload = evt => callback(evt.target.result); r.readAsDataURL(file); }); }
    handleFile('edit-bg-file', res => tempBgBase64 = res); handleFile('edit-main-file', res => tempMainBase64 = res); handleFile('edit-pet-file', res => tempPetBase64 = res);
    function loadProfile() { const saved = JSON.parse(localStorage.getItem('collageSettingsV5')) || {}; if(saved.bg) document.body.style.backgroundImage = `url(${saved.bg})`; document.body.style.backgroundSize = (saved.bgSize || 100) + '%'; document.getElementById('edit-bg-size').value = saved.bgSize || 100; document.getElementById('bg-size-val').innerText = saved.bgSize || 100; if(saved.main) document.getElementById('main-visual-img').src = saved.main; document.getElementById('pet-image').src = saved.pet || 'https://raw.githubusercontent.com/shimeji-ee/shimeji-ee.github.io/master/img/shime1.png'; currentPlaylist = (saved.bgm || 'VDMiHYgQKLE').split(',').map(s => s.trim()).filter(s => s); tempBgBase64 = saved.bg || ''; tempMainBase64 = saved.main || ''; tempPetBase64 = saved.pet || ''; }
    function saveProfile() { try { localStorage.setItem('collageSettingsV5', JSON.stringify({ bg: tempBgBase64, bgSize: document.getElementById('edit-bg-size').value, main: tempMainBase64, pet: tempPetBase64, bgm: document.getElementById('edit-bgm').value || 'VDMiHYgQKLE' })); } catch(e) { alert("ì‚¬ì§„ ìš©ëŸ‰ì´ ë„ˆë¬´ í½ë‹ˆë‹¤!!"); return; } loadProfile(); closePopup('profile-window'); if(player && player.loadVideoById) loadMusicPlayer(); }

    /* ìœ íŠœë¸Œ ì œì–´ */
    let player = null; let trackIndex = 0; let isPlayerReady = false; let tag = document.createElement('script'); tag.src = "https://www.youtube.com/iframe_api"; document.head.appendChild(tag);
    window.onYouTubeIframeAPIReady = function() { if(currentPlaylist.length === 0) return; trackIndex = Math.floor(Math.random() * currentPlaylist.length); player = new YT.Player('yt-player-container', { height: '0', width: '0', videoId: currentPlaylist[trackIndex], events: { 'onReady': () => { isPlayerReady = true; document.getElementById('now-playing-text').innerText = "ğŸµ ì¬ìƒì„ ëˆŒëŸ¬ì£¼ì„¸ìš”"; }, 'onStateChange': onPlayerStateChange, 'onError': nextTrack } }); }
    function loadMusicPlayer() { if(!isPlayerReady || currentPlaylist.length === 0) return; trackIndex = Math.floor(Math.random() * currentPlaylist.length); player.loadVideoById(currentPlaylist[trackIndex]); }
    function onPlayerStateChange(event) { if(event.data === YT.PlayerState.ENDED) nextTrack(); if(event.data === YT.PlayerState.PLAYING) { document.getElementById('play-btn').innerText = 'â¸'; let videoTitle = player.getVideoData().title; document.getElementById('now-playing-text').innerText = "ğŸµ " + (videoTitle || currentPlaylist[trackIndex]); } if(event.data === YT.PlayerState.PAUSED) { document.getElementById('play-btn').innerText = 'â–¶'; } }
    function togglePlay() { if(!isPlayerReady) return; if(player.getPlayerState() === YT.PlayerState.PLAYING) player.pauseVideo(); else player.playVideo(); } function nextTrack() { if(!isPlayerReady) return; trackIndex = (trackIndex + 1) % currentPlaylist.length; player.loadVideoById(currentPlaylist[trackIndex]); } function prevTrack() { if(!isPlayerReady) return; trackIndex = (trackIndex - 1 + currentPlaylist.length) % currentPlaylist.length; player.loadVideoById(currentPlaylist[trackIndex]); }

    /* ì‹œë©”ì§€ í« í–‰ë™ */
    let isRoaming = false; let roamInterval; function showBubble(text) { const bubble = document.getElementById('pet-bubble'); bubble.innerText = text; bubble.style.opacity = '1'; setTimeout(() => { bubble.style.opacity = '0'; }, 3000); }
    setInterval(() => { if(Math.random() > 0.5) showBubble(["ë’¹êµ´ë’¹êµ´...", "ë°°ê³ íŒŒ...", "ë†€ì•„ì¤˜!", "í¬ì¸íŠ¸ë‚˜ ë²Œì–´ì™€!"][Math.floor(Math.random() * 4)]); }, 8000);
    function toggleRoaming() { isRoaming = !isRoaming; const status = document.getElementById('roam-status'); const petRoom = document.getElementById('shimeji-room'); const petImg = document.getElementById('pet-image'); let currentX = petRoom.offsetLeft; if(isRoaming) { status.innerText = "ìƒíƒœ: [ë½ˆë½ˆë½ˆ ëŒì•„ë‹¤ë‹˜]"; roamInterval = setInterval(() => { const randX = Math.floor(Math.random() * (window.innerWidth - 150)); const randY = Math.floor(Math.random() * (window.innerHeight - 150)); if(randX < currentX) petImg.style.setProperty('--flip', -1); else petImg.style.setProperty('--flip', 1); currentX = randX; petImg.classList.add('is-walking'); petRoom.style.left = randX + 'px'; petRoom.style.top = randY + 'px'; setTimeout(() => { petImg.classList.remove('is-walking'); }, 1500); }, 3000); } else { status.innerText = "ìƒíƒœ: [ëŒ€ê¸° ì¤‘]"; clearInterval(roamInterval); petImg.classList.remove('is-walking'); } }

    /* AI ì±—ë´‡ */
    async function callAI(text) { try { const res = await fetch("https://openrouter.ai/api/v1/chat/completions", { method: "POST", headers: { "Authorization": `Bearer ${OPENROUTER_KEY}`, "Content-Type": "application/json" }, body: JSON.stringify({ "model": "mistralai/mistral-7b-instruct:free", "messages": [{"role": "system", "content": "ë„ˆëŠ” ë‹¤ë§ˆê³ ì¹˜ í« 'ë‚˜ë£¨'ì•¼. í•œêµ­ì–´ë¡œ ê·€ì—½ê²Œ ë°˜ë§ë¡œ ëŒ€ë‹µí•´ì¤˜."}, {"role": "user", "content": text}] }) }); const data = await res.json(); if(data.choices) return data.choices[0].message.content; } catch(e) { return null; } return null; }
    function toggleChat() { openPopup('ai-window'); } async function sendMsg() { const input = document.getElementById('ai-input'); const log = document.getElementById('chat-log'); const text = input.value.trim(); if(!text) return; log.innerHTML += `<div class="msg-row msg-me">${text}</div>`; input.value = ''; log.scrollTop = log.scrollHeight; const loadingId = "load-" + Date.now(); log.innerHTML += `<div id="${loadingId}" class="msg-row msg-ai">ë‚˜ë£¨: (ìƒê° ì¤‘...)</div>`; log.scrollTop = log.scrollHeight; const reply = await callAI(text); document.getElementById(loadingId).remove(); if(reply) { log.innerHTML += `<div class="msg-row msg-ai">ë‚˜ë£¨: ${reply}</div>`; showBubble(reply); } else { log.innerHTML += `<div class="msg-sys">â€» AI ì„œë²„ ì ‘ì† ì‹¤íŒ¨...!!</div>`; } log.scrollTop = log.scrollHeight; }

    /* ê²Œì‹œíŒ & ê¸€ì“°ê¸° */
    function openBoard(type) { document.getElementById('board-title').innerText = type === 'diary' ? 'ğŸ““ Diary' : 'âœ¨ Character'; document.getElementById('page-content').innerHTML = `ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...`; openPopup('board-window'); loadPosts(type); } function openWrite() { currentEditId = null; document.getElementById('post-title').value = ''; CKEDITOR.instances['post-content'].setData(''); openPopup('write-window'); } async function savePost() { if (!sbClient) return; const category = document.getElementById('post-category').value; const title = document.getElementById('post-title').value; const content = CKEDITOR.instances['post-content'].getData(); if(!title || !content.trim()) return alert("ë¹ˆì¹¸ì„ ì±„ì›Œ...!!"); let err; if (currentEditId) err = (await sbClient.from('posts').update({ title, content, category }).eq('id', currentEditId)).error; else { err = (await sbClient.from('posts').insert([{ title, content, category }])).error; if(!err) earnPoints(100); } if(err) alert("ì‹¤íŒ¨...!!"); else { closePopup('write-window'); loadPosts(category); } } async function deletePost(id, category) { if(!confirm("ì§€ìš´ë‹¤...?")) return; await sbClient.from('posts').delete().eq('id', id); loadPosts(category); } function editPost(id) { const post = globalPostsData.find(p => p.id === id); if(!post) return; currentEditId = id; document.getElementById('post-category').value = post.category; document.getElementById('post-title').value = post.title; CKEDITOR.instances['post-content'].setData(post.content); openPopup('write-window'); } async function loadPosts(categoryType) { if (!sbClient) return; const { data, error } = await sbClient.from('posts').select('*').eq('category', categoryType).order('created_at', { ascending: false }); const list = document.getElementById('page-content'); if(error || data.length === 0) { list.innerHTML = "<div style='color:#d81b60;'>í…… ë¹„ì—ˆë‹¤...</div>"; return; } globalPostsData = data; let html = ''; data.forEach(p => { const dateStr = new Date(p.created_at).toLocaleString(); html += `<div style="margin-bottom: 20px; border: 2px dashed #ffb6c1; border-radius:15px; overflow:hidden; background:rgba(255,255,255,0.9);"><div style="background: #ffe4e1; padding: 10px 15px; font-weight: bold; color: #d81b60; display:flex; justify-content:space-between; align-items:center;">ğŸ“ ${p.title} <div><button class="btn-action" style="padding:4px 8px; font-size:11px;" onclick="editPost('${p.id}')">ìˆ˜ì •</button><button class="btn-action" style="padding:4px 8px; font-size:11px;" onclick="deletePost('${p.id}', '${p.category}')">ì‚­ì œ</button></div></div><div style="padding:15px;"><div style="font-size:11px; color:#aaa; margin-bottom:10px;">${dateStr}</div><div style="font-size:13px; line-height: 1.6;">${p.content}</div></div></div>`; }); list.innerHTML = html; }

    loadProfile();
  </script>
</body>
</html>
  <title>My Messy Iso-Room</title>
  <link href="https://cdn.jsdelivr.net/npm/galmuri@latest/dist/galmuri.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.ckeditor.com/4.22.1/standard/ckeditor.js"></script>

  <style>
    body { 
        background-color: #f4f0eb; 
        background-image: url('https://www.transparenttextures.com/patterns/cream-pixels.png');
        font-family: 'Galmuri9', sans-serif; 
        margin: 0; padding: 0; color: #333; overflow-x: hidden;
    }
    .messy-canvas { position: relative; width: 100vw; height: 100vh; overflow: hidden; }

    /* ğŸŒ¸ ì•„ë‹´í•´ì§„ ë©”ì¸ í”½ì…€ ë£¸ */
    .iso-room-container {
        position: absolute; top: 120px; left: 50px;
        width: 450px; height: 450px; 
        z-index: 10; display: flex; justify-content: center; align-items: center; user-select: none;
    }
    .iso-room-img { width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(10px 10px 0px rgba(0,0,0,0.1)); }
    #room-items-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
    .room-item { position: absolute; font-size: 24px; filter: drop-shadow(2px 2px 0px rgba(0,0,0,0.2)); animation: pop 0.3s ease-out; }
    @keyframes pop { 0% {transform: scale(0);} 80% {transform: scale(1.2);} 100% {transform: scale(1);} }

    /* í©ì–´ì§„ ë²„íŠ¼ë“¤ */
    .scattered-btn {
        position: absolute; background: #fff; border: 2px dashed #ff69b4; border-radius: 15px;
        padding: 8px 15px; font-weight: bold; color: #d81b60; font-size: 14px;
        cursor: pointer; box-shadow: 3px 3px 0px #ffb6c1; z-index: 15; transition: 0.1s; user-select: none;
    }
    .scattered-btn:active { transform: translate(3px, 3px); box-shadow: none; }
    
    .btn-home  { top: 50px; left: 450px; transform: rotate(8deg); background: #ffe4e1;}
    .btn-diary { top: 150px; left: 520px; transform: rotate(-6deg); background: #e6e6fa;}
    .btn-char  { top: 250px; left: 500px; transform: rotate(12deg); background: #f0f8ff;}
    .btn-shop  { top: 380px; left: 480px; transform: rotate(-8deg); background: #fffacd;}
    .btn-write { top: 480px; left: 400px; transform: rotate(4deg); background: #ffc0cb; font-size: 16px; border: 3px solid #d81b60;}

    #custom-tooltip {
        position: absolute; display: none; z-index: 9999999; background: #fff; border: 2px solid #8a2be2; border-radius: 10px;
        padding: 8px 12px; font-size: 12px; font-weight: bold; color: #8a2be2; box-shadow: 3px 3px 0px rgba(138, 43, 226, 0.3); pointer-events: none; white-space: nowrap;
    }

    /* ğŸŒ¸ íŒì—…ì°½ ê³µí†µ */
    .cute-popup {
        position: absolute; display: none; background: rgba(255, 255, 255, 0.95);
        border: 2px solid #9370db; border-radius: 15px; box-shadow: 5px 5px 0px rgba(147, 112, 219, 0.4); overflow: hidden; width: 450px;
    }
    .cute-titlebar {
        background: #dda0dd; color: #fff; padding: 10px 15px; font-weight: bold; font-size: 14px;
        display: flex; justify-content: space-between; align-items: center; user-select: none; cursor: grab;
    }
    .cute-titlebar:active { cursor: grabbing; }
    .cute-title-btns span { display: inline-block; width: 14px; height: 14px; border-radius: 50%; background: #fff; margin-left: 5px; cursor: pointer; border: 1px solid #8a2be2; }
    .cute-body { padding: 20px; max-height: 65vh; overflow-y: auto; }

    #write-window { width: 800px; top: 100px; left: 100px; }
    #board-window { width: 600px; top: 80px; left: 150px; }
    #ai-window { width: 320px; top: 200px; left: 600px; }
    #shop-window { width: 380px; top: 150px; left: 300px; }
    #music-window { width: 350px; top: 30px; left: 600px; display: block; }
    #profile-window { width: 450px; top: 100px; left: 250px;}

    /* ğŸ¾ ì‹œë©”ì§€ í« */
    #shimeji-room {
        position: absolute; top: 250px; left: 200px; z-index: 12; text-align: center; cursor: grab; 
        transition: top 1.5s ease-in-out, left 1.5s ease-in-out;
    }
    #shimeji-room:active { cursor: grabbing; transition: none; }
    #pet-bubble { background: #fff; border: 2px solid #8a2be2; border-radius: 10px; padding: 6px; font-size: 12px; color: #8a2be2; font-weight: bold; margin-bottom: 5px; opacity:0; transition: opacity 0.3s;}
    
    #pet-image { 
        width: 100px; height: 100px; object-fit: contain; filter: drop-shadow(2px 2px 0px rgba(0,0,0,0.2));
        transform: scaleX(var(--flip, 1)); 
    }
    @keyframes bounce { 0%, 100% { transform: translateY(0) scaleX(var(--flip, 1)); } 50% { transform: translateY(-20px) scaleX(var(--flip, 1)); } }
    .is-walking { animation: bounce 0.3s infinite; }

    /* ìŒì•… í”Œë ˆì´ì–´ */
    .player-controls { display: flex; gap: 8px; justify-content: center; margin-bottom: 10px;}
    .ctrl-btn { background: #fff; border: 2px solid #dda0dd; border-radius: 5px; cursor: pointer; font-size: 16px; padding: 5px 15px; color: #8a2be2; font-weight:bold; box-shadow: 2px 2px 0px #dda0dd;}
    .ctrl-btn:active { transform: translate(2px,2px); box-shadow:none;}
    .music-info { font-size: 13px; color: #8a2be2; font-weight: bold; overflow: hidden; white-space: nowrap; text-align:center; background:#f3e5f5; padding:5px; border-radius:5px;}

    /* í¼ ìš”ì†Œ */
    .input-row { display: flex; flex-direction: column; margin-bottom: 12px; }
    .input-row label { font-size: 13px; color: #8a2be2; font-weight: bold; margin-bottom: 5px; }
    .cute-input { padding: 8px; border: 2px solid #dda0dd; border-radius: 5px; font-family: 'Galmuri9'; outline: none; }
    .btn-action { font-family: 'Galmuri9'; font-size: 13px; padding: 6px 15px; cursor: pointer; border: 2px solid #9370db; border-radius: 8px; background: #fff; color: #8a2be2; font-weight: bold; box-shadow: 2px 2px 0px #9370db;}
    .btn-action:active { transform:translate(2px,2px); box-shadow:none; }

    .chat-body { height: 220px; background: #fff; border: 2px dashed #dda0dd; overflow-y: auto; padding: 10px; font-size: 13px; border-radius: 10px;}
    .msg-row { margin-bottom: 10px; line-height: 1.5; }
    .msg-ai { color: #8a2be2; font-weight: bold;}
    .msg-me { text-align: right; color: #4a148c; }
    .msg-sys { text-align: center; color: #ff69b4; font-size: 11px; }
  </style>
</head>
<body id="main-body">

  <div id="custom-tooltip">ë§í’ì„ </div>

  <div class="messy-canvas" id="desktop-area">
    
    <div class="iso-room-container" data-tooltip="ê°€êµ¬ë¥¼ ì‚¬ë©´ ë°°ì¹˜ë©ë‹ˆë‹¤!">
        <img id="main-visual-img" src="https://cdn.pixabay.com/photo/2021/08/25/20/42/field-6574455_1280.png" class="iso-room-img">
        <div id="room-items-layer"></div>
    </div>

    <button class="scattered-btn btn-home" onclick="openPopup('profile-window')" data-tooltip="ë°°ê²½ê³¼ BGM ì„¤ì •">ğŸ› ï¸ ë°© ê¾¸ë¯¸ê¸°</button>
    <button class="scattered-btn btn-diary" onclick="openBoard('diary')" data-tooltip="ë¹„ë°€ìŠ¤ëŸ° í‘ì—­ì‚¬ ë³´ê´€ì†Œ">ğŸ““ ë¹„ë°€ ì¼ê¸°</button>
    <button class="scattered-btn btn-char" onclick="openBoard('character')" data-tooltip="ë‚˜ì˜ ë˜ ë‹¤ë¥¸ ìì•„ë“¤">âœ¨ ìºë¦­í„° ë±</button>
    <button class="scattered-btn btn-shop" onclick="openPopup('shop-window')" data-tooltip="ëˆì„ ë‚­ë¹„í•´ ë°©ì„ ê¾¸ë©°ë¼!">ğŸ›’ ìˆ˜ìƒí•œ ìíŒê¸°</button>
    <button class="scattered-btn btn-write" onclick="openWrite()" data-tooltip="í´ë” ì•ˆì˜ ì‚¬ì§„ë„ ì§ì ‘ ì²¨ë¶€ ê°€ëŠ¥!">âœï¸ ê¸€ì“°ê¸°</button>

    <div id="shimeji-room" data-tooltip="ë”ë¸” í´ë¦­í•˜ë©´ ì´ë¦¬ì €ë¦¬ ëŒì•„ë‹¤ë‹™ë‹ˆë‹¤!">
        <div id="pet-bubble">ì‹¬ì‹¬í•´!</div>
        <img id="pet-image" src="https://raw.githubusercontent.com/shimeji-ee/shimeji-ee.github.io/master/img/shime1.png" onclick="toggleChat()" ondblclick="toggleRoaming()">
        <div style="font-size: 10px; color:#d81b60; font-weight:bold; margin-top:5px; text-shadow:1px 1px #fff;" id="roam-status">ìƒíƒœ: [ëŒ€ê¸° ì¤‘]</div>
    </div>

    <div id="music-window" class="cute-popup">
        <div class="cute-titlebar" id="music-drag">ğŸ“» Cassette.exe <div class="cute-title-btns"><span onclick="closePopup('music-window')"></span></div></div>
        <div class="cute-body" style="padding:15px; text-align:center;">
            <div class="player-controls">
                <button class="ctrl-btn" onclick="prevTrack()" data-tooltip="ì´ì „ ê³¡">â®</button>
                <button class="ctrl-btn" id="play-btn" onclick="togglePlay()" data-tooltip="ì¬ìƒ/ì •ì§€">â–¶</button>
                <button class="ctrl-btn" onclick="nextTrack()" data-tooltip="ë‹¤ìŒ ê³¡">â­</button>
            </div>
            <marquee class="music-info" scrollamount="4" id="now-playing-text">BGM ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</marquee>
        </div>
    </div>

    <div id="board-window" class="cute-popup">
        <div class="cute-titlebar" id="board-drag"><span id="board-title">ğŸ€ Board</span> <div class="cute-title-btns"><span onclick="closePopup('board-window')"></span></div></div>
        <div class="cute-body" id="page-content">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>

    <div id="write-window" class="cute-popup">
        <div class="cute-titlebar" id="write-drag">ğŸ“ Editor.exe <div class="cute-title-btns"><span onclick="closePopup('write-window')"></span></div></div>
        <div class="cute-body">
            <div class="input-row" style="flex-direction:row; align-items:center; gap:10px; justify-content:space-between;">
                <div style="display:flex; gap:10px; align-items:center;">
                    <label style="margin:0;">ê²Œì‹œíŒ</label>
                    <select id="post-category" class="cute-input" style="width: 120px;"><option value="diary">ë¹„ë°€ ì¼ê¸°ì¥</option><option value="character">ìºë¦­í„° ë±</option></select>
                </div>
                <div>
                    <label for="local-img-upload" class="btn-action" style="cursor:pointer; background:#e6e6fa;">ğŸ–¼ï¸ ë‚´ PC ì‚¬ì§„ ë„£ê¸°</label>
                    <input type="file" id="local-img-upload" accept="image/*" style="display:none;" onchange="insertLocalImageToEditor(this)">
                </div>
            </div>
            <div class="input-row"><input type="text" id="post-title" class="cute-input" placeholder="ì œëª©..."></div>
            <textarea id="post-content"></textarea>
            <div style="text-align: right; margin-top: 15px;"><button class="btn-action" onclick="savePost()">ë°œí–‰í•˜ê¸°</button></div>
        </div>
    </div>

    <div id="ai-window" class="cute-popup">
        <div class="cute-titlebar" id="ai-drag">ğŸ’¬ ë‚˜ë£¨ (AI) <div class="cute-title-btns"><span onclick="closePopup('ai-window')"></span></div></div>
        <div class="cute-body">
          <div class="chat-body" id="chat-log"><div class="msg-row msg-ai">ë‚˜ë£¨: ëƒ¥! </div></div>
          <div style="display:flex; gap:5px; margin-top:10px;">
              <input type="text" id="ai-input" class="cute-input" style="flex:1;" onkeypress="if(event.key==='Enter') sendMsg()">
              <button class="btn-action" onclick="sendMsg()">ì „ì†¡</button>
          </div>
        </div>
    </div>

    <div id="profile-window" class="cute-popup">
        <div class="cute-titlebar" id="profile-drag">ğŸ› ï¸ Setting <div class="cute-title-btns"><span onclick="closePopup('profile-window')"></span></div></div>
        <div class="cute-body">
            <div class="input-row"><label>ë°”íƒ•í™”ë©´ ë¬´ëŠ¬</label><input type="file" id="edit-bg-file" class="cute-input"></div>
            <div class="input-row"><label>ë°”íƒ•í™”ë©´ í¬ê¸°: <span id="bg-size-val">100</span>%</label><input type="range" id="edit-bg-size" min="10" max="300" value="100" oninput="document.getElementById('bg-size-val').innerText=this.value"></div>
            <hr style="border:1px dashed #dda0dd;">
            <div class="input-row"><label>ë‚´ ë°© ì´ë¯¸ì§€</label><input type="file" id="edit-main-file" class="cute-input"></div>
            <div class="input-row"><label>í« ì´ë¯¸ì§€</label><input type="file" id="edit-pet-file" class="cute-input"></div>
            <div class="input-row"><label>BGM ì…”í”Œ ë¦¬ìŠ¤íŠ¸ (ìœ íŠœë¸Œ ID)</label><textarea id="edit-bgm" class="cute-input" rows="2" placeholder="VDMiHYgQKLE, jfKfPfyJRdk"></textarea></div>
            <div style="text-align: right;"><button class="btn-action" onclick="saveProfile()">ì €ì¥ ë° ì ìš©</button></div>
        </div>
    </div>

    <div id="shop-window" class="cute-popup">
        <div class="cute-titlebar" id="shop-drag">ğŸ›’ ìˆ˜ìƒí•œ ìíŒê¸° <div class="cute-title-btns"><span onclick="closePopup('shop-window')"></span></div></div>
        <div class="cute-body" style="text-align:center;">
            <h3 style="color:#8a2be2; margin:0 0 10px 0;">ë³´ìœ  í¬ì¸íŠ¸: <span id="my-money">0</span> P</h3>
            <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-bottom:15px;">
                <button class="btn-action" style="padding:10px; background:#fff0f5;" onclick="buyItem('ì˜¤ë¦¬', 'ğŸ¦†', 100)">ğŸ¦†ì˜¤ë¦¬(100P)</button>
                <button class="btn-action" style="padding:10px; background:#e6e6fa;" onclick="buyItem('í™”ë¶„', 'ğŸŒµ', 200)">ğŸŒµí™”ë¶„(200P)</button>
                <button class="btn-action" style="padding:10px; background:#f0f8ff;" onclick="buyItem('ê³°ì¸í˜•', 'ğŸ§¸', 300)">ğŸ§¸ì¸í˜•(300P)</button>
                <button class="btn-action" style="padding:10px; background:#fffacd;" onclick="buyItem('ê²Œì„ê¸°', 'ğŸ®', 500)">ğŸ®ê²Œì„ê¸°(500P)</button>
            </div>
            <div style="text-align:right;"><button class="btn-action" style="font-size:10px; padding:2px 5px;" onclick="clearRoomItems()">ê°€êµ¬ ì‹¹ ë²„ë¦¬ê¸°</button></div>
        </div>
    </div>

  </div>

  <div id="yt-player-container" style="display:none;"></div>

  <script>
    const SB_URL = "https://kzgbqpodvpuoqovfsyrm.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt6Z2JxcG9kdnB1b3FvdmZzeXJtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3OTQ2NzYsImV4cCI6MjA3OTM3MDY3Nn0.5cFaJg_TqqhV5ZSlQJg84c9f5zp_DyRCpkPhBP5wunU"; 
    const OPENROUTER_KEY = "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"; 
    let sbClient = null;
    if (window.supabase) sbClient = window.supabase.createClient(SB_URL, SB_KEY);

    CKEDITOR.replace('post-content', { height: 250, language: 'ko', removeButtons: 'About', versionCheck: false });
    let currentEditId = null;
    let globalPostsData = []; 

    function insertLocalImageToEditor(input) {
        const file = input.files[0]; if(!file) return;
        if(file.size > 2 * 1024 * 1024) { alert("í¬ìœ½... ì‚¬ì§„ ìš©ëŸ‰ì´ 2MBê°€ ë„˜ëŠ”ë‹¤!"); return; } 
        const reader = new FileReader();
        reader.onload = function(e) { CKEDITOR.instances['post-content'].insertHtml(`<img src="${e.target.result}" style="max-width:100%; border-radius:10px;">`); input.value = ''; };
        reader.readAsDataURL(file);
    }

    const tooltip = document.getElementById('custom-tooltip');
    document.addEventListener('mousemove', (e) => {
        const target = e.target.closest('[data-tooltip]');
        if (target) { tooltip.style.display = 'block'; tooltip.style.left = (e.pageX + 15) + 'px'; tooltip.style.top = (e.pageY + 15) + 'px'; tooltip.innerText = target.getAttribute('data-tooltip'); } 
        else { tooltip.style.display = 'none'; }
    });

    let highestZ = 100;
    function makeDraggable(winId, dragId) {
        const win = document.getElementById(winId); const dragArea = document.getElementById(dragId);
        let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
        win.onmousedown = () => { win.style.zIndex = ++highestZ; };
        dragArea.onmousedown = (e) => { e.preventDefault(); pos3 = e.clientX; pos4 = e.clientY; document.onmouseup = closeDrag; document.onmousemove = elementDrag; };
        function elementDrag(e) { e.preventDefault(); pos1 = pos3 - e.clientX; pos2 = pos4 - e.clientY; pos3 = e.clientX; pos4 = e.clientY; win.style.top = (win.offsetTop - pos2) + "px"; win.style.left = (win.offsetLeft - pos1) + "px"; }
        function closeDrag() { document.onmouseup = null; document.onmousemove = null; }
    }
    
    ['write-window','board-window','ai-window','profile-window','shop-window','music-window','shimeji-room'].forEach(id => {
        makeDraggable(id, id === 'shimeji-room' ? id : id.replace('window', 'drag'));
    });

    function openPopup(id) { document.getElementById(id).style.display = 'block'; document.getElementById(id).style.zIndex = ++highestZ; }
    function closePopup(id) { document.getElementById(id).style.display = 'none'; }

    let myMoney = parseInt(localStorage.getItem('myPoints') || '1000');
    let roomItems = JSON.parse(localStorage.getItem('myRoomItems') || '[]');

    function updateMoneyDisplay() { document.getElementById('my-money').innerText = myMoney; localStorage.setItem('myPoints', myMoney); }
    function earnPoints(amount) { myMoney += amount; updateMoneyDisplay(); }
    updateMoneyDisplay();

    function buyItem(name, icon, price) {
        if (myMoney < price) { alert("ëˆì´ ëª¨ìë¼... ê¸€ì„ ì¨ì„œ ë²Œì–´ì˜¤ë“ ê°€!"); return; }
        myMoney -= price; updateMoneyDisplay();
        const newItem = { icon: icon, x: Math.floor(Math.random() * 80) + 10, y: Math.floor(Math.random() * 80) + 10 };
        roomItems.push(newItem); localStorage.setItem('myRoomItems', JSON.stringify(roomItems)); renderRoomItems();
    }
    function renderRoomItems() {
        const layer = document.getElementById('room-items-layer'); layer.innerHTML = '';
        roomItems.forEach(item => { const el = document.createElement('div'); el.className = 'room-item'; el.style.left = item.x + '%'; el.style.top = item.y + '%'; el.innerText = item.icon; layer.appendChild(el); });
    }
    function clearRoomItems() { roomItems = []; localStorage.setItem('myRoomItems', '[]'); renderRoomItems(); }
    renderRoomItems();

    let tempBgBase64 = null, tempMainBase64 = null, tempPetBase64 = null;
    let currentPlaylist = [];
    function handleFile(id, callback) { document.getElementById(id).addEventListener('change', function(e) { const file = e.target.files[0]; if(!file) return; if(file.size > 3 * 1024 * 1024) return alert("ì‚¬ì§„ì´ ë„ˆë¬´ í½ë‹ˆë‹¤!"); const r = new FileReader(); r.onload = evt => callback(evt.target.result); r.readAsDataURL(file); }); }
    handleFile('edit-bg-file', res => tempBgBase64 = res); handleFile('edit-main-file', res => tempMainBase64 = res); handleFile('edit-pet-file', res => tempPetBase64 = res);

    function loadProfile() {
        const saved = JSON.parse(localStorage.getItem('collageSettingsV4')) || {};
        if(saved.bg) document.body.style.backgroundImage = `url(${saved.bg})`;
        document.body.style.backgroundSize = (saved.bgSize || 100) + '%';
        document.getElementById('edit-bg-size').value = saved.bgSize || 100; document.getElementById('bg-size-val').innerText = saved.bgSize || 100;
        if(saved.main) document.getElementById('main-visual-img').src = saved.main;
        
        // ğŸ”´ í« ì´ë¯¸ì§€ ë¡œë“œ ì‹œ ê¸°ë³¸ ì‹œë©”ì§€ ê²½ë¡œ ë³´ì¥
        document.getElementById('pet-image').src = saved.pet || 'https://raw.githubusercontent.com/shimeji-ee/shimeji-ee.github.io/master/img/shime1.png';
        
        currentPlaylist = (saved.bgm || 'VDMiHYgQKLE').split(',').map(s => s.trim()).filter(s => s);
        tempBgBase64 = saved.bg || ''; tempMainBase64 = saved.main || ''; tempPetBase64 = saved.pet || '';
    }
    function saveProfile() {
        try { localStorage.setItem('collageSettingsV4', JSON.stringify({ bg: tempBgBase64, bgSize: document.getElementById('edit-bg-size').value, main: tempMainBase64, pet: tempPetBase64, bgm: document.getElementById('edit-bgm').value || 'VDMiHYgQKLE' })); } 
        catch(e) { alert("ì‚¬ì§„ ìš©ëŸ‰ì´ ë„ˆë¬´ í½ë‹ˆë‹¤!!"); return; }
        loadProfile(); closePopup('profile-window'); if(player && player.loadVideoById) loadMusicPlayer();
    }

    let player = null; let trackIndex = 0; let isPlayerReady = false;
    let tag = document.createElement('script'); tag.src = "https://www.youtube.com/iframe_api"; document.head.appendChild(tag);

    window.onYouTubeIframeAPIReady = function() {
        if(currentPlaylist.length === 0) return;
        trackIndex = Math.floor(Math.random() * currentPlaylist.length);
        player = new YT.Player('yt-player-container', {
            height: '0', width: '0', videoId: currentPlaylist[trackIndex],
            events: {
                'onReady': () => { isPlayerReady = true; document.getElementById('now-playing-text').innerText = "ğŸµ ì¬ìƒë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”"; },
                'onStateChange': onPlayerStateChange, 'onError': nextTrack
            }
        });
    }
    function loadMusicPlayer() { if(!isPlayerReady || currentPlaylist.length === 0) return; trackIndex = Math.floor(Math.random() * currentPlaylist.length); player.loadVideoById(currentPlaylist[trackIndex]); }
    
    function onPlayerStateChange(event) {
        if(event.data === YT.PlayerState.ENDED) nextTrack();
        if(event.data === YT.PlayerState.PLAYING) { 
            document.getElementById('play-btn').innerText = 'â¸'; 
            let videoTitle = player.getVideoData().title;
            document.getElementById('now-playing-text').innerText = "ğŸµ " + (videoTitle || currentPlaylist[trackIndex]); 
        }
        if(event.data === YT.PlayerState.PAUSED) { document.getElementById('play-btn').innerText = 'â–¶'; }
    }
    function togglePlay() { if(!isPlayerReady) return; if(player.getPlayerState() === YT.PlayerState.PLAYING) player.pauseVideo(); else player.playVideo(); }
    function nextTrack() { if(!isPlayerReady) return; trackIndex = (trackIndex + 1) % currentPlaylist.length; player.loadVideoById(currentPlaylist[trackIndex]); }
    function prevTrack() { if(!isPlayerReady) return; trackIndex = (trackIndex - 1 + currentPlaylist.length) % currentPlaylist.length; player.loadVideoById(currentPlaylist[trackIndex]); }

    let isRoaming = false; let roamInterval;
    function showBubble(text) {
        const bubble = document.getElementById('pet-bubble');
        bubble.innerText = text; bubble.style.opacity = '1';
        setTimeout(() => { bubble.style.opacity = '0'; }, 3000);
    }
    
    setInterval(() => { if(Math.random() > 0.5) showBubble(["ë’¹êµ´ë’¹êµ´...", "ë°°ê³ íŒŒ...", "ë†€ì•„ì¤˜!", "í¬ì¸íŠ¸ë‚˜ ë²Œì–´ì™€!"][Math.floor(Math.random() * 4)]); }, 8000);

    function toggleRoaming() {
        isRoaming = !isRoaming;
        const status = document.getElementById('roam-status');
        const petRoom = document.getElementById('shimeji-room');
        const petImg = document.getElementById('pet-image');
        
        let currentX = petRoom.offsetLeft;
        
        if(isRoaming) {
            status.innerText = "ìƒíƒœ: [ë½ˆë½ˆë½ˆ ëŒì•„ë‹¤ë‹˜]";
            roamInterval = setInterval(() => {
                const randX = Math.floor(Math.random() * (window.innerWidth - 150));
                const randY = Math.floor(Math.random() * (window.innerHeight - 150));
                
                if(randX < currentX) petImg.style.setProperty('--flip', -1); 
                else petImg.style.setProperty('--flip', 1); 
                currentX = randX;

                petImg.classList.add('is-walking');
                petRoom.style.left = randX + 'px'; petRoom.style.top = randY + 'px';
                
                setTimeout(() => { petImg.classList.remove('is-walking'); }, 1500);
            }, 3000);
        } else {
            status.innerText = "ìƒíƒœ: [ëŒ€ê¸° ì¤‘]"; clearInterval(roamInterval); petImg.classList.remove('is-walking');
        }
    }

    /* ğŸ”´ 400 ì—ëŸ¬ë¥¼ ì—†ì• ê¸° ìœ„í•´ ê°€ì¥ ì•ˆì •ì ì¸ Mistral AI ëª¨ë¸ë¡œ ë³€ê²½ */
    async function callAI(text) {
        try {
            const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST", headers: { "Authorization": `Bearer ${OPENROUTER_KEY}`, "Content-Type": "application/json" },
                body: JSON.stringify({
                    "model": "mistralai/mistral-7b-instruct:free", 
                    "messages": [{"role": "system", "content": "ë„ˆëŠ” ë‹¤ë§ˆê³ ì¹˜ í« 'ë‚˜ë£¨'ì•¼. í•œêµ­ì–´ë¡œ ê·€ì—½ê²Œ ë°˜ë§ë¡œ ëŒ€ë‹µí•´ì¤˜."}, {"role": "user", "content": text}]
                })
            });
            const data = await res.json();
            if(data.choices) return data.choices[0].message.content;
        } catch(e) { return null; }
        return null;
    }

    function toggleChat() { openPopup('ai-window'); }
    async function sendMsg() {
      const input = document.getElementById('ai-input'); const log = document.getElementById('chat-log');
      const text = input.value.trim(); if(!text) return;
      log.innerHTML += `<div class="msg-row msg-me">${text}</div>`; input.value = ''; log.scrollTop = log.scrollHeight;
      
      const loadingId = "load-" + Date.now();
      log.innerHTML += `<div id="${loadingId}" class="msg-row msg-ai">ë‚˜ë£¨: (ìƒê° ì¤‘...)</div>`; log.scrollTop = log.scrollHeight;
      
      const reply = await callAI(text);
      document.getElementById(loadingId).remove();

      if(reply) {
          log.innerHTML += `<div class="msg-row msg-ai">ë‚˜ë£¨: ${reply}</div>`;
          showBubble(reply); 
      } else {
          log.innerHTML += `<div class="msg-sys">â€» ë¬´ë£Œ AI ì„œë²„ ì ‘ì† ì‹¤íŒ¨...!!</div>`;
      }
      log.scrollTop = log.scrollHeight;
    }

    function openBoard(type) { document.getElementById('board-title').innerText = type === 'diary' ? 'ğŸ““ Diary' : 'âœ¨ Character'; document.getElementById('page-content').innerHTML = `ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...`; openPopup('board-window'); loadPosts(type); }
    function openWrite() { currentEditId = null; document.getElementById('post-title').value = ''; CKEDITOR.instances['post-content'].setData(''); openPopup('write-window'); }
    
    async function savePost() {
      if (!sbClient) return;
      const category = document.getElementById('post-category').value; const title = document.getElementById('post-title').value; const content = CKEDITOR.instances['post-content'].getData();
      if(!title || !content.trim()) return alert("ë¹ˆì¹¸ì„ ì±„ì›Œ...!!");

      let err;
      if (currentEditId) err = (await sbClient.from('posts').update({ title, content, category }).eq('id', currentEditId)).error;
      else { err = (await sbClient.from('posts').insert([{ title, content, category }])).error; if(!err) earnPoints(100); }
      if(err) alert("ì‹¤íŒ¨...!!"); else { closePopup('write-window'); loadPosts(category); }
    }

    async function deletePost(id, category) { if(!confirm("ì§€ìš´ë‹¤...?")) return; await sbClient.from('posts').delete().eq('id', id); loadPosts(category); }
    
    function editPost(id) {
        const post = globalPostsData.find(p => p.id === id);
        if(!post) return;
        currentEditId = id; document.getElementById('post-category').value = post.category; document.getElementById('post-title').value = post.title;
        CKEDITOR.instances['post-content'].setData(post.content); openPopup('write-window');
    }

    async function loadPosts(categoryType) {
      if (!sbClient) return;
      const { data, error } = await sbClient.from('posts').select('*').eq('category', categoryType).order('created_at', { ascending: false });
      const list = document.getElementById('page-content');
      if(error || data.length === 0) { list.innerHTML = "<div style='color:#8a2be2;'>í…… ë¹„ì—ˆë‹¤...</div>"; return; }

      globalPostsData = data; 
      let html = '';
      data.forEach(p => {
        const dateStr = new Date(p.created_at).toLocaleString();
        html += `
          <div style="margin-bottom: 20px; border: 2px solid #dda0dd; border-radius:15px; overflow:hidden; background:rgba(255,255,255,0.8);">
            <div style="background: #f3e5f5; padding: 10px 15px; font-weight: bold; color: #8a2be2; display:flex; justify-content:space-between; align-items:center;">
                ğŸ“ ${p.title} 
                <div>
                    <button class="btn-action" style="padding:2px 8px; font-size:11px;" onclick="editPost('${p.id}')">ìˆ˜ì •</button>
                    <button class="btn-action" style="padding:2px 8px; font-size:11px;" onclick="deletePost('${p.id}', '${p.category}')">ì‚­ì œ</button>
                </div>
            </div>
            <div style="padding:15px;"><div style="font-size:11px; color:#aaa; margin-bottom:10px;">${dateStr}</div><div style="font-size:13px; line-height: 1.6;">${p.content}</div></div>
          </div>`;
      });
      list.innerHTML = html;
    }

    loadProfile();
  </script>
</body>

</html>
