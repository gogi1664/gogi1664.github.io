<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>The Interactive Nostalgia</title>
  <link href="https://cdn.jsdelivr.net/npm/galmuri@latest/dist/galmuri.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.ckeditor.com/4.22.1/standard/ckeditor.js"></script>

  <style>
    /* === ğŸ©¸ ê¸°ë³¸ ì„¤ì • === */
    body { background-color: #000; color: #ccc; font-family: 'Galmuri9', 'ê¶ì„œ', serif; margin: 0; padding: 0; overflow: hidden; cursor: crosshair; user-select: none; }
    #world-container { position: absolute; top: 0; left: 80px; width: calc(100vw - 80px); height: 100vh; overflow: hidden; }
    .world-view { display: none; width: 100%; height: 100%; position: relative; }
    .world-view.active { display: block; }

    /* === ğŸ’» ì¢Œì¸¡ ë©”ë‰´ë°” === */
    #left-taskbar { position: fixed; top: 0; left: 0; width: 80px; height: 100vh; background: #111; border-right: 2px solid #333; display: flex; flex-direction: column; align-items: center; padding-top: 30px; z-index: 9999; }
    .task-icon { width: 60px; margin-bottom: 25px; text-align: center; cursor: pointer; font-size: 10px; color: #888; transition: 0.2s; }
    .task-icon div { font-size: 24px; margin-bottom: 5px; filter: grayscale(1); transition: 0.2s;}
    .task-icon:hover { color: #fff; } .task-icon:hover div { filter: grayscale(0); transform: scale(1.1); }

    /* =========================================
       [ì°¨ì› 1] ì£¼ì¸ì˜ ì„¤ê³„ë„: ì™„ë²½í•œ ìŠ¤ì¼€ì¹˜ êµ¬ë„
       ========================================= */
    #view-room { 
        background: linear-gradient(to bottom, rgba(139, 0, 0, 0.9) 0%, rgba(210, 105, 30, 0.8) 40%, #cda043 40%, #9e7a2f 100%),
                    url('https://www.transparenttextures.com/patterns/floral-pattern.png');
        background-size: cover; background-position: center;
        position: relative; transition: filter 0.3s ease;
    }
    
    /* ğŸ’¡ ê¸°ë¯¹ 1: ì „ë“± & ì–´ë‘  */
    #room-darkness { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); pointer-events: none; z-index: 900; transition: 0.3s; opacity: 0; }
    .is-dark #room-darkness { opacity: 1; }
    #scene-light { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); width: 150px; height: 60px; background: rgba(255,255,255,0.9); border-radius: 50%; box-shadow: 0 0 80px #fff, 0 0 20px #ffeb3b; cursor: pointer; z-index: 1000; border: 4px solid #555; display: flex; justify-content: center; align-items: flex-end; padding-bottom: 5px; color: #000; font-size: 12px; font-weight: bold;}
    #scene-light:active { background: #fff; transform: translateX(-50%) scale(0.95); }

    /* ğŸªŸ ê¸°ë¯¹ 4: ì°½ë¬¸ & ìŸì•„ì§€ëŠ” ë¬¼ & ì‚¬ì„  ë¹› */
    #scene-window { position: absolute; top: 15%; right: 10%; width: 220px; height: 320px; border: 15px solid #5d4037; background: rgba(255, 200, 200, 0.6); cursor: pointer; z-index: 20; box-shadow: inset 0 0 30px rgba(0,0,0,0.6), 15px 15px 0px rgba(0,0,0,0.4); display: flex; justify-content: center; align-items: center; flex-direction: column; font-size: 16px; color: #fff; text-shadow: 2px 2px #000;}
    #scene-window:hover { filter: brightness(1.2); transform: scale(1.02); }
    #window-pot { width: 80px; height: 60px; background: #3e2723; border-radius: 10px; border: 3px solid #000; margin-bottom: 10px; font-size: 30px; display:flex; justify-content:center; align-items:center;}
    
    /* ìŸì•„ì§€ëŠ” ë¬¼ì¤„ê¸° */
    #waterfall { position: absolute; bottom: -250px; right: 20px; width: 180px; height: 250px; background: linear-gradient(to bottom, rgba(100, 150, 255, 0.4), rgba(100, 150, 255, 0.8)); animation: flow 1s infinite linear; pointer-events: none;}
    @keyframes flow { 0% { background-position: 0 0; } 100% { background-position: 0 100px; } }
    #water-puddle { position: absolute; bottom: -270px; right: -40px; width: 350px; height: 80px; background: rgba(100, 150, 255, 0.7); border-radius: 50%; transform: scaleY(0.4); pointer-events: none; box-shadow: 0 0 20px rgba(100,150,255,0.5);}

    /* âœ¨ ìŠ¤ì¼€ì¹˜ì˜ ì‚¬ì„  ì¡°ëª… íš¨ê³¼ */
    #light-beam { position: absolute; top: 15%; right: 10%; width: 60%; height: 80%; background: linear-gradient(120deg, rgba(255,200,150,0.3) 0%, rgba(255,100,50,0.1) 50%, transparent 80%); clip-path: polygon(100% 0, 100% 40%, 0 100%, 0 60%); z-index: 15; pointer-events: none; mix-blend-mode: screen; }

    /* ğŸ¦â€â¬› ê¸°ë¯¹ 2: ì „ë´‡ëŒ€ì™€ ê¹Œë§ˆê·€ (ì¢Œì¸¡ ë°°ì¹˜) */
    #scene-pole { position: absolute; top: 10%; left: 15%; width: 25px; height: 350px; background: #1a1a1a; border-left: 5px solid #000; z-index: 10; box-shadow: 10px 10px 0 rgba(0,0,0,0.3);}
    #scene-wire { position: absolute; top: 20%; left: -5%; width: 50%; height: 3px; background: #000; z-index: 9; transform: rotate(5deg); box-shadow: 5px 5px 0 rgba(0,0,0,0.3);}
    .crow { position: absolute; top: -25px; font-size: 28px; cursor: pointer; transition: 1s cubic-bezier(0.25, 1, 0.5, 1); z-index: 15; filter: drop-shadow(3px 3px 0 #000);}
    #crow1 { left: 40%; } #crow2 { left: 55%; } #crow3 { left: 70%; }
    .crow.fly { transform: translate(500px, -500px) scale(2); opacity: 0; pointer-events: none; }

    /* ğŸ‘¤ ê¸°ë¯¹ 3: ìºë¦­í„° ê·¸ë¦¼ì (ë¹›ì„ ë°›ëŠ” ì¤‘ì•™ ë°°ì¹˜) */
    #scene-character { position: absolute; bottom: 35%; left: 40%; width: 120px; height: 280px; background: #111; border-radius: 60px 60px 15px 15px; cursor: pointer; z-index: 50; filter: drop-shadow(15px 15px 0px rgba(0,0,0,0.6)); transition: 0.2s; display: flex; justify-content: center; align-items: center; color: #fff; font-weight: bold; background-position: center; background-repeat: no-repeat;}
    #scene-character:hover { transform: scale(1.05) translateY(-5px); filter: brightness(1.2) drop-shadow(20px 20px 0px rgba(0,0,0,0.4)); }
    #scene-character:active { transform: scale(0.95); }

    /* ğŸª´ ê¸°ë¯¹ 5: ê¹¨ì§€ëŠ” í™”ë¶„ë“¤ (ìŠ¤ì¼€ì¹˜ ìœ„ì¹˜ ë°˜ì˜) */
    .scene-pot { position: absolute; cursor: pointer; z-index: 60; transition: 0.2s; display: flex; flex-direction: column; align-items: center; filter: drop-shadow(5px 5px 0px rgba(0,0,0,0.5));}
    .scene-pot .plant { font-size: 70px; margin-bottom: -20px; z-index: 61; transition: 0.3s; }
    .scene-pot .base { width: 90px; height: 90px; background: #e0e0e0; border-radius: 10px 10px 45px 45px; border: 4px solid #888; z-index: 62; box-shadow: inset -15px -15px 0px rgba(0,0,0,0.2);}
    #pot1 { bottom: 20%; left: 35%; } /* ìºë¦­í„° ì•„ë˜ìª½ */
    #pot2 { bottom: 45%; left: 20%; } /* ì „ë´‡ëŒ€ ê·¼ì²˜ */
    .scene-pot.broken .plant { opacity: 0; transform: translateY(50px) rotate(45deg); pointer-events: none; }
    .scene-pot.broken .base { background: transparent; border: none; box-shadow: none; font-size: 60px; line-height: 90px; }

    /* ğŸ›ï¸ ê±°ëŒ€ ì´ë¶ˆ (ì¢Œì¸¡ í•˜ë‹¨) */
    #scene-bed { position: absolute; bottom: -5%; left: 5%; width: 35%; height: 40%; background: #f48fb1; border-radius: 30px 30px 0 0; border: 6px solid #d81b60; z-index: 40; box-shadow: 20px 20px 0px rgba(0,0,0,0.3); cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 26px; color: #fff; font-weight: bold; text-shadow: 3px 3px 0px #000; transform: perspective(800px) rotateX(30deg) rotateZ(-10deg); transition: 0.3s; background-size: cover; background-position: center;}
    #scene-bed:hover { transform: perspective(800px) rotateX(30deg) rotateZ(-10deg) translateY(-15px); filter: brightness(1.1); }
    #scene-pillow { position: absolute; top: 10%; left: 10%; width: 140px; height: 70px; background: #fff; border-radius: 35px; border: 4px solid #ccc; box-shadow: 5px 5px 0px rgba(0,0,0,0.2); transform: rotate(10deg); }

    /* =========================================
       íŒì—…ì°½ & ê³µí†µ ë””ìì¸ 
       ========================================= */
    .cute-popup { position: absolute; display: none; background: rgba(15,15,15,0.95); border: 4px solid #fff; box-shadow: 15px 15px 0px rgba(0,0,0,0.7); overflow: hidden; width: 450px; color: #ddd; z-index: 2000; }
    .cute-titlebar { background: #fff; color: #000; padding: 10px; font-size: 14px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; cursor: grab; }
    .cute-body { padding: 15px; max-height: 60vh; overflow-y: auto; background: #222;}
    .close-x { cursor: pointer; color: #fff; background: #c0392b; padding: 2px 8px; border: 2px solid #000; font-weight: bold;}
    .close-x:hover { background: #ff0000; }
    
    .btn-action { background: #333; color: #fff; border: 3px solid #000; padding: 8px 15px; font-family: 'Galmuri9'; cursor: pointer; transition: 0.1s; box-shadow: 2px 2px 0 #000;}
    .btn-action:hover { background: #f1c40f; color: #000;}
    .btn-action:active { transform: translate(2px, 2px); box-shadow: none;}
    .cute-input { width: 100%; padding: 8px; margin-bottom: 10px; background: #000; border: 2px solid #555; color: #fff; font-family: 'Galmuri9'; box-sizing: border-box; outline: none;}

    #item-drop-zone { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; overflow: hidden;}
    .dropped-item { position: absolute; font-size: 50px; filter: drop-shadow(4px 4px 0px #000); animation: itemFall 0.5s forwards; pointer-events: auto; cursor: grab;}
    @keyframes itemFall { 0% { transform: translateY(-100px) rotate(-360deg); opacity:0; } 100% { transform: translateY(0) rotate(0deg); opacity:1; } }
  </style>
</head>
<body id="main-body">

  <div id="world-container">
      
      <div id="view-room" class="world-view active">
          <div id="room-darkness"></div> 
          <div id="light-beam"></div>
          <div id="item-drop-zone"></div>

          <div id="scene-light" onclick="toggleLight()">ë”¸ê¹! (ì „ë“±)</div>

          <div id="scene-pole"></div>
          <div id="scene-wire">
              <div class="crow" id="crow1" onclick="flyCrow(this)">ğŸ¦â€â¬›</div>
              <div class="crow" id="crow2" onclick="flyCrow(this)">ğŸ¦â€â¬›</div>
              <div class="crow" id="crow3" onclick="flyCrow(this)">ğŸ¦â€â¬›</div>
          </div>

          <div id="scene-window" onclick="switchWorld('view-station')">
              <div id="window-pot">â™¨ï¸</div>
              <span style="z-index: 25; text-align:center;">ì°½ë¬¸ ì—´ê³ <br>ì´ë™í•˜ê¸°</span>
              <div id="waterfall"></div>
              <div id="water-puddle"></div>
          </div>

          <div id="scene-character" onclick="openPopup('ai-window')">ë§ê±¸ê¸°</div>

          <div class="scene-pot" id="pot1" onclick="breakPot(this)">
              <div class="plant">ğŸŒ¿</div><div class="base"></div>
          </div>
          <div class="scene-pot" id="pot2" onclick="breakPot(this)">
              <div class="plant">ğŸŒµ</div><div class="base"></div>
          </div>

          <div id="scene-bed" onclick="openPopup('board-window')">
              <div id="scene-pillow"></div>
              <span style="transform: rotate(10deg); display:inline-block;">ì¹¨ëŒ€<br>(ë¹„ë°€ ì¼ê¸°ì¥)</span>
          </div>

          <button class="btn-action" style="position:absolute; bottom:20px; right:20px; z-index: 100;" onclick="openPopup('profile-window')">âš™ï¸ ì„¤ì •</button>
          <button class="btn-action" style="position:absolute; bottom:20px; right:120px; z-index: 100;" onclick="openPopup('shop-window')">ğŸ›’ ì•”ì‹œì¥</button>
      </div>

      <div id="view-station" class="world-view">
          <div style="position:absolute; top:20%; width:100%; text-align:center; color:#fff; font-size:32px;">ê¸°ì°¨ì—­ ê³µì‚¬ì¤‘...</div>
      </div>
      <div id="view-aqua" class="world-view">
          <div style="position:absolute; top:20%; width:100%; text-align:center; color:#fff; font-size:32px;">ìˆ˜ì¡±ê´€ ê³µì‚¬ì¤‘...</div>
      </div>

  </div> 

  <div id="left-taskbar">
      <div class="task-icon" onclick="switchWorld('view-room')"><div>ğŸ </div>Room</div>
      <div class="task-icon" onclick="switchWorld('view-station')"><div>ğŸš‚</div>Station</div>
      <div class="task-icon" onclick="switchWorld('view-aqua')"><div>ğŸŒŠ</div>Aqua</div>
  </div>

  <div id="profile-window" class="cute-popup">
      <div class="cute-titlebar"><span>âš™ï¸ SETUP</span><span class="close-x" onclick="closePopup('profile-window')">X</span></div>
      <div class="cute-body">
          <p style="font-size:11px; color:#f1c40f;">â€» íŒŒì¼ì„ ì„ íƒí•´ ìš”ì†Œë“¤ì˜ ê»ë°ê¸°ë¥¼... ê°ˆì•„ì¹˜ìš°ì‹­ì‹œì˜¤...</p>
          <div style="margin-bottom:10px;">ğŸ–¼ï¸ ë°°ê²½ êµì²´: <input type="file" accept="image/*" class="cute-input" onchange="handleImageUpload(event, 'bg')"></div>
          <div style="margin-bottom:10px;">ğŸ‘¤ ìºë¦­í„° êµì²´: <input type="file" accept="image/*" class="cute-input" onchange="handleImageUpload(event, 'char')"></div>
          <div style="margin-bottom:10px;">ğŸ›ï¸ ì¹¨ëŒ€ ì»¤ë²„ êµì²´: <input type="file" accept="image/*" class="cute-input" onchange="handleImageUpload(event, 'bed')"></div>
          <hr style="border-color:#444; margin:15px 0;">
          <div style="text-align:right;"><button class="btn-action" onclick="resetImages()">ì´ë¯¸ì§€ ì´ˆê¸°í™”</button> <button class="btn-action" onclick="closePopup('profile-window')">ë‹«ê¸°</button></div>
      </div>
  </div>

  <div id="ai-window" class="cute-popup">
      <div class="cute-titlebar"><span>ğŸ’¬ MESSENGER</span><span class="close-x" onclick="closePopup('ai-window')">X</span></div>
      <div class="cute-body"><div style="color:#fff;">ëŒ€í™” ì‹œìŠ¤í…œ ì—°ê²° ëŒ€ê¸°ì¤‘...</div></div>
  </div>
  <div id="board-window" class="cute-popup">
      <div class="cute-titlebar"><span>ğŸ€ Board</span><span class="close-x" onclick="closePopup('board-window')">X</span></div>
      <div class="cute-body"><div style="color:#fff;">ê²Œì‹œíŒ ì—°ê²° ëŒ€ê¸°ì¤‘...</div></div>
  </div>
  <div id="shop-window" class="cute-popup">
      <div class="cute-titlebar"><span>ğŸ›’ BLACK MARKET</span><span class="close-x" onclick="closePopup('shop-window')">X</span></div>
      <div class="cute-body" style="text-align:center;"><h3 style="color:#f1c40f;">1000 P</h3><button class="btn-action" onclick="buyDummyItem('ì¹¼', 'ğŸ”ª')">ì¹¼ ì‚¬ê¸°(300P)</button></div>
  </div>

  <script>
    let highestZ = 3000;

    // íŒì—… ì œì–´
    function openPopup(id) { const el = document.getElementById(id); el.style.display = 'block'; el.style.zIndex = ++highestZ; }
    function closePopup(id) { document.getElementById(id).style.display = 'none'; }
    function switchWorld(vid) { document.querySelectorAll('.world-view').forEach(e => e.classList.remove('active')); document.getElementById(vid).classList.add('active'); }
    function toggleLight() { document.getElementById('view-room').classList.toggle('is-dark'); }
    function flyCrow(el) { el.classList.add('fly'); setTimeout(() => el.classList.remove('fly'), 5000); }
    function breakPot(el) { 
        if(!el.classList.contains('broken')) {
            el.classList.add('broken');
            el.querySelector('.base').innerText = 'ğŸ’¥';
            setTimeout(() => { el.classList.remove('broken'); el.querySelector('.base').innerText = '';}, 4000);
        }
    }

    // ë“œë˜ê·¸ ê¸°ëŠ¥
    function makeDraggable(winId) { 
        const win = document.getElementById(winId); const dragArea = win.querySelector('.cute-titlebar'); if(!dragArea) return;
        let p1=0, p2=0, p3=0, p4=0; win.onmousedown = () => win.style.zIndex = ++highestZ; 
        dragArea.onmousedown = (e) => { e.preventDefault(); p3=e.clientX; p4=e.clientY; document.onmouseup = () => { document.onmouseup=null; document.onmousemove=null; }; document.onmousemove = (e) => { e.preventDefault(); p1=p3-e.clientX; p2=p4-e.clientY; p3=e.clientX; p4=e.clientY; win.style.top=(win.offsetTop-p2)+"px"; win.style.left=(win.offsetLeft-p1)+"px"; }; }; 
    }
    ['profile-window', 'ai-window', 'board-window', 'shop-window'].forEach(makeDraggable);

    // === ğŸ–¼ï¸ íŒŒì¼ ì„ íƒ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œìŠ¤í…œ ===
    function handleImageUpload(event, targetElement) {
        const file = event.target.files[0];
        if(!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const dataUrl = e.target.result;
            let savedImages = JSON.parse(localStorage.getItem('myRoomImages')) || {};
            
            if(targetElement === 'bg') {
                document.getElementById('view-room').style.backgroundImage = `url(${dataUrl})`;
                savedImages.bg = dataUrl;
            } else if(targetElement === 'char') {
                const charEl = document.getElementById('scene-character');
                charEl.style.backgroundImage = `url(${dataUrl})`;
                charEl.innerHTML = ''; // ê¸€ì ì œê±°
                charEl.style.backgroundColor = 'transparent';
                charEl.style.border = 'none';
                savedImages.char = dataUrl;
            } else if(targetElement === 'bed') {
                const bedEl = document.getElementById('scene-bed');
                bedEl.style.backgroundImage = `url(${dataUrl})`;
                bedEl.style.backgroundColor = 'transparent';
                savedImages.bed = dataUrl;
            }
            
            localStorage.setItem('myRoomImages', JSON.stringify(savedImages));
        };
        reader.readAsDataURL(file);
    }

    function loadSavedImages() {
        const savedImages = JSON.parse(localStorage.getItem('myRoomImages')) || {};
        if(savedImages.bg) document.getElementById('view-room').style.backgroundImage = `url(${savedImages.bg})`;
        if(savedImages.char) {
            const charEl = document.getElementById('scene-character');
            charEl.style.backgroundImage = `url(${savedImages.char})`;
            charEl.innerHTML = ''; charEl.style.backgroundColor = 'transparent'; charEl.style.border = 'none';
        }
        if(savedImages.bed) {
            const bedEl = document.getElementById('scene-bed');
            bedEl.style.backgroundImage = `url(${savedImages.bed})`;
            bedEl.style.backgroundColor = 'transparent';
        }
    }

    function resetImages() {
        localStorage.removeItem('myRoomImages');
        location.reload(); // ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ê¸°ë³¸ CSSë¡œ ë³µêµ¬
    }

    function buyDummyItem(n, icon) {
        const layer = document.getElementById('item-drop-zone');
        const el = document.createElement('div');
        el.className='dropped-item';
        el.style.left = (Math.random()*60 + 20) + '%';
        el.style.top = (Math.random()*40 + 40) + '%';
        el.innerText = icon;
        layer.appendChild(el);
    }

    // ì´ˆê¸° ë¡œë”©
    window.onload = () => {
        loadSavedImages();
    };

  </script>
</body>
</html>
