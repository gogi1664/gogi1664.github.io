<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>My Messy Yellow Room</title>
  <link href="https://cdn.jsdelivr.net/npm/galmuri@latest/dist/galmuri.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.ckeditor.com/4.22.1/standard/ckeditor.js"></script>

  <style>
    /* === ğŸ©¸ ê¸°ë³¸ ì„¤ì • ë° ì»¤ì„œ === */
    body { 
        background-color: #000; color: #ccc;
        font-family: 'Galmuri9', 'ê¶ì„œ', serif; margin: 0; padding: 0; overflow: hidden; 
        cursor: url('https://cdn.pixabay.com/pixabay/img/cursor/crosshair.png'), crosshair; /* ì‹­ì ì»¤ì„œ */
    }
    
    /* === ğŸ’» ì¢Œì¸¡ ì‹œìŠ¤í…œ ë©”ë‰´ë°” (ìŠ¬ë¦¼ ë²„ì „) === */
    #left-taskbar {
        position: fixed; top: 0; left: 0; width: 80px; height: 100vh;
        background: #2c3e50; border-right: 3px solid #1a252f; outline: 1px solid #000;
        display: flex; flex-direction: column; align-items: center; padding-top: 30px; z-index: 500;
        box-shadow: inset -2px -2px 0px rgba(0,0,0,0.5), inset 2px 2px 0px rgba(255,255,255,0.1);
    }
    .task-icon {
        width: 60px; height: 70px; margin-bottom: 25px; text-align: center; cursor: pointer;
        font-size: 11px; color: #bdc3c7; font-weight: bold; text-shadow: 1px 1px 0px #000;
        transition: 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    .task-icon img { width: 40px; height: 40px; margin-bottom: 8px; filter: drop-shadow(3px 3px 0px #000); transition: 0.2s;}
    .task-icon:active img { transform: translate(2px, 2px); filter: brightness(0.7); }
    .task-icon:hover { color: #f1c40f; } .task-icon:hover img { transform: scale(1.1); }

    /* === ğŸŒŒ ì°¨ì›(ìŠ¤í¬ë¦°) ì»¨í…Œì´ë„ˆ === */
    #world-container {
        position: absolute; top: 0; left: 80px; width: calc(100vw - 80px); height: 100vh; overflow: hidden;
    }
    .world-view { display: none; width: 100%; height: 100%; position: relative; }
    .world-view.active { display: block; }

    /* [ì°¨ì› 1] ë¡œë¹„: êµ¬ì§€ë ˆí•œ ë…¸ë€ì¥íŒ ì›ë£¸ */
    #view-room { 
        background-color: #dcb35a;
        background-image: 
            linear-gradient(to bottom, rgba(255,255,255,0.8) 0%, rgba(240,230,200,0.6) 50%, rgba(220,179,90,0.9) 50%, rgba(200,150,50,1) 100%),
            url('https://www.transparenttextures.com/patterns/worn-dots.png');
        background-size: auto; background-attachment: fixed;
    }
    /* ë°© ì˜¤ë¸Œì íŠ¸ (ê³ ì •) */
    .room-obj { position: absolute; pointer-events: none; z-index: 1; filter: drop-shadow(5px 5px 10px rgba(0,0,0,0.3)); }
    .obj-window { top: 10%; right: 5%; width: 250px; opacity: 0.9; border: 4px solid #5d4037; background: url('https://cdn.pixabay.com/photo/2018/01/24/18/05/window-3104655_1280.jpg') no-repeat center/cover;} /* ì°½ë¬¸ */
    .obj-closet { bottom: 5%; left: 5%; width: 300px; height: 500px; background: url('https://cdn.pixabay.com/photo/2015/12/08/00/33/wardrobe-1081670_1280.png') no-repeat center/contain; } /* ì˜·ì¥ */
    .obj-bedding { bottom: 2%; right: 15%; width: 400px; background: url('https://cdn.pixabay.com/photo/2017/08/06/09/52/blanket-2591473_1280.png') no-repeat center/contain; transform: rotate(5deg); opacity:0.9;} /* ì´ë¶ˆ */
    .obj-mold { top: 5%; left: 5%; width: 200px; height: 200px; background: url('https://www.transparenttextures.com/patterns/black-felt.png'); opacity: 0.3; mix-blend-mode: multiply; mask-image: radial-gradient(circle, rgba(0,0,0,1) 0%, rgba(0,0,0,0) 70%); } /* ê³°íŒ¡ì´ */

    /* í˜•ê´‘ë“± ìŠ¤ìœ„ì¹˜ (ìƒí˜¸ì‘ìš© ê°€ëŠ¥) */
    .light-switch {
        position: absolute; top: 40%; left: 2%; width: 50px; height: 80px; background: #eceff1; border: 3px solid #cfd8dc;
        cursor: pointer; z-index: 15; box-shadow: 3px 3px 5px rgba(0,0,0,0.2); display: flex; justify-content: center; align-items: center;
    }
    .light-switch:active { background: #cfd8dc; box-shadow: inset 2px 2px 5px rgba(0,0,0,0.2); }
    .switch-knob { width: 20px; height: 40px; background: #fff; border: 1px solid #b0bec5; transition: 0.1s; }
    .light-switch:active .switch-knob { transform: translateY(5px); }
    /* ë°© ì ë©¸ íš¨ê³¼ */
    @keyframes flickerAnim { 0% { filter: brightness(1); } 10% { filter: brightness(0.3); } 20% { filter: brightness(1); } 30% { filter: brightness(0.5); } 100% { filter: brightness(1); } }
    .room-flicker { animation: flickerAnim 0.5s linear; }

    /* [ì°¨ì› 2] ë…¸ì„ì§„ ê¸°ì°¨ì—­ */
    #view-station { 
        background: url('https://cdn.pixabay.com/photo/2017/03/27/14/56/train-station-2179044_1280.jpg') no-repeat center center/cover;
    }
    .station-filter { position: absolute; width:100%; height:100%; background: rgba(255, 100, 0, 0.3); mix-blend-mode: overlay; pointer-events: none;}

    /* [ì°¨ì› 3] ì•„ì¿ ì•„ë¦¬ì›€ */
    #view-aqua { 
        background: linear-gradient(to bottom, #001f3f, #0074d9);
        background-image: url('https://www.transparenttextures.com/patterns/underwater.png');
    }
    .aqua-obj { position: absolute; pointer-events: none; z-index: 5; animation: floatSwim linear infinite; filter: blur(1px) brightness(0.8); opacity: 0.7;}
    .f-fish1 { top: 20%; left: -10%; font-size: 60px; animation-duration: 25s; }
    .f-fish2 { top: 60%; right: -10%; font-size: 80px; animation-duration: 35s; animation-delay: -5s; transform: scaleX(-1); animation-direction: reverse;}
    .f-jelly { top: 40%; left: 50%; font-size: 50px; animation: floatJelly 20s ease-in-out infinite; }
    @keyframes floatSwim { 0% { transform: translateX(0) rotate(5deg); } 100% { transform: translateX(120vw) rotate(-5deg); } }
    @keyframes floatJelly { 0%, 100% { transform: translate(0, 0); } 50% { transform: translate(20px, -50px); } }

    /* === ğŸ¬ íŒì—… ì• ë‹ˆë©”ì´ì…˜ === */
    @keyframes popDark { 0% { transform: scale(0.7); opacity: 0; filter: blur(2px);} 70% { transform: scale(1.05); } 100% { transform: scale(1); opacity: 1; filter: blur(0); } }
    .pop-anim { animation: popDark 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }

    /* === ğŸ€ í©ì–´ì§„ ìŠ¤í‹°ì»¤ ë²„íŠ¼ë“¤ (ë¡œë¹„ë¡œ ì´ì£¼ ì™„ë£Œ) === */
    .scattered-btn {
        position: absolute; background: rgba(0,0,0,0.7); border: 2px dashed #fff; border-radius: 15px;
        padding: 8px 12px; font-weight: bold; color: #fff; font-size: 13px; font-family: 'Galmuri9';
        cursor: pointer; box-shadow: 3px 3px 5px rgba(0,0,0,0.5); z-index: 20; transition: 0.15s; user-select: none; white-space: nowrap;
        backdrop-filter: blur(2px);
    }
    .scattered-btn:hover { transform: scale(1.1) rotate(0deg) !important; background: rgba(255,255,255,0.9); color:#000; border-style: solid;}
    .scattered-btn:active { transform: scale(0.95) !important; box-shadow: none; }
    
    /* ë²„íŠ¼ ë°°ì¹˜ (ë¡œë¹„ ë‚´ ë³µì‘ë³µì‘í•˜ê²Œ) */
    .btn-diary { top: 25%; left: 30%; transform: rotate(-5deg); background: #8e44ad; border-color: #c0392b; } 
    .btn-char  { top: 40%; left: 45%; transform: rotate(3deg); background: #2980b9; }
    .btn-review { top: 20%; left: 65%; transform: rotate(8deg); background: #16a085; } 
    .btn-guest { top: 55%; left: 20%; transform: rotate(-10deg); background: #d35400; }
    .btn-write { top: 75%; left: 40%; transform: rotate(-2deg); font-size: 15px; padding: 10px 18px; background: #27ae60; }
    
    /* ìƒˆë¡œ ì´ì£¼í•œ ë²„íŠ¼ë“¤ */
    .btn-verify { top: 15%; left: 10%; transform: rotate(15deg); background: #c0392b; color:#f1c40f; border-radius: 50px; } /* ì•Œì•½ ëª¨ì–‘ */
    .btn-setting { top: 65%; left: 55%; transform: rotate(5deg); background: #7f8c8d; border-radius: 50%; width: 50px; height: 50px; display: flex; justify-content: center; align-items: center; padding:0;} /* í†±ë‹ˆë°”í€´ ëª¨ì–‘ */

    /* ìœ„ì¹˜ ìˆ˜ì •ëœ ë²„íŠ¼ë“¤ */
    .btn-shop { top: 80%; right: 5%; transform: rotate(5deg); background: #f39c12; color:#000; z-index: 25;} /* í«ê³¼ ì•ˆ ê²¹ì¹˜ê²Œ ìš°ì¸¡ í•˜ë‹¨ìœ¼ë¡œ */

    /* ì•„ì¿ ì•„ë¦¬ì›€ ì˜¤ë½ê¸° ë²„íŠ¼ */
    .btn-dolphin { top: 60%; left: 50%; transform: translate(-50%,-50%) scale(1.5); border: 3px dotted #00bcd4; color:#00bcd4; background: rgba(0,0,0,0.6); font-family: 'Impact'; z-index: 10;}

    /* === ğŸ’» ê³µí†µ íŒì—…ì°½ (ë“œë˜ê·¸ ê°€ëŠ¥) === */
    .cute-popup {
        position: absolute; display: none; background: rgba(20,20,20,0.95); border: 2px solid #555;
        box-shadow: 15px 15px 0px rgba(0,0,0,0.6); overflow: hidden; width: 450px; color: #ccc;
    }
    .cute-titlebar {
        background: #34495e; color: #ecf0f1; padding: 6px 10px; font-weight: bold; font-size: 12px; font-family: 'Galmuri9';
        display: flex; justify-content: space-between; align-items: center; user-select: none; cursor: grab; border-bottom: 3px solid #2c3e50;
    }
    .cute-titlebar:active { cursor: grabbing; }
    .cute-title-btns span { display: inline-block; width: 14px; height: 14px; background: #e74c3c; border: 2px outset #c0392b; cursor: pointer; border-radius: 50%;}
    .cute-title-btns span:active { border-style: inset; background: #c0392b;}
    .cute-body { padding: 15px; max-height: 65vh; overflow-y: auto; background: #2c3e50;}
    .cute-body::-webkit-scrollbar { width: 10px; background: #1a252f;}
    .cute-body::-webkit-scrollbar-thumb { background: #95a5a6; border: 2px outset #ecf0f1; }

    /* íŒì—… ì´ˆê¸° ìœ„ì¹˜ */
    #captcha-window { width: 350px; top: 15%; left: 25%; }
    #write-window { width: 700px; top: 10%; left: 15%; }
    #board-window { width: 600px; top: 15%; left: 20%; }
    #ai-window { width: 320px; top: 40%; right: 10%; } /* í« ê·¼ì²˜ */
    #shop-window { width: 350px; top: 30%; left: 30%; }
    #music-window { width: 300px; top: 5%; left: 65%; }
    #profile-window { width: 400px; top: 25%; left: 30%;}
    #dolphin-window { width: 350px; top: 15%; left: 45%; border-color: #00bcd4; }

    /* === ğŸ¾ ì‹œë©”ì§€ (ìƒì¡´ì) - ìœ„ì¹˜ ìˆ˜ì • ë° ì•ˆì •ëœ ì´ë¯¸ì§€ === */
    #shimeji-room { position: absolute; top: 65%; right: 10%; z-index: 999; text-align: center; cursor: grab; transition: top 1.5s linear, left 1.5s linear; }
    #shimeji-room:active { cursor: grabbing; transition: none; }
    #pet-bubble { background: #fff; border: 2px solid #000; padding: 5px; font-size: 11px; color: #000; margin-bottom: 5px; opacity:0; transition: opacity 0.3s; font-weight: bold;}
    #pet-image { width: 100px; height: 100px; object-fit: contain; filter: drop-shadow(3px 3px 5px rgba(0,0,0,0.5)); transform: scaleX(var(--flip, 1)); }
    .is-walking { animation: bounce 0.3s infinite; }
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }

    /* === í¼ & UI ìš”ì†Œ (êµ¬ì§€ë ˆí•œ ëŠë‚Œ) === */
    .player-controls { display: flex; gap: 8px; justify-content: center; margin-bottom: 10px;}
    .ctrl-btn { background: #95a5a6; border: 3px outset #bdc3c7; width: 35px; height: 35px; cursor: pointer; font-size: 12px; color: #000; display:flex; justify-content:center; align-items:center;}
    .ctrl-btn:active { border-style: inset; background: #7f8c8d; }
    .music-info { font-size: 11px; color: #f1c40f; background:#1a252f; padding:5px; border: 2px inset #34495e; text-align: center;}
    .input-row { display: flex; flex-direction: column; margin-bottom: 15px; }
    .input-row label { font-size: 12px; color: #bdc3c7; margin-bottom: 5px; font-weight: bold;}
    .cute-input { padding: 8px; border: 2px inset #34495e; background: #ecf0f1; color: #000; font-family: 'Galmuri9'; outline: none;}
    .btn-action { font-family: 'Galmuri9'; font-size: 12px; padding: 6px 15px; cursor: pointer; border: 3px outset #bdc3c7; background: #95a5a6; color: #000; font-weight: bold; }
    .btn-action:active { border-style: inset; background: #7f8c8d;}
    
    .chat-body { height: 250px; background: #ecf0f1; border: 2px inset #34495e; overflow-y: auto; padding: 10px; font-size: 12px; color: #000;}
    .msg-row { margin-bottom: 8px; line-height: 1.4; padding: 8px; border-radius: 5px; width: fit-content; max-width: 85%; box-shadow: 2px 2px 0px rgba(0,0,0,0.2);}
    .msg-ai { background: #e74c3c; color: #fff; float: left; clear: both; font-weight: bold;} .msg-me { background: #3498db; color: #fff; text-align: right; float: right; clear: both; }

    /* === ğŸ“ ì•„ì½”ë””ì–¸ ê²Œì‹œíŒ === */
    .post-item { margin-bottom: 10px; border: 3px outset #7f8c8d; background: #bdc3c7; color: #000;}
    .post-header { padding: 8px 12px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border-bottom: 1px solid #7f8c8d;}
    .post-header:active { background: #a0a0a0; }
    .post-content-area { padding: 15px; display: none; border-top: 2px inset #ecf0f1; font-size: 12px; line-height: 1.6; background: #ecf0f1;}

    /* === ğŸ¤– ë¡œë´‡ ê²€ì¦ (íŒì—… ë‚´ë¶€) === */
    .captcha-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-bottom: 15px; }
    .captcha-grid img { width: 100%; height: 70px; object-fit: cover; cursor: pointer; border: 3px solid #34495e; filter: grayscale(100%); transition:0.1s;}
    .captcha-grid img:active { border-color: #e74c3c; filter: grayscale(0%); transform: scale(0.9);}
    .captcha-btn { width: 100%; padding: 10px; background: #c0392b; color: #fff; border: 3px outset #e74c3c; font-weight: bold; cursor: pointer; font-family: 'Galmuri9';}
    .captcha-btn:active { border-style: inset; background: #a93226; }

    /* === ğŸ¬ ëŒê³ ë˜ ì•„ì¼€ì´ë“œ (ë²„ê·¸ ìˆ˜ì • ë° ë””ìì¸ ê°œì„ ) === */
    #dolphin-game-area { width: 300px; height: 350px; background: linear-gradient(to bottom, #0288d1, #26c6da, #80deea); border: 5px inset #00838f; margin: 0 auto; position: relative; overflow: hidden; box-shadow: inset 0 0 20px rgba(0,0,0,0.5);}
    .dolphin-deco { position: absolute; font-size: 40px; opacity: 0.6; color: #fff; user-select: none; filter: drop-shadow(2px 2px 0px #00838f);}
    /* ë§ ë””ìì¸ ê°œì„  */
    .ring { width: 28px; height: 28px; border: 5px solid; border-radius: 50%; position: absolute; box-shadow: 2px 2px 5px rgba(0,0,0,0.4); transition: top 0.1s ease-out, left 0.1s ease-out; background: rgba(255,255,255,0.2);}
    /* ê¸°ë‘¥ ë””ìì¸ ê°œì„  (ì¶©ëŒ ë²”ìœ„ì™€ ì‹œê°ì  ì¼ì¹˜) */
    .post { width: 12px; height: 130px; background: linear-gradient(to right, #ff7043, #d84315); position: absolute; bottom: 0; border-radius: 6px 6px 0 0; border: 2px solid #bf360c; box-shadow: 3px 3px 5px rgba(0,0,0,0.3);}
    .pump-btn { width: 65px; height: 65px; background: #26c6da; border: 4px outset #80deea; border-radius: 50%; cursor: pointer; font-size: 22px; color: #fff; display: flex; justify-content: center; align-items: center; user-select: none; transition: 0.1s; text-shadow: 1px 1px 0px #00838f;}
    .pump-btn:active { border-style: inset; background: #00bcd4; transform: scale(0.95); color:#e0f7fa;}
    #dolphin-ui-top { display: flex; justify-content: space-between; padding: 8px 12px; background: #00838f; color: #fff; font-family: 'Galmuri9'; font-size: 14px; border-bottom: 3px solid #006064; font-weight: bold; text-shadow: 1px 1px 0px #000;}
    #dolphin-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10; color: #fff; font-size: 18px; font-family: 'ê¶ì„œ'; text-align: center; text-shadow: 2px 2px 0px #000;}

    /* ì•”ì‹œì¥ ì•„ì´í…œ ë‚™í•˜ */
    #item-drop-zone { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10000; overflow: hidden;}
    .dropped-item { position: absolute; font-size: 35px; filter: drop-shadow(3px 3px 5px rgba(0,0,0,0.7)); animation: itemFall 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
    @keyframes itemFall { 0% { transform: translateY(-100px) rotate(-360deg); opacity:0; } 100% { transform: translateY(0) rotate(0deg); opacity:1; } }

    /* ë§ˆìš°ìŠ¤ íˆ´íŒ */
    #custom-tooltip { position: absolute; display: none; z-index: 9999999; background: #fff; border: 2px solid #000; padding: 5px 10px; font-size: 11px; font-family: 'Galmuri9'; color: #000; pointer-events: none; white-space: nowrap; box-shadow: 4px 4px 0px rgba(0,0,0,0.5); font-weight: bold;}
  </style>
</head>
<body id="main-body">

  <div id="world-container">
      
      <div id="view-room" class="world-view active">
          <div id="item-drop-zone"></div> <div class="room-obj obj-window"></div>
          <div class="room-obj obj-closet"></div>
          <div class="room-obj obj-bedding"></div>
          <div class="room-obj obj-mold"></div>
          
          <div class="light-switch" onclick="flickerRoom()" data-tooltip="í˜•ê´‘ë“±">
              <div class="switch-knob"></div>
          </div>

          <button class="scattered-btn btn-diary" onclick="openBoard('diary')">ğŸ““ ë¹„ë°€ ì¼ê¸°</button>
          <button class="scattered-btn btn-char" onclick="openBoard('character')">âœ¨ ìºë¦­í„° ë±</button>
          <button class="scattered-btn btn-review" onclick="openBoard('review')">ğŸ¬ ë¦¬ë·° ë…¸íŠ¸</button>
          <button class="scattered-btn btn-guest" onclick="openBoard('guestbook')">ğŸ“ ë°©ëª…ë¡</button>
          <button class="scattered-btn btn-write" onclick="openWrite()">âœï¸ ê¸€ì“°ê¸°</button>
          
          <button class="scattered-btn btn-verify" onclick="openPopup('captcha-window')">ğŸ’Š ë¡œë´‡ ê²€ì¦</button>
          <button class="scattered-btn btn-setting" onclick="openPopup('profile-window')" data-tooltip="ì„¤ì •">âš™ï¸</button>

          <button class="scattered-btn btn-shop" onclick="openPopup('shop-window')">ğŸ›’ ì•”ì‹œì¥</button>
      </div>

      <div id="view-station" class="world-view">
          <div class="station-filter"></div>
          <div style="position:absolute; top:20%; left:10%; color:#fff; font-size:24px; font-weight:bold; text-shadow: 2px 2px 5px #000;">ë– ë‚˜ê°„ ê²ƒë“¤ì˜ ì—­...</div>
      </div>

      <div id="view-aqua" class="world-view">
          <div class="aqua-obj f-fish1">ğŸŸ</div>
          <div class="aqua-obj f-fish2">ğŸ </div>
          <div class="aqua-obj f-jelly">ğŸª¼</div>
          
          <button class="scattered-btn btn-dolphin" onclick="openPopup('dolphin-window')">
              ğŸ¬ ì‹¬í•´ ì˜¤ë½ì‹¤ ì‘ë™
          </button>
      </div>

      <div id="shimeji-room" data-tooltip="ë”ë¸”í´ë¦­ ì´ë™">
          <div id="pet-bubble">ë°°ê³ íŒŒ...</div>
          <img id="pet-image" src="https://cdn.statically.io/gh/shimeji-ee/shimeji-ee.github.io/master/img/shime1.png" onclick="openPopup('ai-window')" ondblclick="toggleRoaming()">
      </div>

  </div> <div id="left-taskbar">
      <div class="task-icon" onclick="switchWorld('view-room')" data-tooltip="ë‚´ ë°©">
          <img src="https://win98icons.alexmeub.com/icons/directory_open_file_mydocs-4.png"><br>Room
      </div>
      <div class="task-icon" onclick="switchWorld('view-station')" data-tooltip="ê¸°ì°¨ì—­">
          <img src="https://win98icons.alexmeub.com/icons/network_cool_two_pcs-0.png"><br>Station
      </div>
      <div class="task-icon" onclick="switchWorld('view-aqua')" data-tooltip="ì•„ì¿ ì•„ë¦¬ì›€">
          <img src="https://win98icons.alexmeub.com/icons/world-2.png"><br>Aqua
      </div>
      <hr style="width: 60%; border-color: #1a252f; margin: 15px 0;">
      <div class="task-icon" onclick="openPopup('music-window')" data-tooltip="ì¹´ì„¸íŠ¸">
          <img src="https://win98icons.alexmeub.com/icons/cd_audio_cd_a-3.png"><br>Music
      </div>
      <div class="task-icon" onclick="openPopup('ai-window')" data-tooltip="ë©”ì‹ ì €">
          <img src="https://win98icons.alexmeub.com/icons/modem-1.png"><br>Chat
      </div>
  </div>

  <div id="custom-tooltip">ë§í’ì„ </div>

  <div id="captcha-window" class="cute-popup">
      <div class="cute-titlebar" id="captcha-drag">
          <span>âš ï¸ ë³´ì•ˆ ì‹œìŠ¤í…œ</span>
          <div class="cute-title-btns"><span onclick="closePopup('captcha-window')"></span></div>
      </div>
      <div class="cute-body" style="text-align:center;">
          <p style="font-weight:bold; margin-top:0; color:#ecf0f1;">ë”°ëœ»í•¨ì´ ëŠê»´ì§€ëŠ” ì‚¬ì§„ì„ ì„ íƒí•˜ì‹œì˜¤.</p>
          <div class="captcha-grid">
              <img src="https://cdn.pixabay.com/photo/2014/11/30/14/11/cat-551554_1280.jpg">
              <img src="https://cdn.pixabay.com/photo/2017/08/06/09/52/blanket-2591473_1280.png">
              <img src="https://cdn.pixabay.com/photo/2015/12/01/20/28/road-1072821_1280.jpg">
              <img src="https://cdn.pixabay.com/photo/2016/11/29/05/45/astronomy-1867616_1280.jpg">
              <img src="https://cdn.pixabay.com/photo/2017/08/01/01/33/beanie-2562646_1280.jpg">
              <img src="https://cdn.pixabay.com/photo/2016/03/23/04/01/woman-1274056_1280.jpg">
          </div>
          <button class="captcha-btn" onclick="closePopup('captcha-window')">[ ì¸ì¦ ì™„ë£Œ ]</button>
      </div>
  </div>

  <div id="dolphin-window" class="cute-popup">
      <div class="cute-titlebar" id="dolphin-drag" style="background: #00838f;"><span>ğŸ¬ ì¶”ì–µì˜ ë§ ë˜ì§€ê¸°</span> <div class="cute-title-btns"><span onclick="closePopup('dolphin-window')"></span></div></div>
      <div class="cute-body" style="background:#b2ebf2; text-align:center; padding: 10px;">
          <div id="dolphin-ui-top"><span id="d-time">â³ 30ì´ˆ</span><span id="d-score">ğŸ† 0ê°œ ì„±ê³µ</span></div>
          <div id="dolphin-game-area">
              <div id="dolphin-overlay">
                  <div id="d-msg" style="font-size:20px; font-weight:bold; text-shadow: 2px 2px 0px #000;">ë„ì „í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</div>
                  <button class="btn-action" style="margin-top:20px; font-size:16px; padding: 10px 20px;" onclick="startDolphinGame()">â–¶ COIN INSERT</button>
              </div>
              <div class="dolphin-deco" style="top:20px; left:20px;">ğŸ¬</div>
              <div class="dolphin-deco" style="bottom:50px; right:20px; transform:scaleX(-1);">ğŸ¬</div>
              <div class="post" style="left: 60px;"></div><div class="post" style="right: 60px;"></div>
              <div class="ring" id="ring0" style="border-color:#e91e63;"></div>
              <div class="ring" id="ring1" style="border-color:#9c27b0;"></div>
              <div class="ring" id="ring2" style="border-color:#3f51b5;"></div>
              <div class="ring" id="ring3" style="border-color:#4caf50;"></div>
              <div class="ring" id="ring4" style="border-color:#ff9800;"></div>
          </div>
          <div style="display: flex; justify-content: space-between; margin-top: 15px; align-items:center; padding: 0 10px;">
              <button class="pump-btn" onclick="pushRings('left')">â—€</button>
              <div style="font-size:12px; color:#00838f; font-weight:bold;">ë²„íŠ¼ì„ ì—°íƒ€í•´ ë¬¼ì‚´ì„ ì¼ìœ¼ì¼œë¼!</div>
              <button class="pump-btn" onclick="pushRings('right')">â–¶</button>
          </div>
      </div>
  </div>

  <div id="music-window" class="cute-popup">
      <div class="cute-titlebar" id="music-drag" style="background:#f39c12; color:#000;"><span>ğŸ“» ì¹´ì„¸íŠ¸ í”Œë ˆì´ì–´</span> <div class="cute-title-btns"><span onclick="closePopup('music-window')"></span></div></div>
      <div class="cute-body">
          <div class="player-controls">
              <button class="ctrl-btn" onclick="prevTrack()">â®</button>
              <button class="ctrl-btn" id="play-btn" onclick="togglePlay()">â–¶</button>
              <button class="ctrl-btn" onclick="nextTrack()">â­</button>
          </div>
          <marquee class="music-info" scrollamount="4" id="now-playing-text">í…Œì´í”„ ëŒ€ê¸° ì¤‘...</marquee>
      </div>
  </div>

  <div id="board-window" class="cute-popup">
      <div class="cute-titlebar" id="board-drag" style="background:#9b59b6;"><span>ğŸ€ ê¸°ë¡ ë³´ê´€ì†Œ</span> <div class="cute-title-btns"><span onclick="closePopup('board-window')"></span></div></div>
      <div class="cute-body" id="page-content" style="background:#ecf0f1;">ë¡œë”© ì¤‘...</div>
  </div>

  <div id="write-window" class="cute-popup">
      <div class="cute-titlebar" id="write-drag" style="background:#27ae60;"><span>ğŸ“ ìƒˆ ê¸€ ì‘ì„±</span> <div class="cute-title-btns"><span onclick="closePopup('write-window')"></span></div></div>
      <div class="cute-body">
          <div class="input-row" style="flex-direction:row; align-items:center; justify-content:space-between;">
              <div style="display:flex; gap:10px; align-items:center;">
                  <label style="margin:0; color:#bdc3c7;">ì¹´í…Œê³ ë¦¬</label>
                  <select id="post-category" class="cute-input" style="width: 140px;">
                      <option value="diary">ğŸ““ ë¹„ë°€ ì¼ê¸°</option>
                      <option value="character">âœ¨ ìºë¦­í„° ë±</option>
                      <option value="review">ğŸ¬ ë¦¬ë·° ë…¸íŠ¸</option>
                      <option value="guestbook">ğŸ“ ë°©ëª…ë¡</option>
                  </select>
              </div>
              <div>
                  <label for="local-img-upload" class="btn-action" style="cursor:pointer; background:#bdc3c7; color:#000;">ğŸ–¼ï¸ ì‚¬ì§„ ì²¨ë¶€</label>
                  <input type="file" id="local-img-upload" accept="image/*" style="display:none;" onchange="insertLocalImageToEditor(this)">
              </div>
          </div>
          <div class="input-row"><input type="text" id="post-title" class="cute-input" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”..."></div>
          <textarea id="post-content"></textarea>
          <div style="text-align: right; margin-top: 15px;"><button class="btn-action" onclick="savePost()" style="background:#27ae60; color:#fff; border-color:#2ecc71;">ì €ì¥í•˜ê¸°</button></div>
      </div>
  </div>

  <div id="ai-window" class="cute-popup">
      <div class="cute-titlebar" id="ai-drag" style="background:#3498db;"><span>ğŸ’¬ í« ë©”ì‹ ì €</span> <div class="cute-title-btns"><span onclick="closePopup('ai-window')"></span></div></div>
      <div class="cute-body">
        <div class="chat-body" id="chat-log"><div class="msg-row msg-ai">ë‚˜ë£¨: ë°¥ ì¤˜...</div></div>
        <div style="display:flex; gap:5px; margin-top:10px;">
            <input type="text" id="ai-input" class="cute-input" style="flex:1;" onkeypress="if(event.key==='Enter') sendMsg()">
            <button class="btn-action" onclick="sendMsg()" style="background:#3498db; color:#fff;">ì „ì†¡</button>
        </div>
      </div>
  </div>

  <div id="profile-window" class="cute-popup">
      <div class="cute-titlebar" id="profile-drag" style="background:#7f8c8d;"><span>ğŸ› ï¸ í™˜ê²½ ì„¤ì •</span> <div class="cute-title-btns"><span onclick="closePopup('profile-window')"></span></div></div>
      <div class="cute-body">
          <div class="input-row"><label>í« ì´ë¯¸ì§€ ë³€ê²½</label><input type="file" id="edit-pet-file" class="cute-input"></div>
          <div class="input-row"><label>ìœ íŠœë¸Œ BGM (ID ì‰¼í‘œ êµ¬ë¶„)</label><textarea id="edit-bgm" class="cute-input" rows="2" placeholder="VDMiHYgQKLE, jfKfPfyJRdk"></textarea></div>
          <div style="text-align: right;"><button class="btn-action" onclick="saveProfile()">ì €ì¥ ë° ì ìš©</button></div>
      </div>
  </div>

  <div id="shop-window" class="cute-popup">
      <div class="cute-titlebar" id="shop-drag" style="background:#f39c12; color:#000;"><span>ğŸ›’ ì•”ì‹œì¥ ê±°ë˜ì†Œ</span> <div class="cute-title-btns"><span onclick="closePopup('shop-window')"></span></div></div>
      <div class="cute-body" style="text-align:center;">
          <h3 style="color:#f1c40f; margin:0 0 10px 0; text-shadow: 1px 1px 0px #000;">ë³´ìœ  í¬ì¸íŠ¸: <span id="my-money">0</span> P</h3>
          <p style="font-size:11px; color:#bdc3c7;">(êµ¬ë§¤í•œ ë¬¼ê±´ì€ ë°©ë°”ë‹¥ì— ë–¨ì–´ì§‘ë‹ˆë‹¤)</p>
          <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-bottom:15px;">
              <button class="btn-action" style="padding:15px 10px; background:#e74c3c; color:#fff;" onclick="buyItem('ì»µë¼ë©´', 'ğŸœ', 100)">ğŸœ ì»µë¼ë©´<br>100P</button>
              <button class="btn-action" style="padding:15px 10px; background:#3498db; color:#fff;" onclick="buyItem('ì†Œì£¼', 'ğŸ¾', 200)">ğŸ¾ ì†Œì£¼<br>200P</button>
              <button class="btn-action" style="padding:15px 10px; background:#2ecc71; color:#fff;" onclick="buyItem('ë‹´ë°°', 'ğŸš¬', 300)">ğŸš¬ ë‹´ë°°<br>300P</button>
              <button class="btn-action" style="padding:15px 10px; background:#9b59b6; color:#fff;" onclick="buyItem('ë¹„ë””ì˜¤', 'ğŸ“¼', 500)">ğŸ“¼ ë¹„ë””ì˜¤<br>500P</button>
          </div>
          <div style="text-align:right;"><button class="btn-action" style="font-size:11px; background:#c0392b; color:#fff;" onclick="clearRoomItems()">ë°© ì²­ì†Œí•˜ê¸°</button></div>
      </div>
  </div>

  <div id="yt-player-container" style="display:none;"></div>

  <script>
    /* ğŸ”´ ë¸Œë¼ìš°ì € ë‚´ì¥ ì‚¬ìš´ë“œ (ìˆ˜ì • ì—†ìŒ) */
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playClickSound() { if(audioCtx.state === 'suspended') audioCtx.resume(); const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = 'square'; osc.frequency.setValueAtTime(600, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.1); gain.gain.setValueAtTime(0.05, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.1); }
    function playPopupSound() { if(audioCtx.state === 'suspended') audioCtx.resume(); const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = 'sine'; osc.frequency.setValueAtTime(300, audioCtx.currentTime); osc.frequency.linearRampToValueAtTime(600, audioCtx.currentTime + 0.1); gain.gain.setValueAtTime(0, audioCtx.currentTime); gain.gain.linearRampToValueAtTime(0.1, audioCtx.currentTime + 0.05); gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.1); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.1); }
    document.addEventListener('click', (e) => { if(e.target.tagName === 'BUTTON' || e.target.classList.contains('scattered-btn') || e.target.classList.contains('task-icon') || e.target.closest('.task-icon') || e.target.tagName === 'SPAN' || e.target.closest('.light-switch')) { playClickSound(); } });

    /* ğŸ”´ ì°¨ì› ì´ë™ ë° í˜•ê´‘ë“± íš¨ê³¼ */
    function switchWorld(viewId) { document.querySelectorAll('.world-view').forEach(el => el.classList.remove('active')); document.getElementById(viewId).classList.add('active'); playPopupSound(); }
    function flickerRoom() { const room = document.getElementById('view-room'); room.classList.remove('room-flicker'); void room.offsetWidth; room.classList.add('room-flicker'); }

    /* Supabase ë° ê¸°ë³¸ ì„¤ì • */
    const SB_URL = "https://kzgbqpodvpuoqovfsyrm.supabase.co";
    const SB_KEY = "sb_publishable_pdqE1Sc-4PSv3LQM9IsBcA_xJWeZwW-"; 
    const OPENROUTER_KEY = "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"; 
    let sbClient = null; if (window.supabase) sbClient = window.supabase.createClient(SB_URL, SB_KEY);
    CKEDITOR.replace('post-content', { height: 250, language: 'ko', removeButtons: 'About', versionCheck: false });
    let currentEditId = null; let globalPostsData = []; 
    function insertLocalImageToEditor(input) { const file = input.files[0]; if(!file) return; if(file.size > 2 * 1024 * 1024) return alert("ìš©ëŸ‰ ì´ˆê³¼..."); const reader = new FileReader(); reader.onload = function(e) { CKEDITOR.instances['post-content'].insertHtml(`<img src="${e.target.result}" style="max-width:100%; border-radius:5px; border:2px inset #555;">`); input.value = ''; }; reader.readAsDataURL(file); }
    const tooltip = document.getElementById('custom-tooltip');
    document.addEventListener('mousemove', (e) => { const target = e.target.closest('[data-tooltip]'); if (target) { tooltip.style.display = 'block'; tooltip.style.left = (e.pageX + 15) + 'px'; tooltip.style.top = (e.pageY + 15) + 'px'; tooltip.innerText = target.getAttribute('data-tooltip'); } else { tooltip.style.display = 'none'; } });

    /* íŒì—… ë“œë˜ê·¸ ë° ì• ë‹ˆë©”ì´ì…˜ */
    let highestZ = 600;
    function makeDraggable(winId, dragId) { const win = document.getElementById(winId); const dragArea = document.getElementById(dragId); let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0; win.onmousedown = () => { win.style.zIndex = ++highestZ; }; dragArea.onmousedown = (e) => { e.preventDefault(); pos3 = e.clientX; pos4 = e.clientY; document.onmouseup = closeDrag; document.onmousemove = elementDrag; }; function elementDrag(e) { e.preventDefault(); pos1 = pos3 - e.clientX; pos2 = pos4 - e.clientY; pos3 = e.clientX; pos4 = e.clientY; win.style.top = (win.offsetTop - pos2) + "px"; win.style.left = (win.offsetLeft - pos1) + "px"; } function closeDrag() { document.onmouseup = null; document.onmousemove = null; } }
    ['write-window','board-window','ai-window','profile-window','shop-window','music-window','shimeji-room','dolphin-window', 'captcha-window'].forEach(id => { makeDraggable(id, id === 'shimeji-room' ? id : id.replace('window', 'drag')); });
    function openPopup(id) { playPopupSound(); const el = document.getElementById(id); el.style.display = 'block'; el.style.zIndex = ++highestZ; el.classList.remove('pop-anim'); void el.offsetWidth; el.classList.add('pop-anim'); }
    function closePopup(id) { document.getElementById(id).style.display = 'none'; }

    /* ì‹œë©”ì§€ ì¤‘ì–¼ê±°ë¦¼ */
    const mutterTexts = ["ë°°ê³ íŒŒ...", "ì‹¬ì‹¬í•´...", "ì¶”ì›Œ...", "ë¶ˆ ì¢€ ì¼œì¤˜..."];
    setInterval(() => { const bubble = document.getElementById('pet-bubble'); bubble.style.opacity = '1'; bubble.innerText = mutterTexts[Math.floor(Math.random() * mutterTexts.length)]; setTimeout(() => { bubble.style.opacity = '0'; }, 3000); }, 8000);

    /* ğŸ”´ ëŒê³ ë˜ ì•„ì¼€ì´ë“œ (ë²„ê·¸ ë°•ë©¸ ì™„ë£Œ) */
    const rings = [document.getElementById('ring0'), document.getElementById('ring1'), document.getElementById('ring2'), document.getElementById('ring3'), document.getElementById('ring4')];
    let ringStates = []; let dTime = 30; let dScore = 0; let dState = 'ready'; let dTimer = null; let gameLoop = null;

    function resetRings() {
        // ë§ ì´ˆê¸° ìœ„ì¹˜ ë¶„ì‚°
        ringStates = rings.map((r, i) => ({ x: 40 + (i*50), y: 300, vy: 0, vx: 0, stuck: false, scored: false }));
        rings.forEach((r, i) => { r.style.top = '300px'; r.style.left = ringStates[i].x + 'px'; });
    }
    resetRings();

    function startDolphinGame() {
        dState = 'playing'; dTime = 30; dScore = 0;
        document.getElementById('d-score').innerText = 'ğŸ† 0ê°œ ì„±ê³µ'; document.getElementById('d-time').innerText = 'â³ 30ì´ˆ';
        document.getElementById('dolphin-overlay').style.display = 'none'; resetRings();
        if(dTimer) clearInterval(dTimer);
        dTimer = setInterval(() => { dTime--; document.getElementById('d-time').innerText = `â³ ${dTime}ì´ˆ`; if(dTime <= 0) endGame(false); }, 1000);
        if(!gameLoop) updateGame();
    }

    function endGame(isWin) {
        dState = 'over'; clearInterval(dTimer); cancelAnimationFrame(gameLoop); gameLoop = null;
        const msgEl = document.getElementById('d-msg');
        if(isWin) { msgEl.innerText = `âœ¨ ì™„ë²½í•œ ì„±ê³µ! âœ¨\n+100P ì§€ê¸‰ ì™„ë£Œ`; earnPoints(100); } 
        else { msgEl.innerText = `G A M E O V E R\nìµœì¢… ì„±ê³µ: ${dScore}ê°œ`; }
        document.getElementById('dolphin-overlay').style.display = 'flex'; document.querySelector('.start-btn').innerText = 'â–¶ ë‹¤ì‹œ ë„ì „';
    }

    const gravity = 0.4; // ì¤‘ë ¥ ì¡°ì ˆ
    const bounce = -0.5; // ë°”ë‹¥ ë°˜ë™
    function updateGame() {
        if(dState !== 'playing') return;
        rings.forEach((ring, i) => {
            let s = ringStates[i]; if (s.stuck) return;
            s.vy += gravity; s.y += s.vy; s.x += s.vx; s.vx *= 0.95; // ê³µê¸° ì €í•­

            // ë²½/ë°”ë‹¥ ì¶©ëŒ
            if (s.y > 300) { s.y = 300; s.vy *= bounce; } 
            if (s.x < 10) { s.x = 10; s.vx *= -0.8; } if (s.x > 260) { s.x = 260; s.vx *= -0.8; }

            // ğŸ”´ ê¸°ë‘¥ ì¶©ëŒ íŒì • (ì •ë°€ ì¡°ì •)
            // ì™¼ìª½ ê¸°ë‘¥(x=60 ê·¼ì²˜), ì˜¤ë¥¸ìª½ ê¸°ë‘¥(x=220 ê·¼ì²˜)
            const targetXLeft = 65; const targetXRight = 225; const threshold = 12;
            if (s.y > 170 && s.y < 250 && s.vy > 0) { // ë‚´ë ¤ì˜¤ëŠ” ì¤‘ì—ë§Œ íŒì •
                if (Math.abs(s.x - targetXLeft) < threshold) {
                    s.stuck = true; s.y = 260 - (dScore*12); s.x = targetXLeft; // ê¸°ë‘¥ì— ê±¸ë¦¼
                    if(!s.scored) { s.scored = true; dScore++; }
                } else if (Math.abs(s.x - targetXRight) < threshold) {
                    s.stuck = true; s.y = 260 - (dScore*12); s.x = targetXRight; // ê¸°ë‘¥ì— ê±¸ë¦¼
                    if(!s.scored) { s.scored = true; dScore++; }
                }
            }
            if(s.scored) document.getElementById('d-score').innerText = `ğŸ† ${dScore}ê°œ ì„±ê³µ`;
            ring.style.top = s.y + 'px'; ring.style.left = s.x + 'px';
        });
        if(dScore >= 5) { endGame(true); return; } // 5ê°œ ëª¨ë‘ ì„±ê³µ ì‹œ ìŠ¹ë¦¬
        gameLoop = requestAnimationFrame(updateGame);
    }
    function pushRings(side) {
        if(dState !== 'playing') return;
        rings.forEach((ring, i) => {
            let s = ringStates[i]; if (s.stuck) return;
            // íŒí”„ í˜ ì¡°ì ˆ (ëœë¤ì„± ì¶”ê°€)
            s.vy = -Math.random() * 8 - 4; 
            s.vx += (side === 'left' ? 1 : -1) * (Math.random() * 4 + 2);
        });
    }

    /* ì•”ì‹œì¥ ì•„ì´í…œ ë‚™í•˜ (ë¡œë¹„ í•œì •) */
    let myMoney = parseInt(localStorage.getItem('myPoints') || '1000'); let roomItems = JSON.parse(localStorage.getItem('myRoomItems') || '[]');
    function updateMoneyDisplay() { document.getElementById('my-money').innerText = myMoney; localStorage.setItem('myPoints', myMoney); }
    function earnPoints(amount) { myMoney += amount; updateMoneyDisplay(); } updateMoneyDisplay();
    function buyItem(name, icon, price) { 
        if (myMoney < price) return alert("ëˆì´ ì—†ì–´..."); myMoney -= price; updateMoneyDisplay(); 
        const randX = Math.floor(Math.random() * (window.innerWidth - 130)) + 80; const randY = Math.floor(Math.random() * (window.innerHeight - 100));
        const newItem = { icon: icon, x: randX, y: randY }; roomItems.push(newItem); localStorage.setItem('myRoomItems', JSON.stringify(roomItems)); renderRoomItems(); 
    }
    function renderRoomItems() { const layer = document.getElementById('item-drop-zone'); layer.innerHTML = ''; roomItems.forEach(item => { const el = document.createElement('div'); el.className = 'dropped-item'; el.style.left = item.x + 'px'; el.style.top = item.y + 'px'; el.innerText = item.icon; layer.appendChild(el); }); }
    function clearRoomItems() { roomItems = []; localStorage.setItem('myRoomItems', '[]'); renderRoomItems(); } renderRoomItems();

    /* ì„¤ì • ë° ì´ë¯¸ì§€ ë¡œë“œ (ì•ˆì •ì ì¸ CDN ì‚¬ìš©) */
    let tempPetBase64 = null; let currentPlaylist = [];
    function handleFile(id, callback) { document.getElementById(id).addEventListener('change', function(e) { const file = e.target.files[0]; if(!file) return; if(file.size > 3 * 1024 * 1024) return alert("ìš©ëŸ‰ ì´ˆê³¼..."); const r = new FileReader(); r.onload = evt => callback(evt.target.result); r.readAsDataURL(file); }); }
    handleFile('edit-pet-file', res => tempPetBase64 = res);
    function loadProfile() { const saved = JSON.parse(localStorage.getItem('yellowRoomSettingsV1')) || {}; 
        // ğŸ”´ ì•ˆì •ì ì¸ CDN ì´ë¯¸ì§€ ê¸°ë³¸ê°’ ì„¤ì •
        document.getElementById('pet-image').src = saved.pet || 'https://cdn.statically.io/gh/shimeji-ee/shimeji-ee.github.io/master/img/shime1.png'; 
        currentPlaylist = (saved.bgm || 'VDMiHYgQKLE').split(',').map(s => s.trim()).filter(s => s); tempPetBase64 = saved.pet || ''; }
    function saveProfile() { try { localStorage.setItem('yellowRoomSettingsV1', JSON.stringify({ pet: tempPetBase64, bgm: document.getElementById('edit-bgm').value || 'VDMiHYgQKLE' })); } catch(e) { alert("ì €ì¥ ì‹¤íŒ¨..."); return; } loadProfile(); closePopup('profile-window'); if(player && player.loadVideoById) loadMusicPlayer(); }

    /* ìœ íŠœë¸Œ */
    let player = null; let trackIndex = 0; let isPlayerReady = false; let tag = document.createElement('script'); tag.src = "https://www.youtube.com/iframe_api"; document.head.appendChild(tag);
    window.onYouTubeIframeAPIReady = function() { if(currentPlaylist.length === 0) return; trackIndex = Math.floor(Math.random() * currentPlaylist.length); player = new YT.Player('yt-player-container', { height: '0', width: '0', videoId: currentPlaylist[trackIndex], events: { 'onReady': () => { isPlayerReady = true; document.getElementById('now-playing-text').innerText = "í…Œì´í”„ ëŒ€ê¸° ì¤‘..."; }, 'onStateChange': onPlayerStateChange, 'onError': nextTrack } }); }
    function loadMusicPlayer() { if(!isPlayerReady || currentPlaylist.length === 0) return; trackIndex = Math.floor(Math.random() * currentPlaylist.length); player.loadVideoById(currentPlaylist[trackIndex]); }
    function onPlayerStateChange(event) { if(event.data === YT.PlayerState.ENDED) nextTrack(); if(event.data === YT.PlayerState.PLAYING) { document.getElementById('play-btn').innerText = 'â¸'; let videoTitle = player.getVideoData().title; document.getElementById('now-playing-text').innerText = "â–¶ " + (videoTitle || currentPlaylist[trackIndex]); } if(event.data === YT.PlayerState.PAUSED) { document.getElementById('play-btn').innerText = 'â–¶'; } }
    function togglePlay() { if(!isPlayerReady) return; if(player.getPlayerState() === YT.PlayerState.PLAYING) player.pauseVideo(); else player.playVideo(); } function nextTrack() { if(!isPlayerReady) return; trackIndex = (trackIndex + 1) % currentPlaylist.length; player.loadVideoById(currentPlaylist[trackIndex]); } function prevTrack() { if(!isPlayerReady) return; trackIndex = (trackIndex - 1 + currentPlaylist.length) % currentPlaylist.length; player.loadVideoById(currentPlaylist[trackIndex]); }

    /* ì‹œë©”ì§€ ì´ë™ */
    let isRoaming = false; let roamInterval; 
    function toggleRoaming() { isRoaming = !isRoaming; const petRoom = document.getElementById('shimeji-room'); const petImg = document.getElementById('pet-image'); let currentX = petRoom.offsetLeft; if(isRoaming) { roamInterval = setInterval(() => { const randX = Math.floor(Math.random() * (window.innerWidth - 150)); const randY = Math.floor(Math.random() * (window.innerHeight - 150)); if(randX < currentX) petImg.style.setProperty('--flip', -1); else petImg.style.setProperty('--flip', 1); currentX = randX; petImg.classList.add('is-walking'); petRoom.style.left = randX + 'px'; petRoom.style.top = randY + 'px'; setTimeout(() => { petImg.classList.remove('is-walking'); }, 1500); }, 3000); } else { clearInterval(roamInterval); petImg.classList.remove('is-walking'); } }

    /* AI í†µì‹  */
    async function callAI(text) { try { const res = await fetch("https://openrouter.ai/api/v1/chat/completions", { method: "POST", headers: { "Authorization": `Bearer ${OPENROUTER_KEY}`, "Content-Type": "application/json" }, body: JSON.stringify({ "model": "mistralai/mistral-7b-instruct:free", "messages": [{"role": "system", "content": "ë„ˆëŠ” í”¼íí•œ ë‹¤ë§ˆê³ ì¹˜ í«ì´ì•¼. ì–´ë‘¡ê³  ì§§ê²Œ ë°˜ë§ë¡œ ëŒ€ë‹µí•´."}, {"role": "user", "content": text}] }) }); const data = await res.json(); if(data.choices) return data.choices[0].message.content; } catch(e) { return null; } return null; }
    function toggleChat() { openPopup('ai-window'); } async function sendMsg() { const input = document.getElementById('ai-input'); const log = document.getElementById('chat-log'); const text = input.value.trim(); if(!text) return; log.innerHTML += `<div class="msg-row msg-me">${text}</div>`; input.value = ''; log.scrollTop = log.scrollHeight; const loadingId = "load-" + Date.now(); log.innerHTML += `<div id="${loadingId}" class="msg-row msg-ai">ë‚˜ë£¨: (...)</div>`; log.scrollTop = log.scrollHeight; const reply = await callAI(text); document.getElementById(loadingId).remove(); if(reply) { log.innerHTML += `<div class="msg-row msg-ai">ë‚˜ë£¨: ${reply}</div>`; } else { log.innerHTML += `<div class="msg-sys">â€» í†µì‹  ë‹¨ì ˆ...</div>`; } log.scrollTop = log.scrollHeight; }

    /* ğŸ“ ê²Œì‹œíŒ */
    function openBoard(type) { 
        let title = "ğŸ€ Board";
        if(type === 'diary') title = "ğŸ““ ë¹„ë°€ ì¼ê¸°"; else if(type === 'character') title = "âœ¨ ìºë¦­í„° ë±"; else if(type === 'review') title = "ğŸ¬ ë¦¬ë·° ë…¸íŠ¸"; else if(type === 'guestbook') title = "ğŸ“ ë°©ëª…ë¡";
        document.getElementById('board-title').innerText = title; document.getElementById('page-content').innerHTML = `ë¡œë”© ì¤‘...`; 
        openPopup('board-window'); loadPosts(type); 
    } 
    function openWrite() { currentEditId = null; document.getElementById('post-title').value = ''; CKEDITOR.instances['post-content'].setData(''); openPopup('write-window'); } 
    async function savePost() { if (!sbClient) return; const category = document.getElementById('post-category').value; const title = document.getElementById('post-title').value; const content = CKEDITOR.instances['post-content'].getData(); if(!title || !content.trim()) return alert("ê¸°ë¡í•´ë¼..."); let err; if (currentEditId) err = (await sbClient.from('posts').update({ title, content, category }).eq('id', currentEditId)).error; else { err = (await sbClient.from('posts').insert([{ title, content, category }])).error; if(!err) earnPoints(100); } if(err) alert("ì‹¤íŒ¨..."); else { closePopup('write-window'); loadPosts(category); } } 
    async function deletePost(id, category) { if(!confirm("íŒŒê¸°í• ê¹Œ...?")) return; await sbClient.from('posts').delete().eq('id', id); loadPosts(category); } 
    function editPost(id) { const post = globalPostsData.find(p => p.id === id); if(!post) return; currentEditId = id; document.getElementById('post-category').value = post.category; document.getElementById('post-title').value = post.title; CKEDITOR.instances['post-content'].setData(post.content); openPopup('write-window'); } 
    function togglePostView(id) { const contentArea = document.getElementById('content-' + id); contentArea.style.display = contentArea.style.display === 'block' ? 'none' : 'block'; }

    async function loadPosts(categoryType) { 
        if (!sbClient) return; 
        const { data, error } = await sbClient.from('posts').select('*').eq('category', categoryType).order('created_at', { ascending: false }); 
        const list = document.getElementById('page-content'); 
        if(error || data.length === 0) { list.innerHTML = "<div style='color:#000; text-align:center; padding:20px;'>í…… ë¹„ì—ˆë‹¤...</div>"; return; } 
        globalPostsData = data; let html = ''; 
        data.forEach(p => { 
            const dateStr = new Date(p.created_at).toLocaleDateString(); 
            html += `<div class="post-item"><div class="post-header" onclick="togglePostView('${p.id}')"><span>ğŸ“‘ ${p.title} <small style="color:#555; font-weight:normal; margin-left:10px;">${dateStr}</small></span><div><button class="btn-action" style="padding:4px 8px; font-size:11px;" onclick="event.stopPropagation(); editPost('${p.id}')">ìˆ˜ì •</button><button class="btn-action" style="padding:4px 8px; font-size:11px;" onclick="event.stopPropagation(); deletePost('${p.id}', '${p.category}')">íŒŒê¸°</button></div></div><div class="post-content-area" id="content-${p.id}">${p.content}</div></div>`; 
        }); 
        list.innerHTML = html; 
    }

    loadProfile();
  </script>
</body>
</html>
