<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>The Messy Nostalgia</title>
  <link href="https://cdn.jsdelivr.net/npm/galmuri@latest/dist/galmuri.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.ckeditor.com/4.22.1/standard/ckeditor.js"></script>

  <style>
    /* === ğŸ©¸ ê¸°ë³¸ ì„¤ì • === */
    body { 
        background-color: #000; color: #ccc; 
        font-family: 'Galmuri9', 'ê¶ì„œ', serif; margin: 0; padding: 0; overflow: hidden; cursor: crosshair; 
    }
    
    /* === ğŸ’» ì¢Œì¸¡ ì‹œìŠ¤í…œ ë©”ë‰´ë°” === */
    #left-taskbar { 
        position: fixed; top: 0; left: 0; width: 80px; height: 100vh; 
        background: #1a1a1a; border-right: 2px solid #333; 
        display: flex; flex-direction: column; align-items: center; padding-top: 30px; z-index: 1000; 
    }
    .task-icon { 
        width: 60px; margin-bottom: 25px; text-align: center; cursor: pointer; 
        font-size: 10px; color: #888; transition: 0.2s; 
    }
    .task-icon div { font-size: 24px; margin-bottom: 5px; filter: grayscale(1); transition: 0.2s; }
    .task-icon:hover { color: #fff; } 
    .task-icon:hover div { filter: grayscale(0); transform: scale(1.1); }

    /* === ğŸŒŒ ì°¨ì› ì»¨í…Œì´ë„ˆ === */
    #world-container { position: absolute; top: 0; left: 80px; width: calc(100vw - 80px); height: 100vh; overflow: hidden; }
    .world-view { display: none; width: 100%; height: 100%; position: relative; }
    .world-view.active { display: block; }

    /* =========================================
       [ì°¨ì› 1] ë¡œë¹„: ë…¸ë€ì¥íŒ ì§€ì˜¥ (ë°€ë„ ê°•í™”) 
       ========================================= */
    #view-room { background: linear-gradient(to bottom, #eee 0%, #ddd 50%, #dcb35a 50%, #b28936 100%); }
    
    .diy-obj { position: absolute; z-index: 10; pointer-events: none; filter: drop-shadow(5px 5px 10px rgba(0,0,0,0.4)); object-fit: contain; }
    .obj-window { top: 8%; left: 35%; width: 220px; }
    .obj-closet { bottom: 40%; right: 8%; width: 160px; }
    .obj-bedding { bottom: 8%; left: 8%; width: 400px; z-index: 20; } /* ì¹¨ëŒ€ ì„±ì—­ */
    .obj-mold { position: absolute; bottom: 45%; left: 5%; width: 300px; height: 300px; background: radial-gradient(circle, rgba(0,0,0,0.4) 0%, rgba(0,0,0,0) 70%); z-index: 1; pointer-events: none; mix-blend-mode: multiply; }
    
    /* ì¥íŒ ìœ„ ì“°ë ˆê¸° ë„íŠ¸ë“¤ (ë°€ë„ìš©) */
    .trash-dot { position: absolute; z-index: 5; pointer-events: none; opacity: 0.7; font-size: 14px; text-shadow: 1px 1px 0px rgba(0,0,0,0.5);}

    /* í˜•ê´‘ë“± ê¸°ë¯¹ */
    .light-switch { 
        position: absolute; top: 30%; left: 3%; width: 35px; height: 55px; 
        background: #ddd; border: 2px solid #999; cursor: pointer; z-index: 100; 
        box-shadow: 3px 3px 5px rgba(0,0,0,0.3); display: flex; justify-content: center; align-items: center; 
    }
    .switch-knob { width: 12px; height: 25px; background: #fff; border: 1px solid #ccc; transition: 0.1s;}
    .light-switch:active .switch-knob { transform: translateY(5px); }
    @keyframes flicker { 0%, 100% { filter: brightness(1); } 10%, 25% { filter: brightness(0.1); } 15% { filter: brightness(1.2); } }
    .room-flicker { animation: flicker 0.6s linear; }

    /* =========================================
       [ì°¨ì› 2] ì¶˜ì²œí–‰ ê¸°ì°¨ì—­ (ì•„ë ¨í•œ ì¶”ì–µ) 
       ========================================= */
    #view-station { background: linear-gradient(to bottom, #1a2a6c, #b21f1f, #fdbb2d); overflow: hidden; }
    .station-fog { position: absolute; width: 200%; height: 100%; background: url('https://www.transparenttextures.com/patterns/fog.png'); opacity: 0.2; animation: fogMove 80s linear infinite; pointer-events: none; }
    @keyframes fogMove { from { transform: translateX(0); } to { transform: translateX(-50%); } }
    
    /* êµ´ëš ì—°ê¸° */
    .chimney { position: absolute; bottom: 35%; right: 20%; width: 50px; height: 180px; background: #222; border: 3px solid #000; }
    .smoke { position: absolute; top: -15px; left: 50%; width: 10px; height: 10px; background: rgba(255,255,255,0.4); border-radius: 50%; filter: blur(4px); animation: smokeRise 4s infinite; }
    @keyframes smokeRise { 0% { transform: translate(-50%, 0) scale(1); opacity: 0.6; } 100% { transform: translate(60px, -180px) scale(5); opacity: 0; } }

    /* ê¸°ì°¨ & ì‚¬ëŒ */
    .train { position: absolute; bottom: 18%; left: -600px; font-size: 50px; z-index: 50; animation: trainRun 25s linear infinite; animation-delay: 3s; filter: drop-shadow(5px 5px 5px rgba(0,0,0,0.8));}
    @keyframes trainRun { 0% { left: -600px; } 100% { left: 120%; } }
    .lonely-man { position: absolute; bottom: 15%; left: 40%; font-size: 30px; opacity: 0.6; animation: manWalk 20s ease-in-out infinite; }
    @keyframes manWalk { 0%, 100% { transform: translateX(0); } 50% { transform: translateX(40px); } }

    /* =========================================
       [ì°¨ì› 3] ì•„ì¿ ì•„ë¦¬ì›€ 
       ========================================= */
    #view-aqua { background: linear-gradient(to bottom, #001f3f, #0074d9); overflow: hidden; }
    .aqua-obj { position: absolute; pointer-events: none; z-index: 5; animation: floatSwim linear infinite; font-size: 80px; filter: drop-shadow(5px 5px 10px rgba(0,0,0,0.6));}
    @keyframes floatSwim { 0% { transform: translateX(0) rotate(5deg); } 100% { transform: translateX(120vw) rotate(-5deg); } }

    /* === ğŸ¬ íŒì—… & ë²„íŠ¼ ìŠ¤íƒ€ì¼ (ìˆœìˆ˜ ì˜¤ë¸Œì œ) === */
    .obj-btn {
        position: absolute; background: transparent; border: none; 
        color: #fff; font-family: 'Galmuri9'; font-weight: bold;
        display: flex; flex-direction: column; align-items: center; cursor: pointer;
        z-index: 150 !important; transition: 0.2s; text-shadow: 2px 2px 0px #000; outline: none;
    }
    .obj-btn div { font-size: 45px; filter: drop-shadow(4px 4px 0px #000); transition: 0.1s;}
    .obj-btn:hover div { transform: scale(1.15) rotate(5deg); }
    .obj-btn:active { transform: scale(0.9); }

    /* ì˜¤ë¸Œì œ ë²„íŠ¼ ìœ„ì¹˜ ë°°ì¹˜ */
    .btn-diary  { top: 55%; left: 45%; } /* ì†Œì£¼ë³‘ */
    .btn-char   { top: 75%; left: 30%; } /* ì‹ ë¶„ì¦ */
    .btn-review { top: 60%; left: 68%; } /* ë¹„ë””ì˜¤ */
    .btn-write  { top: 82%; left: 52%; } /* íœ */
    .btn-verify { top: 18%; right: 12%; } /* ì•Œì•½ */
    .btn-shop   { top: 78%; left: 82%; } /* ë´‰íˆ¬ */
    .btn-setting{ bottom: 5%; right: 5%; font-size: 10px; } /* í†±ë‹ˆ */

    /* ê¸°ì°¨ì—­ ë²„íŠ¼: ìš°ì²´í†µ */
    .btn-post { bottom: 12%; right: 12%; }

    /* ğŸ’» íŒì—…ì°½ ê³µí†µ ë””ìì¸ */
    .cute-popup { 
        position: absolute; display: none; background: rgba(15,15,15,0.98); border: 2px solid #444; 
        box-shadow: 15px 15px 0px rgba(0,0,0,0.7); overflow: hidden; width: 450px; color: #ddd; z-index: 2000;
    }
    .cute-titlebar { 
        background: #222; color: #fff; padding: 10px; font-size: 12px; 
        display: flex; justify-content: space-between; align-items: center; cursor: grab; border-bottom: 1px solid #555;
    }
    .cute-body { padding: 15px; max-height: 60vh; overflow-y: auto; background: #111;}
    .close-x { cursor: pointer; color: #ff4444; font-weight: bold; padding: 0 5px;}
    .close-x:hover { color: #fff; background: #ff4444;}

    /* íŒì—… UI ìš”ì†Œ */
    .cute-input { width: 100%; padding: 8px; margin-bottom: 10px; background: #000; border: 1px solid #555; color: #fff; font-family: 'Galmuri9'; box-sizing: border-box;}
    .btn-action { background: #333; color: #fff; border: 1px solid #555; padding: 8px 15px; font-family: 'Galmuri9'; cursor: pointer; transition: 0.1s;}
    .btn-action:hover { background: #555; }
    .btn-action:active { transform: scale(0.95); }

    /* ê²Œì‹œíŒ ë¦¬ìŠ¤íŠ¸ */
    .post-item { margin-bottom: 10px; border: 1px solid #555; background: #222; color: #ccc;}
    .post-header { padding: 10px 12px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border-bottom: 1px solid #111;}
    .post-content-area { padding: 15px; display: none; background: #1a1a1a; font-size: 12px; line-height: 1.6;}

    /* ëŒê³ ë˜ ê²Œì„ */
    #dolphin-game-area { width: 300px; height: 350px; background: #001a1a; border: 4px solid #004d40; margin: 0 auto; position: relative; overflow: hidden; }
    .ring { width: 26px; height: 26px; border: 5px solid; border-radius: 50%; position: absolute; box-shadow: 2px 2px 5px rgba(0,0,0,0.5);}
    .post { width: 10px; height: 130px; background: #5d4037; position: absolute; bottom: 0; box-shadow: 3px 0 5px rgba(0,0,0,0.5);}
    #dolphin-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:100; color:#fff;}

    /* ì‹œë©”ì§€ í« */
    #shimeji-room { position: absolute; bottom: 22%; right: 8%; z-index: 999; text-align: center; cursor: grab; transition: top 1s, left 1s; }
    .css-pet { width: 65px; height: 65px; background: #fff; border: 3px solid #000; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; color: #000; box-shadow: 5px 5px 0px rgba(0,0,0,0.5); cursor: pointer; background-size: cover; background-position: center;}
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
    .is-walking { animation: bounce 0.3s infinite; }
    
    #item-drop-zone { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; overflow: hidden;}
    @keyframes itemFall { 0% { transform: translateY(-100px) rotate(-360deg); opacity:0; } 100% { transform: translateY(0) rotate(0deg); opacity:1; } }
  </style>
</head>
<body id="main-body">

  <div id="world-container">
      
      <div id="view-room" class="world-view active">
          
          <div id="item-drop-zone"></div>
          
          <img id="diy-window" class="diy-obj obj-window" src="https://cdn.pixabay.com/photo/2013/07/12/17/58/window-152746_1280.png">
          <img id="diy-closet" class="diy-obj obj-closet" src="https://cdn.pixabay.com/photo/2014/12/21/23/58/wardrobe-576405_1280.png">
          <img id="diy-bedding" class="diy-obj obj-bedding" src="https://cdn.pixabay.com/photo/2017/01/14/10/57/bed-1979261_1280.png">
          <div class="obj-mold"></div>
          
          <div class="light-switch" onclick="flickerRoom()"> <div class="switch-knob"></div> </div>

          <div class="main-pic-container" style="position:absolute; top:12%; left:5%; width:28%; height:42%; background:#000; border:4px solid #222; z-index:15; transform:rotate(-2deg); overflow:hidden;">
              <img id="main-visual-img" src="https://cdn.pixabay.com/photo/2020/04/18/16/24/pixel-art-5059880_1280.png" style="width:100%; height:100%; object-fit:cover;">
          </div>

          <button class="obj-btn btn-diary" onclick="openBoard('diary')"><div>ğŸ¾</div><span style="color:#2ecc71;">ë¹„ë°€ ì¼ê¸°</span></button>
          <button class="obj-btn btn-char" onclick="openBoard('character')"><div>ğŸªª</div><span style="color:#3498db;">ìºë¦­í„° ë±</span></button>
          <button class="obj-btn btn-review" onclick="openBoard('review')"><div>ğŸ“¼</div><span style="color:#e74c3c;">ëª©ê²©ë‹´</span></button>
          <button class="obj-btn btn-write" onclick="openWrite()"><div>ğŸ–‹ï¸</div><span style="color:#f1c40f;">ê¸°ë¡í•˜ë¼</span></button>
          
          <button class="obj-btn btn-verify" onclick="openPopup('captcha-window')"><div>ğŸ’Š</div><span style="color:#e67e22;">ë³´ì•ˆ ì¸ì¦</span></button>
          <button class="obj-btn btn-shop" onclick="openPopup('shop-window')"><div>ğŸ›ï¸</div><span style="color:#9b59b6;">ì•”ì‹œì¥</span></button>
          
          <button class="obj-btn btn-setting" onclick="openPopup('profile-window')"><div style="font-size:30px;">âš™ï¸</div></button>
      </div>

      <div id="view-station" class="world-view">
          <div class="station-fog"></div>
          <div style="position:absolute; top:25%; width:100%; text-align:center; color:#fff; font-size:28px; font-weight:bold; text-shadow: 2px 2px 10px #000;">ì¶˜ì²œí–‰ ê¸°ì°¨ëŠ” ë– ë‚˜ê³ ...</div>
          
          <div class="chimney">
              <div class="smoke" style="animation-delay:0s;"></div>
              <div class="smoke" style="animation-delay:1.5s;"></div>
          </div>
          
          <div class="train">ğŸš‚ğŸšƒğŸšƒğŸšƒ...</div>
          <div class="lonely-man">ğŸš¶</div>
          
          <div style="position:absolute; bottom:0; width:100%; height:150px; background:repeating-linear-gradient(90deg, #111 0, #111 20px, transparent 20px, transparent 60px), #222; border-top:8px solid #444; transform:perspective(500px) rotateX(45deg);"></div>

          <button class="obj-btn btn-post" onclick="openBoard('guestbook')">
              <div style="font-size:60px;">ğŸ“®</div>
              <span style="color:#ffeb3b;">ì¶”ì–µì˜ ìš°ì²´í†µ</span>
          </button>
      </div>

      <div id="view-aqua" class="world-view">
          <div class="aqua-obj" style="top:20%; left:-15%; animation-duration:20s;">ğŸ¦ˆ</div>
          <div class="aqua-obj" style="top:55%; right:-15%; transform:scaleX(-1); animation-direction:reverse; animation-duration:30s;">ğŸ‹</div>
          <div class="aqua-obj" style="top:40%; left:50%; animation-duration:15s; animation-name:smokeRise;">ğŸª¼</div>
          
          <button class="obj-btn" style="top:50%; left:50%; transform:translate(-50%,-50%);" onclick="openPopup('dolphin-window')">
              <div style="font-size:80px;">ğŸ•¹ï¸</div>
              <span style="font-size:20px; color:#00bcd4;">ì‹¬í•´ ì˜¤ë½ê¸°</span>
          </button>
      </div>

      <div id="shimeji-room">
          <div id="pet-bubble" style="background:#fff; border:2px solid #000; padding:4px; font-size:11px; opacity:0; transition:0.3s; margin-bottom:5px;">ë°¥ ì¤˜...</div>
          <div id="pet-image" class="css-pet" onclick="openPopup('ai-window')" ondblclick="toggleRoaming()">( Âº â–² Âº )</div>
      </div>

  </div> <div id="left-taskbar">
      <div class="task-icon" onclick="switchWorld('view-room')"><div>ğŸ </div>Room</div>
      <div class="task-icon" onclick="switchWorld('view-station')"><div>ğŸš‚</div>Station</div>
      <div class="task-icon" onclick="switchWorld('view-aqua')"><div>ğŸŒŠ</div>Aqua</div>
      <hr style="width:50%; border-color:#333; margin:15px 0;">
      <div class="task-icon" onclick="openPopup('music-window')"><div>ğŸ“»</div>Music</div>
      <div class="task-icon" onclick="openPopup('ai-window')"><div>ğŸ’¬</div>Chat</div>
  </div>

  <div id="captcha-window" class="cute-popup">
      <div class="cute-titlebar"><span>âš ï¸ SECURITY</span><span class="close-x" onclick="closePopup('captcha-window')">X</span></div>
      <div class="cute-body" style="text-align:center;">
          <p>ë”°ëœ»í•œ ì¥íŒì„ ê³ ë¥´ì‹œì˜¤.</p>
          <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:5px;">
              <div style="height:60px; background:#f1c40f; cursor:pointer;" onclick="this.style.background='#fff'"></div>
              <div style="height:60px; background:#dcb35a; cursor:pointer;" onclick="this.style.background='#fff'"></div>
              <div style="height:60px; background:#b28936; cursor:pointer;" onclick="this.style.background='#fff'"></div>
          </div>
          <button class="btn-action" style="margin-top:15px; width:100%;" onclick="closePopup('captcha-window')">ì¸ì¦ ì™„ë£Œ</button>
      </div>
  </div>

  <div id="music-window" class="cute-popup">
      <div class="cute-titlebar"><span>ğŸ“» CASSETTE</span><span class="close-x" onclick="closePopup('music-window')">X</span></div>
      <div class="cute-body" style="text-align:center;">
          <button class="btn-action" onclick="prevTrack()">â®</button>
          <button class="btn-action" onclick="togglePlay()">â–¶/â¸</button>
          <button class="btn-action" onclick="nextTrack()">â­</button>
          <marquee id="now-playing-text" style="margin-top:10px; color:#2ecc71; border:1px solid #555; padding:5px;">Tape Waiting...</marquee>
      </div>
  </div>

  <div id="board-window" class="cute-popup">
      <div class="cute-titlebar"><span id="board-title">ğŸ€ Board</span><span class="close-x" onclick="closePopup('board-window')">X</span></div>
      <div class="cute-body" id="page-content">ë¡œë”© ì¤‘...</div>
  </div>

  <div id="write-window" class="cute-popup">
      <div class="cute-titlebar"><span>ğŸ“ WRITE</span><span class="close-x" onclick="closePopup('write-window')">X</span></div>
      <div class="cute-body">
          <select id="post-category" class="cute-input">
              <option value="diary">ë¹„ë°€ ì¼ê¸°</option>
              <option value="character">ìºë¦­í„° ë±</option>
              <option value="review">ëª©ê²©ë‹´</option>
              <option value="guestbook">ë°©ëª…ë¡</option>
          </select>
          <input type="text" id="post-title" class="cute-input" placeholder="ì œëª©...">
          <textarea id="post-content"></textarea>
          <div style="text-align:right; margin-top:15px;"><button class="btn-action" onclick="savePost()">ì €ì¥</button></div>
      </div>
  </div>

  <div id="ai-window" class="cute-popup">
      <div class="cute-titlebar"><span>ğŸ’¬ MESSENGER</span><span class="close-x" onclick="closePopup('ai-window')">X</span></div>
      <div class="cute-body">
          <div id="chat-log" style="height:200px; overflow-y:auto; background:#000; border:1px solid #555; padding:10px; font-size:12px;"></div>
          <div style="display:flex; gap:5px; margin-top:10px;">
              <input type="text" id="ai-input" class="cute-input" style="margin:0;" onkeypress="if(event.key==='Enter')sendMsg()">
              <button class="btn-action" onclick="sendMsg()">ì „ì†¡</button>
          </div>
      </div>
  </div>

  <div id="profile-window" class="cute-popup">
      <div class="cute-titlebar"><span>âš™ï¸ SETUP</span><span class="close-x" onclick="closePopup('profile-window')">X</span></div>
      <div class="cute-body">
          <p style="font-size:11px; color:#f1c40f; margin-top:0;">(ìš©ëŸ‰ 1MB ì´í•˜ PNG ê¶Œì¥)</p>
          <div style="margin-bottom:10px;">ğŸªŸ ì°½ë¬¸: <input type="file" id="edit-window-file" style="color:#fff; font-size:11px;"></div>
          <div style="margin-bottom:10px;">ğŸšª ì˜·ì¥: <input type="file" id="edit-closet-file" style="color:#fff; font-size:11px;"></div>
          <div style="margin-bottom:10px;">ğŸ›ï¸ ì´ë¶ˆ: <input type="file" id="edit-bedding-file" style="color:#fff; font-size:11px;"></div>
          <div style="margin-bottom:10px;">ğŸ¾ í«: <input type="file" id="edit-pet-file" style="color:#fff; font-size:11px;"></div>
          <div style="margin-bottom:10px;">ğŸ–¼ï¸ ì•¡ì: <input type="file" id="edit-main-file" style="color:#fff; font-size:11px;"></div>
          <div style="margin-bottom:10px;">ğŸµ BGM ID: <input type="text" id="edit-bgm" class="cute-input" placeholder="ìœ íŠœë¸Œ ID"></div>
          <div style="text-align:right;"><button class="btn-action" onclick="saveProfile()">ì ìš©</button></div>
      </div>
  </div>

  <div id="shop-window" class="cute-popup">
      <div class="cute-titlebar"><span>ğŸ›’ BLACK MARKET</span><span class="close-x" onclick="closePopup('shop-window')">X</span></div>
      <div class="cute-body" style="text-align:center;">
          <h3 id="my-money" style="color:#f1c40f;">0 P</h3>
          <div style="display:flex; gap:10px; justify-content:center;">
              <button class="btn-action" onclick="buyItem('ì†Œì£¼', 'ğŸ¾', 100)">ğŸ¾(100P)</button>
              <button class="btn-action" onclick="buyItem('ë‹´ë°°', 'ğŸš¬', 200)">ğŸš¬(200P)</button>
              <button class="btn-action" onclick="buyItem('ì¹¼', 'ğŸ”ª', 300)">ğŸ”ª(300P)</button>
          </div>
          <div style="text-align:right; margin-top:15px;"><button class="btn-action" style="background:#c0392b;" onclick="clearRoomItems()">ë°© ì²­ì†Œ</button></div>
      </div>
  </div>

  <div id="dolphin-window" class="cute-popup">
      <div class="cute-titlebar"><span>ğŸ¬ ARCADE</span><span class="close-x" onclick="closePopup('dolphin-window')">X</span></div>
      <div class="cute-body">
          <div id="dolphin-game-area">
              <div id="dolphin-overlay">
                  <div id="dolphin-msg" style="font-weight:bold; font-size:18px;">INSERT COIN</div>
                  <button id="dolphin-start-btn" class="btn-action" style="margin-top:15px; background:#00bcd4; color:#000;" onclick="startDolphinGame()">START</button>
              </div>
              <div class="post" style="left:60px;"></div><div class="post" style="right:60px;"></div>
              <div class="ring" id="ring0" style="border-color:#ff0000;"></div>
              <div class="ring" id="ring1" style="border-color:#00ff00;"></div>
              <div class="ring" id="ring2" style="border-color:#0000ff;"></div>
              <div class="ring" id="ring3" style="border-color:#ffff00;"></div>
              <div class="ring" id="ring4" style="border-color:#ff00ff;"></div>
          </div>
          <div style="display:flex; justify-content:space-between; margin-top:10px;">
              <button class="btn-action" onclick="pushRings('left')">â—€ L</button>
              <button class="btn-action" onclick="pushRings('right')">R â–¶</button>
          </div>
          <div id="d-score" style="text-align:center; font-weight:bold; margin-top:10px; color:#f1c40f;">ğŸ† 0ê°œ</div>
      </div>
  </div>

  <div id="yt-player-container" style="display:none;"></div>

  <script>
    // ğŸ”´ 1. ì „ì—­ ë³€ìˆ˜ ì´ˆê¸°í™”
    let highestZ = 3000;
    const SB_URL = "https://kzgbqpodvpuoqovfsyrm.supabase.co";
    const SB_KEY = "sb_publishable_pdqE1Sc-4PSv3LQM9IsBcA_xJWeZwW-";
    const OPENROUTER_KEY = "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";
    let sbClient = null; 
    if (window.supabase) sbClient = window.supabase.createClient(SB_URL, SB_KEY);
    
    // CKEditor ë¡œë“œ
    CKEDITOR.replace('post-content', { height: 200, language: 'ko', removeButtons: 'About', versionCheck: false });

    // ğŸ”´ 2. ê¸°ë³¸ UI ì¡°ì‘ (ì†Œë¦¬, ì°¨ì› ì´ë™, íŒì—…)
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    function playClickSound() { 
        if(audioCtx.state === 'suspended') audioCtx.resume(); 
        const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); 
        osc.type = 'square'; osc.frequency.setValueAtTime(600, audioCtx.currentTime); 
        osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.1); 
        gain.gain.setValueAtTime(0.05, audioCtx.currentTime); 
        gain.gain.exponentialRampToValueAtTime(0, audioCtx.currentTime + 0.1); 
        osc.connect(gain); gain.connect(audioCtx.destination); 
        osc.start(); osc.stop(audioCtx.currentTime + 0.1); 
    }
    
    function playPopupSound() { 
        if(audioCtx.state === 'suspended') audioCtx.resume(); 
        const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); 
        osc.type = 'sine'; osc.frequency.setValueAtTime(300, audioCtx.currentTime); 
        osc.frequency.linearRampToValueAtTime(600, audioCtx.currentTime + 0.1); 
        gain.gain.setValueAtTime(0, audioCtx.currentTime); 
        gain.gain.linearRampToValueAtTime(0.1, audioCtx.currentTime + 0.05); 
        gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.1); 
        osc.connect(gain); gain.connect(audioCtx.destination); 
        osc.start(); osc.stop(audioCtx.currentTime + 0.1); 
    }

    // í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    document.addEventListener('click', (e) => { 
        if(e.target.closest('button') || e.target.closest('.task-icon') || e.target.closest('.light-switch')) {
            playClickSound(); 
        }
    });

    // ì°¨ì› ì´ë™
    function switchWorld(vid) { 
        document.querySelectorAll('.world-view').forEach(e => e.classList.remove('active')); 
        document.getElementById(vid).classList.add('active'); 
        playPopupSound(); 
    }

    // í˜•ê´‘ë“± ì ë©¸
    function flickerRoom() { 
        const r = document.getElementById('view-room'); 
        r.classList.remove('room-flicker'); 
        void r.offsetWidth; 
        r.classList.add('room-flicker'); 
    }

    // íŒì—… ì—´ê¸°/ë‹«ê¸°
    function openPopup(id) { 
        playPopupSound();
        const el = document.getElementById(id); 
        el.style.display = 'block'; 
        el.style.zIndex = ++highestZ; 
    }
    function closePopup(id) { 
        document.getElementById(id).style.display = 'none'; 
    }

    // íŒì—… ë“œë˜ê·¸ ë¡œì§
    function makeDraggable(winId) { 
        const win = document.getElementById(winId); 
        const dragArea = win.querySelector('.cute-titlebar');
        if(!dragArea) return;
        let p1=0, p2=0, p3=0, p4=0; 
        win.onmousedown = () => win.style.zIndex = ++highestZ; 
        dragArea.onmousedown = (e) => { 
            e.preventDefault(); p3=e.clientX; p4=e.clientY; 
            document.onmouseup = () => { document.onmouseup=null; document.onmousemove=null; }; 
            document.onmousemove = (e) => { 
                e.preventDefault(); p1=p3-e.clientX; p2=p4-e.clientY; p3=e.clientX; p4=e.clientY; 
                win.style.top=(win.offsetTop-p2)+"px"; win.style.left=(win.offsetLeft-p1)+"px"; 
            }; 
        }; 
    }
    ['write-window','board-window','ai-window','profile-window','shop-window','music-window','dolphin-window', 'captcha-window'].forEach(makeDraggable);

    // ì‹œë©”ì§€ ë“œë˜ê·¸ ë³„ë„
    const shimeji = document.getElementById('shimeji-room');
    shimeji.onmousedown = () => { shimeji.style.zIndex = ++highestZ; };
    shimeji.ondragstart = () => false;

    /* ğŸ”´ 3. ë°€ë„ ê°•í™” (ì“°ë ˆê¸° ë¿Œë¦¬ê¸°) */
    const trashItems = ['ğŸš¬', 'ğŸ¥«', 'ğŸ¾', 'ğŸ¥¡', 'ğŸ§¦', 'ğŸª³', 'ğŸŒ‘'];
    function populateTrash() {
        const room = document.getElementById('view-room');
        for(let i=0; i<60; i++) {
            const t = document.createElement('div'); 
            t.className = 'trash-dot';
            t.innerText = trashItems[Math.floor(Math.random() * trashItems.length)];
            t.style.left = Math.random() * 95 + '%'; 
            t.style.top = (50 + Math.random() * 45) + '%';
            t.style.fontSize = (Math.random() * 15 + 8) + 'px';
            t.style.transform = `rotate(${Math.random()*360}deg)`;
            room.appendChild(t);
        }
    }
    populateTrash();

    /* ğŸ”´ 4. ê²Œì‹œíŒ & ê¸€ì“°ê¸° ë¡œì§ (ì—ëŸ¬ ì™„ë²½ ìˆ˜ì •) */
    let globalPostsData = [];
    
    async function openBoard(type) { 
        // ì œëª© ë³€ê²½
        let title = 'ğŸ€ Board';
        if(type==='diary') title = 'ğŸ““ ë¹„ë°€ ì¼ê¸°';
        else if(type==='character') title = 'âœ¨ ìºë¦­í„° ë±';
        else if(type==='review') title = 'ğŸ¬ ëª©ê²©ë‹´';
        else if(type==='guestbook') title = 'ğŸ“® ì¶”ì–µì˜ ë°©ëª…ë¡';
        
        document.getElementById('board-title').innerText = title;
        document.getElementById('page-content').innerHTML = 'ë¡œë”© ì¤‘...';
        openPopup('board-window'); 
        
        if (!sbClient) {
            document.getElementById('page-content').innerHTML = 'DB ì—°ê²° ì˜¤ë¥˜...';
            return;
        }

        const {data, error} = await sbClient.from('posts').select('*').eq('category', type).order('created_at',{ascending:false});
        
        if(error || !data || data.length === 0) {
            document.getElementById('page-content').innerHTML = 'í…… ë¹„ì–´ìˆë‹¤...';
            return;
        }

        globalPostsData = data;
        let htmlStr = ''; 
        data.forEach(p => { 
            const dateStr = new Date(p.created_at).toLocaleDateString();
            htmlStr += `
            <div class="post-item">
                <div class="post-header" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='block'?'none':'block'">
                    <span>ğŸ“‘ ${p.title} <small style="color:#888;">${dateStr}</small></span>
                </div>
                <div class="post-content-area">${p.content}</div>
            </div>`; 
        });
        document.getElementById('page-content').innerHTML = htmlStr;
    }
    
    function openWrite() { 
        document.getElementById('post-title').value = '';
        CKEDITOR.instances['post-content'].setData('');
        openPopup('write-window'); 
    }
    
    async function savePost() { 
        if(!sbClient) return;
        const category = document.getElementById('post-category').value;
        const title = document.getElementById('post-title').value;
        const content = CKEDITOR.instances['post-content'].getData();
        
        if(!title.trim()) return alert("ì œëª©ì„ ì ì–´ë¼...");
        
        await sbClient.from('posts').insert([{title: title, content: content, category: category}]); 
        earnPoints(100);
        closePopup('write-window'); 
        openBoard(category); 
    }

    /* ğŸ”´ 5. ëŒê³ ë˜ ì•„ì¼€ì´ë“œ */
    const rings = [document.getElementById('ring0'),document.getElementById('ring1'),document.getElementById('ring2'),document.getElementById('ring3'),document.getElementById('ring4')];
    let rState = [], dTime=30, dScore=0, dState='ready', dTimer=null, gameLoop=null;
    
    function resetRings() { 
        rState = rings.map((r,i) => ({ x: 40+(i*50), y: 300, vy:0, vx:0, stuck:false, scored:false })); 
        rings.forEach((r,i) => { r.style.top='300px'; r.style.left=rState[i].x+'px'; }); 
    }
    
    function startDolphinGame() { 
        dState='playing'; dTime=30; dScore=0; 
        document.getElementById('d-score').innerText='ğŸ† 0ê°œ'; 
        document.getElementById('dolphin-overlay').style.display='none'; 
        resetRings(); 
        if(dTimer) clearInterval(dTimer);
        dTimer=setInterval(()=>{ 
            dTime--; 
            if(dTime<=0) endGame(false); 
        }, 1000); 
        if(!gameLoop) loop(); 
    }
    
    function loop() { 
        if(dState!=='playing') return; 
        rState.forEach((s,i) => { 
            if(s.stuck) return; 
            s.vy+=0.35; s.y+=s.vy; s.x+=s.vx; s.vx*=0.96; 
            if(s.y>300){ s.y=300; s.vy*=-0.5; } 
            if(s.x<10||s.x>270) s.vx*=-0.8; 
            
            // ê¸°ë‘¥ ì¶©ëŒ íŒì • (x=60, x=240 ë¶€ê·¼)
            if(s.y>170 && s.y<240 && s.vy>0){ 
                if(Math.abs(s.x-60)<15 || Math.abs(s.x-240)<15){ 
                    s.stuck=true; 
                    s.y=250-(dScore*10); 
                    s.x=Math.abs(s.x-60)<15?60:240; 
                    if(!s.scored){ 
                        s.scored=true; dScore++; 
                        document.getElementById('d-score').innerText=`ğŸ† ${dScore}ê°œ`; 
                    } 
                } 
            } 
            rings[i].style.top=s.y+'px'; 
            rings[i].style.left=s.x+'px'; 
        }); 
        if(dScore>=5) { endGame(true); return; }
        gameLoop=requestAnimationFrame(loop); 
    }
    
    function pushRings(dir) { 
        if(dState==='playing') {
            rState.forEach(s => { 
                if(!s.stuck){ 
                    s.vy = -Math.random()*8-3; 
                    s.vx += (dir==='left'?1:-1)*(Math.random()*4+2); 
                } 
            }); 
        }
    }
    
    function endGame(win) { 
        dState='over'; clearInterval(dTimer); cancelAnimationFrame(gameLoop); gameLoop=null; 
        document.getElementById('dolphin-overlay').style.display='flex'; 
        document.getElementById('dolphin-msg').innerText = win ? 'âœ¨ SUCCESS âœ¨\n+100P' : 'FAILED\nGAME OVER'; 
        document.getElementById('dolphin-start-btn').innerText = 'â–¶ RETRY';
        if(win) earnPoints(100); 
    }

    /* ğŸ”´ 6. ì•”ì‹œì¥ í¬ì¸íŠ¸ & ì•„ì´í…œ ë“œë¡­ */
    let cash = parseInt(localStorage.getItem('pts')||'1000');
    let roomItems = JSON.parse(localStorage.getItem('roomItems')||'[]');
    
    function uCash() { 
        document.getElementById('my-money').innerText = cash+' P'; 
        localStorage.setItem('pts', cash); 
    }
    function earnPoints(a) { cash+=a; uCash(); }
    uCash();
    
    function buyItem(n, icon, p) { 
        if(cash<p) return alert("ìê¸ˆ ë¶€ì¡±..."); 
        cash-=p; uCash(); 
        const x = Math.floor(Math.random()*80)+10;
        const y = Math.floor(Math.random()*30)+60;
        roomItems.push({ icon: icon, x: x, y: y }); 
        localStorage.setItem('roomItems', JSON.stringify(roomItems)); 
        renderRoomItems(); 
    }
    
    function renderRoomItems() { 
        const layer = document.getElementById('item-drop-zone'); 
        layer.innerHTML=''; 
        roomItems.forEach(item => { 
            const el = document.createElement('div'); 
            el.className='dropped-item'; 
            el.style.left=item.x+'%'; el.style.top=item.y+'%'; 
            el.innerText=item.icon; 
            layer.appendChild(el); 
        }); 
    }
    function clearRoomItems() { 
        roomItems=[]; localStorage.setItem('roomItems','[]'); renderRoomItems(); 
    }
    renderRoomItems();

    /* ğŸ”´ 7. í« AI ë©”ì‹ ì € */
    async function sendMsg() { 
        const i = document.getElementById('ai-input');
        const l = document.getElementById('chat-log');
        const t = i.value.trim(); 
        if(!t) return; 
        
        l.innerHTML += `<div class="msg-row msg-me">${t}</div>`; 
        i.value = ''; 
        l.scrollTop = l.scrollHeight; 
        
        try {
            const res = await fetch("https://openrouter.ai/api/v1/chat/completions", { 
                method:"POST", 
                headers:{"Authorization":`Bearer ${OPENROUTER_KEY}`,"Content-Type":"application/json"}, 
                body:JSON.stringify({
                    "model":"mistralai/mistral-7b-instruct:free",
                    "messages":[{"role":"system","content":"í”¼íí•œ ë‹¤ë§ˆê³ ì¹˜ í«ì´ë‹¤. ë°˜ë§ë¡œ ì§§ê²Œ ëŒ€ë‹µí•´ë¼."},{"role":"user","content":t}]
                }) 
            }); 
            const d = await res.json(); 
            if(d.choices && d.choices.length > 0) {
                l.innerHTML += `<div class="msg-row msg-ai">ë‚˜ë£¨: ${d.choices[0].message.content}</div>`; 
                const bubble = document.getElementById('pet-bubble');
                bubble.innerText = d.choices[0].message.content;
                bubble.style.opacity = '1';
                setTimeout(() => bubble.style.opacity = '0', 3000);
            }
        } catch(e) {
            l.innerHTML += `<div style="color:#f00; font-size:10px; text-align:center;">í†µì‹  ì˜¤ë¥˜...</div>`; 
        }
        l.scrollTop = l.scrollHeight; 
    }

    let isRoaming = false; let roamInterval;
    function toggleRoaming() { 
        isRoaming = !isRoaming; 
        const petRoom = document.getElementById('shimeji-room'); 
        const petImg = document.getElementById('pet-image'); 
        if(isRoaming) { 
            roamInterval = setInterval(() => { 
                petImg.classList.add('is-walking'); 
                petRoom.style.left = Math.floor(Math.random()*80) + '%'; 
                petRoom.style.bottom = Math.floor(Math.random()*30) + '%'; 
                setTimeout(() => petImg.classList.remove('is-walking'), 1500); 
            }, 3000); 
        } else { 
            clearInterval(roamInterval); 
            petImg.classList.remove('is-walking'); 
        } 
    }

    /* ğŸ”´ 8. DIY í™˜ê²½ì„¤ì • (ì´ë¯¸ì§€ íŒŒì¼ ì²¨ë¶€) */
    let tPet='', tWin='', tCloset='', tBedding='', tMain=''; 
    let currentPlaylist=[];
    
    function handleFile(id, cb) { 
        document.getElementById(id).addEventListener('change', e => { 
            const file = e.target.files[0]; if(!file) return; 
            if(file.size > 1 * 1024 * 1024) return alert("1MB ì´í•˜ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤!"); 
            const r = new FileReader(); r.onload = evt => cb(evt.target.result); r.readAsDataURL(file); 
        }); 
    }
    handleFile('edit-pet-file', r=>tPet=r); 
    handleFile('edit-window-file', r=>tWin=r); 
    handleFile('edit-closet-file', r=>tCloset=r); 
    handleFile('edit-bedding-file', r=>tBedding=r);
    handleFile('edit-main-file', r=>tMain=r);
    
    function loadProfile() { 
        const s = JSON.parse(localStorage.getItem('diyRoomV5')) || {}; 
        if(s.win) document.getElementById('diy-window').src=s.win; 
        if(s.closet) document.getElementById('diy-closet').src=s.closet; 
        if(s.bedding) document.getElementById('diy-bedding').src=s.bedding; 
        if(s.main) document.getElementById('main-visual-img').src=s.main;
        
        const p = document.getElementById('pet-image'); 
        if(s.pet) { p.style.backgroundImage=`url(${s.pet})`; p.innerText=''; } 
        else { p.style.backgroundImage='none'; p.innerText='( Âº â–² Âº )'; } 
        
        currentPlaylist = (s.bgm||'VDMiHYgQKLE').split(',').map(x=>x.trim()).filter(x=>x); 
        
        tPet=s.pet||''; tWin=s.win||''; tCloset=s.closet||''; tBedding=s.bedding||''; tMain=s.main||'';
        document.getElementById('edit-bgm').value = s.bgm || '';
    }
    
    function saveProfile() { 
        try { 
            localStorage.setItem('diyRoomV5', JSON.stringify({ 
                pet:tPet, win:tWin, closet:tCloset, bedding:tBedding, main:tMain, 
                bgm:document.getElementById('edit-bgm').value 
            })); 
        } catch(e) { 
            alert("ì‚¬ì§„ ìš©ëŸ‰ ì´ˆê³¼ë¡œ ì €ì¥ ì‹¤íŒ¨!"); return; 
        } 
        loadProfile(); 
        closePopup('profile-window'); 
        if(player && player.loadVideoById) loadMusicPlayer();
    }

    /* ğŸ”´ 9. ìœ íŠœë¸Œ BGM í”Œë ˆì´ì–´ */
    let player = null; let trackIndex = 0; let isPlayerReady = false; 
    let tag = document.createElement('script'); tag.src = "https://www.youtube.com/iframe_api"; 
    document.head.appendChild(tag);
    
    window.onYouTubeIframeAPIReady = function() { 
        if(currentPlaylist.length === 0) return; 
        player = new YT.Player('yt-player-container', { 
            height: '0', width: '0', videoId: currentPlaylist[trackIndex], 
            events: { 
                'onReady': () => { isPlayerReady = true; document.getElementById('now-playing-text').innerText = "Tape Ready"; }, 
                'onStateChange': onPlayerStateChange, 
                'onError': nextTrack 
            } 
        }); 
    }
    function loadMusicPlayer() { 
        if(!isPlayerReady || currentPlaylist.length === 0) return; 
        player.loadVideoById(currentPlaylist[trackIndex]); 
    }
    function onPlayerStateChange(event) { 
        if(event.data === YT.PlayerState.ENDED) nextTrack(); 
        if(event.data === YT.PlayerState.PLAYING) { 
            document.getElementById('now-playing-text').innerText = "â–¶ " + (player.getVideoData().title || "Playing..."); 
        } 
    }
    function togglePlay() { 
        if(!isPlayerReady) return; 
        if(player.getPlayerState() === YT.PlayerState.PLAYING) player.pauseVideo(); 
        else player.playVideo(); 
    } 
    function nextTrack() { if(!isPlayerReady) return; trackIndex = (trackIndex + 1) % currentPlaylist.length; player.loadVideoById(currentPlaylist[trackIndex]); } 
    function prevTrack() { if(!isPlayerReady) return; trackIndex = (trackIndex - 1 + currentPlaylist.length) % currentPlaylist.length; player.loadVideoById(currentPlaylist[trackIndex]); }

    // ì‹œì‘ ì‹œ í”„ë¡œí•„ ë¡œë“œ
    loadProfile();
  </script>
</body>
</html>
