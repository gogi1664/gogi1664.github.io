<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ë‚˜ì˜ ë…¸ë€ì¥íŒ ë°©</title>
  <link href="https://cdn.jsdelivr.net/npm/galmuri@latest/dist/galmuri.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.ckeditor.com/4.22.1/standard/ckeditor.js"></script>

  <style>
    /* === ğŸ©¸ ê¸°ë³¸ ì„¤ì • === */
    body { background-color: #111; color: #ccc; font-family: 'Galmuri9', serif; margin: 0; padding: 0; overflow: hidden; user-select: none; }
    #world-container { position: absolute; top: 0; left: 80px; width: calc(100vw - 80px); height: 100vh; overflow: hidden; background: #222; }
    .world-view { display: none; width: 100%; height: 100%; position: relative; }
    .world-view.active { display: block; }

    /* === ğŸ¥‘ ì¢Œì¸¡ ë©”ë‰´ë°” (ê¹”ë”í•œ ìŠ¤íƒ€ì¼ ìœ ì§€) === */
    #left-taskbar { position: fixed; top: 0; left: 0; width: 80px; height: 100vh; background: rgba(255, 255, 255, 0.95); border-right: 1px solid #eaeaea; display: flex; flex-direction: column; align-items: center; padding-top: 40px; z-index: 9999; }
    .task-icon { width: 60px; margin-bottom: 30px; text-align: center; cursor: pointer; font-size: 11px; color: #999; transition: 0.3s; }
    .task-icon div { font-size: 26px; margin-bottom: 8px; filter: grayscale(1); transition: 0.3s;}
    .task-icon:hover { color: #d81b60; } .task-icon:hover div { filter: grayscale(0); transform: translateY(-3px); }

    /* =========================================
       [í•µì‹¬] ë…¸ë€ ì¥íŒ ë°© (ìŠ¤ì¼€ì¹˜ êµ¬í˜„)
       ========================================= */
    #view-room {
        /* âš ï¸ ì¤‘ìš”: ì—¬ê¸°ì— ì´ˆê¸° ë°°ê²½ ì´ë¯¸ì§€ë¥¼ ì„¤ì •í•˜ê±°ë‚˜, ì‹¤í–‰ í›„ ì„¤ì •ì°½ì—ì„œ ìŠ¤ì¼€ì¹˜ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”. */
        background-color: #4a2c2c; /* ì´ë¯¸ì§€ê°€ ì—†ì„ ë•Œ ê¸°ë³¸ ìƒ‰ìƒ */
        background-size: cover; /* ì´ë¯¸ì§€ê°€ í™”ë©´ì„ ê°€ë“ ì±„ìš°ë„ë¡ */
        background-position: center;
        position: relative; transition: filter 0.3s ease;
    }

    /* ì–´ë‘  ì˜¤ë²„ë ˆì´ (ì „ë“± ëŒ ë•Œ) */
    #room-darkness { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); pointer-events: none; z-index: 90; transition: 0.5s; opacity: 0; }
    .is-dark #room-darkness { opacity: 1; }

    /* === ğŸ‘» íˆ¬ëª… í´ë¦­ ì¡´ (Invisible Click Zones) === */
    /* ì´ ë°•ìŠ¤ë“¤ì€ ëˆˆì— ë³´ì´ì§€ ì•Šì§€ë§Œ, ìŠ¤ì¼€ì¹˜ ì† ì‚¬ë¬¼ ìœ„ì¹˜ì— ë°°ì¹˜ë˜ì–´ í´ë¦­ì„ ê°ì§€í•©ë‹ˆë‹¤. */
    .click-zone {
        position: absolute;
        cursor: pointer;
        z-index: 100; /* ë‹¤ë¥¸ ìš”ì†Œë³´ë‹¤ ìœ„ì— ìˆì–´ì•¼ í´ë¦­ë¨ */
        /* background: rgba(255, 0, 0, 0.2); /* í…ŒìŠ¤íŠ¸ìš©: ìœ„ì¹˜ í™•ì¸í•  ë•Œ ì£¼ì„ í•´ì œ */
    }

    /* ê° ì‚¬ë¬¼ì˜ ìœ„ì¹˜ (ìŠ¤ì¼€ì¹˜ ê¸°ì¤€ ëŒ€ëµì  ìœ„ì¹˜ - í•„ìš” ì‹œ % ì¡°ì •) */
    #zone-light { top: 0; left: 45%; width: 15%; height: 15%; } /* ì „ë“± */
    #zone-window { top: 15%; right: 8%; width: 28%; height: 45%; } /* ì°½ë¬¸ */
    #zone-character { bottom: 30%; left: 40%; width: 15%; height: 35%; } /* ìºë¦­í„° */
    #zone-bed { bottom: 5%; left: 5%; width: 40%; height: 35%; transform: rotate(-5deg); } /* ì¹¨ëŒ€ */
    #zone-pot1 { bottom: 20%; left: 33%; width: 12%; height: 15%; } /* ì¤‘ì•™ í™”ë¶„ */
    #zone-pot2 { bottom: 45%; left: 20%; width: 10%; height: 12%; } /* ë’¤ìª½ í™”ë¶„ */

    /* ê¹Œë§ˆê·€ëŠ” ì›€ì§ì—¬ì•¼ í•˜ë¯€ë¡œ ë³„ë„ ì²˜ë¦¬ */
    #crow-container { position: absolute; top: 22%; left: 25%; width: 30%; height: 50px; z-index: 110; display: flex; gap: 20px; }
    .crow { font-size: 24px; cursor: pointer; transition: 1s; filter: drop-shadow(2px 2px 0 #000); }
    .crow.fly { transform: translate(500px, -500px) scale(2); opacity: 0; pointer-events: none; }


    /* =========================================
       ğŸ¥‘ íŒì—…ì°½ ë””ìì¸ (ê¹”ë”í•œ í™”ì´íŠ¸ í†¤)
       ========================================= */
    .cute-popup { position: absolute; display: none; background: #fff; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden; width: 500px; color: #333; z-index: 2000; border: 1px solid #eee; }
    .cute-titlebar { background: #fff; color: #666; padding: 15px; font-size: 13px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; cursor: grab; border-bottom: 1px solid #f0f0f0;}
    .cute-body { padding: 25px; max-height: 65vh; overflow-y: auto; background: #fafafa;}
    .close-x { cursor: pointer; color: #bbb; font-size: 16px; transition: 0.2s; } .close-x:hover { color: #d81b60; }
    .btn-action { background: #fff; color: #555; border: 1px solid #ddd; border-radius: 20px; padding: 8px 18px; font-family: 'Galmuri9'; font-size: 12px; cursor: pointer; transition: 0.2s; }
    .btn-action:hover { background: #fff0f5; color: #d81b60; border-color: #f8bbd0; }
    .cute-input { width: 100%; padding: 12px; margin-bottom: 15px; background: #fff; border: 1px solid #e5e5e5; border-radius: 8px; color: #333; font-family: 'Galmuri9'; box-sizing: border-box; outline: none; }
    
    /* ê²Œì‹œíŒ ìŠ¤íƒ€ì¼ */
    .post-item { margin-bottom: 15px; background: #fff; border-radius: 8px; border: 1px solid #eee; padding: 15px; }
    .post-header { font-weight: bold; cursor: pointer; display: flex; justify-content: space-between; color: #d81b60; }
    .post-content-area { display: none; padding-top: 15px; margin-top: 10px; border-top: 1px dashed #eee; font-size: 13px; line-height: 1.6; }
  </style>
</head>
<body>

  <div id="world-container">
      <div id="view-room" class="world-view active">
          <div id="room-darkness"></div>

          <div id="zone-light" class="click-zone" onclick="toggleLight()" title="ì „ë“± ìŠ¤ìœ„ì¹˜"></div>
          <div id="zone-window" class="click-zone" onclick="alert('ì°½ë¬¸ ë°–ì€... ì•„ì§ ì•Œ ìˆ˜ ì—†ë‹¤...')" title="ì°½ë¬¸"></div>
          <div id="zone-character" class="click-zone" onclick="alert('... (ê·¸ë¦¼ìê°€ ì¼ë ì¸ë‹¤)')" title="ìºë¦­í„°"></div>
          <div id="zone-bed" class="click-zone" onclick="openBoard('diary')" title="ë¹„ë°€ ì¼ê¸°ì¥ ì—´ê¸°"></div>
          
          <div id="zone-pot1" class="click-zone" onclick="breakEffect(this)" title="í™”ë¶„"></div>
          <div id="zone-pot2" class="click-zone" onclick="breakEffect(this)" title="í™”ë¶„"></div>

          <div id="crow-container">
              <div class="crow" onclick="flyCrow(this)">ğŸ¦â€â¬›</div>
              <div class="crow" onclick="flyCrow(this)">ğŸ¦â€â¬›</div>
          </div>

          <button class="btn-action" style="position:absolute; bottom:20px; right:20px; z-index: 150; box-shadow: 0 4px 10px rgba(0,0,0,0.1);" onclick="openPopup('profile-window')">âš™ï¸ ë°°ê²½ ì„¤ì • (ìŠ¤ì¼€ì¹˜ ì ìš©)</button>
      </div>
  </div>

  <div id="left-taskbar">
      <div class="task-icon"><div>ğŸ </div>Room</div>
  </div>

  <div id="board-window" class="cute-popup" style="width: 550px; left: 150px; top: 100px;">
      <div class="cute-titlebar">
          <span id="board-title">ë¹„ë°€ ì¼ê¸°ì¥</span>
          <div style="display:flex; gap:10px;">
              <button class="btn-action" onclick="openWrite()">ê¸€ì“°ê¸°</button>
              <span class="close-x" onclick="closePopup('board-window')">âœ–</span>
          </div>
      </div>
      <div class="cute-body" id="page-content">ë¡œë”© ì¤‘...</div>
  </div>

  <div id="write-window" class="cute-popup" style="width: 550px; left: 200px; top: 80px;">
      <div class="cute-titlebar"><span>ìƒˆ ê¸€ ì‘ì„±</span><span class="close-x" onclick="closePopup('write-window')">âœ–</span></div>
      <div class="cute-body">
          <select id="post-category" class="cute-input" style="width:150px;">
              <option value="diary">ë¹„ë°€ ì¼ê¸°</option>
              <option value="guestbook">ë°©ëª…ë¡</option>
          </select>
          <input type="text" id="post-title" class="cute-input" placeholder="ì œëª©...">
          
          <div style="padding:15px; border:1px dashed #ccc; border-radius:8px; margin-bottom:15px; text-align:center; background:#f9f9f9;">
              <span style="font-size:12px; color:#888;">ğŸ“¼ ì˜ìƒ ì²¨ë¶€ (Supabase Storage)</span><br>
              <input type="file" id="video-file" accept="video/*" style="font-size:11px; margin-top:5px;">
              <button class="btn-action" id="btn-vid-upload" onclick="uploadVideoToSupabase()">ë³¸ë¬¸ì— ì‚½ì…</button>
          </div>

          <textarea id="post-content"></textarea>
          <div style="text-align:right; margin-top:20px;"><button class="btn-action" onclick="savePost()">ì €ì¥í•˜ê¸°</button></div>
      </div>
  </div>

  <div id="profile-window" class="cute-popup" style="width: 400px; right: 50px; top: 50px;">
      <div class="cute-titlebar"><span>ì„¤ì •</span><span class="close-x" onclick="closePopup('profile-window')">âœ–</span></div>
      <div class="cute-body">
          <p style="font-size:13px; color:#d81b60; text-align:center; font-weight:bold;">â€» ê·¸ë¦¬ì‹  ìŠ¤ì¼€ì¹˜ íŒŒì¼ì„ ë°°ê²½ìœ¼ë¡œ ë“±ë¡í•˜ì„¸ìš”!</p>
          <div style="margin-top:20px; text-align:center;">
              <span style="font-size:12px; color:#555; display:block; margin-bottom:10px;">ğŸ–¼ï¸ ë°© ë°°ê²½ ì´ë¯¸ì§€ ì„ íƒ</span>
              <input type="file" accept="image/*" class="cute-input" onchange="handleImageUpload(event)">
          </div>
          <div style="text-align:center; margin-top:20px;"><button class="btn-action" onclick="resetImage()">ì´ˆê¸°í™”</button></div>
      </div>
  </div>

  <script>
    let highestZ = 3000;
    
    // ìˆ˜íŒŒë² ì´ìŠ¤ ì—°ê²°
    const SB_URL = "https://kzgbqpodvpuoqovfsyrm.supabase.co";
    const SB_KEY = "sb_publishable_pdqE1Sc-4PSv3LQM9IsBcA_xJWeZwW-";
    let sb = window.supabase ? window.supabase.createClient(SB_URL, SB_KEY) : null;
    
    CKEDITOR.replace('post-content', { height: 200, language: 'ko', toolbarCanCollapse: true });

    // ğŸªŸ íŒì—… ì œì–´
    function openPopup(id) { const el = document.getElementById(id); el.style.display = 'block'; el.style.zIndex = ++highestZ; }
    function closePopup(id) { document.getElementById(id).style.display = 'none'; }
    
    // ë“œë˜ê·¸ ê¸°ëŠ¥
    function makeDraggable(winId) { 
        const win = document.getElementById(winId); const dragArea = win.querySelector('.cute-titlebar');
        let p1=0, p2=0, p3=0, p4=0; win.onmousedown = () => win.style.zIndex = ++highestZ; 
        dragArea.onmousedown = (e) => { e.preventDefault(); p3=e.clientX; p4=e.clientY; document.onmouseup = () => { document.onmouseup=null; document.onmousemove=null; }; document.onmousemove = (e) => { e.preventDefault(); p1=p3-e.clientX; p2=p4-e.clientY; p3=e.clientX; p4=e.clientY; win.style.top=(win.offsetTop-p2)+"px"; win.style.left=(win.offsetLeft-p1)+"px"; }; }; 
    }
    ['profile-window', 'board-window', 'write-window'].forEach(makeDraggable);

    // === ğŸ  ë°© ì•ˆì˜ ìƒí˜¸ì‘ìš© ===
    function toggleLight() { document.getElementById('view-room').classList.toggle('is-dark'); }
    function flyCrow(el) { el.classList.add('fly'); setTimeout(() => el.classList.remove('fly'), 5000); }
    function breakEffect(el) {
        // í™”ë¶„ í´ë¦­ ì‹œ ê°„ë‹¨í•œ ì‹œê° íš¨ê³¼ (í‘!)
        const boom = document.createElement('div');
        boom.innerText = 'ğŸ’¥'; boom.style.position='absolute'; boom.style.left=el.style.left; boom.style.top=el.style.top; boom.style.fontSize='40px'; boom.style.zIndex='120'; boom.style.pointerEvents='none';
        el.parentNode.appendChild(boom);
        setTimeout(() => boom.remove(), 1000);
    }

    // === ğŸ–¼ï¸ ë°°ê²½ ì´ë¯¸ì§€ ì €ì¥/ë¡œë“œ ===
    function handleImageUpload(event) {
        const file = event.target.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            localStorage.setItem('myRoomBg', e.target.result);
            applyBg();
        };
        reader.readAsDataURL(file);
    }
    function applyBg() {
        const bg = localStorage.getItem('myRoomBg');
        if(bg) document.getElementById('view-room').style.backgroundImage = `url(${bg})`;
    }
    function resetImage() { localStorage.removeItem('myRoomBg'); location.reload(); }

    // === ğŸ“ ê²Œì‹œíŒ/ê¸€ì“°ê¸° (ìˆ˜íŒŒë² ì´ìŠ¤) ===
    async function openBoard(type) {
        document.getElementById('board-title').innerText = type === 'diary' ? 'ë¹„ë°€ ì¼ê¸°ì¥' : 'ë°©ëª…ë¡';
        const content = document.getElementById('page-content');
        content.innerHTML = 'ë¡œë”© ì¤‘...'; openPopup('board-window');
        if(!sb) return content.innerHTML = 'DB ì—°ê²° ì‹¤íŒ¨';
        
        const { data, error } = await sb.from('posts').select('*').eq('category', type).order('created_at', {ascending:false});
        if(error || !data || data.length === 0) return content.innerHTML = 'ì‘ì„±ëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.';

        content.innerHTML = data.map(p => `
            <div class="post-item">
                <div class="post-header" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'block' ? 'none' : 'block'">
                    <span>ğŸ“„ ${p.title}</span>
                    <small>${new Date(p.created_at).toLocaleDateString()}</small>
                </div>
                <div class="post-content-area">${p.content}</div>
            </div>
        `).join('');
    }

    async function savePost() {
        if(!sb) return alert('DB ì—°ê²° ì‹¤íŒ¨');
        const title = document.getElementById('post-title').value;
        const content = CKEDITOR.instances['post-content'].getData();
        const category = document.getElementById('post-category').value;
        if(!title.trim()) return alert('ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.');
        
        await sb.from('posts').insert([{ title, content, category }]);
        closePopup('write-window'); openBoard(category);
    }

    async function uploadVideoToSupabase() {
        const file = document.getElementById('video-file').files[0];
        if(!file || !sb) return alert('íŒŒì¼ ì„ íƒ ë˜ëŠ” DB ì—°ê²° í™•ì¸ í•„ìš”');
        const btn = document.getElementById('btn-vid-upload'); btn.innerText = 'ì—…ë¡œë“œ ì¤‘...'; btn.disabled = true;

        const fileName = Date.now() + '_' + file.name;
        const { error } = await sb.storage.from('videos').upload(fileName, file);
        if(error) { alert('ì—…ë¡œë“œ ì‹¤íŒ¨ (videos ë²„í‚· í™•ì¸ í•„ìš”)'); btn.innerText='ë³¸ë¬¸ì— ì‚½ì…'; btn.disabled=false; return; }
        
        const { data } = sb.storage.from('videos').getPublicUrl(fileName);
        CKEDITOR.instances['post-content'].insertHtml(`<p style="text-align:center;"><video src="${data.publicUrl}" controls style="max-width:100%; border-radius:8px;"></video></p><p><br></p>`);
        btn.innerText = 'ì™„ë£Œ!'; setTimeout(()=>{ btn.innerText='ë³¸ë¬¸ì— ì‚½ì…'; btn.disabled=false; }, 2000);
    }

    window.onload = applyBg;
  </script>
</body>
</html>
